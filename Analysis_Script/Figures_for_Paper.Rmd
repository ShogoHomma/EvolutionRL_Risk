---
title: "Figures for Paper"
author: "Shogo Homma"
date: "`r format(Sys.time(), '%Y/%m/%d')`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 2
    theme: spacelab
    highlight: haddock
    fig_caption: yes
    fig_width: 9
    fig_height: 8
    self_contained: true
    css: mystyle.css
    md_extensions: -ascii_identifiers
---


a# セットアップ

```{r, load-library}
library(tidyverse)
library(here)
library(data.table)
#library(GGally)
library(ggrepel)
library(patchwork)
```


```{r}
# 画像の保存先のパスを設定
output_path <- here("Output", "FiguresForPaper")
simout_SameExp_path <- here("Data", "SameExp_Sim_RandMultiTask")
```


```{r setup knit_environment, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, comment="", warning=FALSE, message=FALSE, fig.align="center", cache=F)
```


## 関数の読み込み

```{r}
common_functions_path <- here("Analysis_Script", "_functions_common")
common_functions <- here(common_functions_path, dir(common_functions_path))
purrr::walk(common_functions, ~source(.x))

project_functions_path <- here("Analysis_Script", "_functions_project")
project_functions <- here(project_functions_path, dir(project_functions_path))
purrr::walk(project_functions, ~source(.x))
```


## データの取得

### 単一課題のデータ

```{r}
## 世代平均の情報についてのデータ

pattern_name_30_5 <- c(
  "_20191214183504", "_20191214183505", "_20191214183506", "_20191214183507", "_20191214183508",
  "_20191216111051", "_20191216111052", "_20191216111053", "_20191216111054", "_20191216111055",
  "_20191217145232", "_20191217145233", "_20191217145234", "_20191217145235", "_20191217145236",
  "_20191218152742", "_20191218152743", "_20191218152744", "_20191218152745", "_20191218152746")

sim_name_30_5 <- c(
  "30.5.50.30", "30.5.50.25", "30.5.50.20", "30.5.50.15", "30.5.50.10", 
  "30.5.40.30", "30.5.40.25", "30.5.40.20", "30.5.40.15", "30.5.40.10", 
  "30.5.20.30", "30.5.20.25", "30.5.20.20", "30.5.20.15", "30.5.20.10", 
  "30.5.10.30", "30.5.10.25", "30.5.10.20", "30.5.10.15", "30.5.10.10")

pattern_name_20_5 <- c(
  "_20191119144338", "_20191118142201", "_20190916204328", "_20191118142145", "_20191118142115",
  "_20191223104741", "_20191223104742", "_20191223104743", "_20191223104744", "_20191223104745",
  "_20200110152317", "_20200110152318", "_20200110152319", "_20200110152320", "_20200110152321",
  "_20191219134742", "_20191224122806", "_20190916204119", "_20191224122807", "_20191220110720")

sim_name_20_5 <- c(
  "20.5.40.30", "20.5.40.25", "20.5.40.20", "20.5.40.15", "20.5.40.10",
  "20.5.30.30", "20.5.30.25", "20.5.30.20", "20.5.30.15", "20.5.30.10", 
  "20.5.10.30", "20.5.10.25", "20.5.10.20", "20.5.10.15", "20.5.10.10",
  "20.5.0.30", "20.5.0.25", "20.5.0.20", "20.5.0.15", "20.5.0.10")

pattern_name_10_5 <- c(
  "_20191225105829", "_20191225105830", "_20191225105831", "_20191225105832", "_20191226115412",
  "_20200111161131", "_20200111161132", "_20200111161133", "_20200111161134", "_20200111161135", 
  "_20200113142323", "_20200113142324", "_20200113142325", "_20200113142326", "_20200113142327",
  "_20191226115336", "_20191226115337", "_20191226115338", "_20191226115339", "_20191227142311")

sim_name_10_5 <- c(
  "10.5.30.30", "10.5.30.25", "10.5.30.20", "10.5.30.15", "10.5.30.10",
  "10.5.20.30", "10.5.20.25", "10.5.20.20", "10.5.20.15", "10.5.20.10",
  "10.5.0.30", "10.5.0.25", "10.5.0.20", "10.5.0.15", "10.5.0.10",
  "10.5.-10.30", "10.5.-10.25", "10.5.-10.20", "10.5.-10.15", "10.5.-10.10")

pattern_name_0_5 <- c(
  "_20191121180423", "_20191121180252", "_20190916204538", "_20191121180225", "_20191121180208",
  "_20200114122539", "_20200114122540", "_20200114122541", "_20200114122542", "_20200114122543",
  "_20200115150219", "_20200115150220", "_20200115150221", "_20200115150222", "_20200115150223", 
  "_20191224123053", "_20191224123054", "_20190916204210", "_20191224123055", "_20191225105953")

sim_name_0_5 <- c(
  "0.5.20.30", "0.5.20.25", "0.5.20.20", "0.5.20.15", "0.5.20.10",
  "0.5.10.30", "0.5.10.25", "0.5.10.20", "0.5.10.15", "0.5.10.10",
  "0.5.-10.30", "0.5.-10.25", "0.5.-10.20", "0.5.-10.15", "0.5.-10.10",
  "0.5.-20.30", "0.5.-20.25", "0.5.-20.20", "0.5.-20.15", "0.5.-20.10")

pattern_name_minus10_5 <- c(
  "_20191227142546", "_20191227142547", "_20191227142548", "_20191227142549", "_20191228112810",
  "_20200116170128", "_20200116170129", "_20200116170130", "_20200116170131", "_20200116170132",
  "_20200118155206", "_20200118155207", "_20200118155208", "_20200118155209", "_20200118155210",
  "_20191228112846", "_20191228112847", "_20191228112848", "_20191228112849", "_20191228184927")

sim_name_minus10_5 <- c(
  "-10.5.10.30", "-10.5.10.25", "-10.5.10.20", "-10.5.10.15", "-10.5.10.10",
  "-10.5.0.30", "-10.5.0.25", "-10.5.0.20", "-10.5.0.15", "-10.5.0.10",
  "-10.5.-20.30", "-10.5.-20.25", "-10.5.-20.20", "-10.5.-20.15", "-10.5.-20.10",
  "-10.5.-30.30", "-10.5.-30.25", "-10.5.-30.20", "-10.5.-30.15", "-10.5.-30.10")

pattern_name_minus20_5 <- c(
  "_20191219130414", "_20191219130415", "_20190916204750", "_20191219130416", "_20191219130417",
  "_20191221121729", "_20191221121730", "_20191221121731", "_20191221121732", "_20191221121733",
  "_20191222102255", "_20191222102256", "_20191222102257", "_20191222102258", "_20191222102259",
  "_20191220110603", "_20191220110604", "_20191114220026", "_20191220110605", "_20191220110606")

sim_name_minus20_5 <- c(
  "-20.5.0.30", "-20.5.0.25", "-20.5.0.20", "-20.5.0.15", "-20.5.0.10",
  "-20.5.-10.30", "-20.5.-10.25", "-20.5.-10.20", "-20.5.-10.15", "-20.5.-10.10",
  "-20.5.-30.30", "-20.5.-30.25", "-20.5.-30.20", "-20.5.-30.15", "-20.5.-30.10",
  "-20.5.-40.30", "-20.5.-40.25", "-20.5.-40.20", "-20.5.-40.15", "-20.5.-40.10")

pattern_name_minus30_5 <- c(
  "_20191229191133", "_20191229191134", "_20191229191135", "_20191229191136", "_20191229191137",
  "_20220104104342", "_20220104104343", "_20220104104344", "_20220104104345", "_20220104104346", 
  "_20220322151600", "_20220322151601", "_20220322151602", "_20220323153501", "_20220323153502", 
  "_20211230173101", "_20211230173102", "_20211230173103", "_20211230173104", "_20211230173105")

sim_name_minus30_5 <- c(
  "-30.5.-10.30", "-30.5.-10.25", "-30.5.-10.20", "-30.5.-10.15", "-30.5.-10.10",
  "-30.5.-20.30", "-30.5.-20.25", "-30.5.-20.20", "-30.5.-20.15", "-30.5.-20.10",
  "-30.5.-40.30", "-30.5.-40.25", "-30.5.-40.20", "-30.5.-40.15", "-30.5.-40.10",
  "-30.5.-50.30", "-30.5.-50.25", "-30.5.-50.20", "-30.5.-50.15", "-30.5.-50.10")

```


```{r}
# 以上を一つのリストにまとめる

params <- list(
  pattern_name = c(pattern_name_30_5, pattern_name_20_5, pattern_name_10_5, pattern_name_0_5, pattern_name_minus10_5, pattern_name_minus20_5, pattern_name_minus30_5),
  sim_name = c(sim_name_30_5, sim_name_20_5, sim_name_10_5, sim_name_0_5, sim_name_minus10_5, sim_name_minus20_5, sim_name_minus30_5)
  )

# 世代情報のdfを作成
DataDir <- "Data"
DataDir_sub <- "Evo_Sim_SingleTask"

df_gene <- purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_gene.csv"))
df_gene_longer <- ConvertDfGeneLonger_MeanSD(df_gene)

discrim <- unique(df_gene_longer$discriminability)
```


```{r}
# GeneAverageのデータだけ集める

params <- list(
  pattern_name = c(pattern_name_30_5, pattern_name_20_5, pattern_name_10_5, pattern_name_0_5, pattern_name_minus10_5, pattern_name_minus20_5, pattern_name_minus30_5),
  sim_name = c(sim_name_30_5, sim_name_20_5, sim_name_10_5, sim_name_0_5, sim_name_minus10_5, sim_name_minus20_5, sim_name_minus30_5)
  )

# dfを作成
DataDir <- "Data"
DataDir_sub <- "Evo_Sim_SingleTask"

df_gene_riskaversion <- 
  purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "GeneAverage_"))

df_gene_riskaversion_mean <- 
  df_gene_riskaversion %>% 
  dplyr::group_by(sim, generation) %>% 
  dplyr::summarise(
    mean_choice1 = mean(MEAN_rate_choice1),
    sd_choice1 = mean(SD_rate_choice1)
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    mean_risk_aversion = 1 - mean_choice1
  ) %>% # 以下、選択肢の効果量についての処理をする
  tidyr::separate(col = "sim", into = c("m2", "sd2", "m1", "sd1"), sep = "\\.", remove = FALSE) %>% 
  dplyr::mutate(
    m1 = as.integer(m1),
    sd1 = as.integer(sd1),
    m2 = as.integer(m2),
    sd2 = as.integer(sd2)
  ) %>% 
  dplyr::mutate(
    discriminability = EffectSize(m1, sd1, m2, sd2),
    task_exp = paste(m1, " vs ", m2, sep = "")
  ) %>% 
  dplyr::arrange(desc(discriminability))

```


```{r}
# 上記のベクトルを削除
rm(list = ls()[stringr::str_starts(string = ls(), pattern = "pattern_name")])
rm(list = ls()[stringr::str_starts(string = ls(), pattern = "sim_name")])
```


### 単一課題（1世代内データ）を集める

```{r}
# 世代内データを集める（ヒートマップ作成のため）

pattern_name_30_5 <- c(
  "_20201227183815", "_20201227191810", "_20201227191811", "_20201227191812", "_20201227191813",
  "_20201227183031", "_20201227183152", "_20201227183354", "_20201227183600", "_20201227183713"
  )

sim_name_30_5 <- c(
  "30.5.50.30", "30.5.50.25", "30.5.50.20", "30.5.50.15", "30.5.50.10",
  "30.5.10.30", "30.5.10.25", "30.5.10.20", "30.5.10.15", "30.5.10.10")

pattern_name_20_5 <- c(
  "_20191229145232", "_20191229145233", "_20191023105942", "_20191229145234", "_20191229145235",
  "_20191229152907", "_20191229152908", "_20191023145842", "_20191229152909", "_20191229152910"
  )

sim_name_20_5 <- c(
  "20.5.40.30", "20.5.40.25", "20.5.40.20", "20.5.40.15", "20.5.40.10",
  "20.5.0.30", "20.5.0.25", "20.5.0.20", "20.5.0.15", "20.5.0.10")

pattern_name_10_5 <- c(
  "_20200108205820", "_20200108205821", "_20200108205822", "_20200108205823", "_20200108205824",
  "_20200109143326", "_20200109143327", "_20200109143328", "_20200109143329", "_20200109143330"
  )

sim_name_10_5 <- c(
  "10.5.30.30", "10.5.30.25", "10.5.30.20", "10.5.30.15", "10.5.30.10",
  "10.5.-10.30", "10.5.-10.25", "10.5.-10.20", "10.5.-10.15", "10.5.-10.10")

pattern_name_0_5 <- c(
  "_20191229161041", "_20191229161042", "_20191023141508", "_20191229161043", "_20191229161044",
  "_20191229164648", "_20191229164649", "_20191023145854", "_20191229164650", "_20191229164651"
  )

sim_name_0_5 <- c(
  "0.5.20.30", "0.5.20.25", "0.5.20.20", "0.5.20.15", "0.5.20.10",
  "0.5.-20.30", "0.5.-20.25", "0.5.-20.20", "0.5.-20.15", "0.5.-20.10")

pattern_name_minus10_5 <- c(
  "_20200109152359", "_20200109152360", "_20200109152361", "_20200109152362", "_20200109152363",
  "_20200109161034", "_20200109161035", "_20200109161036", "_20200109161037", "_20200109161038"
  )

sim_name_minus10_5 <- c(
  "-10.5.10.30", "-10.5.10.25", "-10.5.10.20", "-10.5.10.15", "-10.5.10.10",
  "-10.5.-30.30", "-10.5.-30.25", "-10.5.-30.20", "-10.5.-30.15", "-10.5.-30.10")

pattern_name_minus20_5 <- c(
  "_20191229172653", "_20191229172654", "_20191023141626", "_20191229172655", "_20191229172656",
  "_20191229181936", "_20191229181937", "_20191229181938", "_20191229181939", "_20191229181940"
  )

sim_name_minus20_5 <- c(
  "-20.5.0.30", "-20.5.0.25", "-20.5.0.20", "-20.5.0.15", "-20.5.0.10",
  "-20.5.-40.30", "-20.5.-40.25", "-20.5.-40.20", "-20.5.-40.15", "-20.5.-40.10")

pattern_name_minus30_5 <- c(
  "_20201227192101", "_20201227192253", "_20201227195149", "_20201227195150", "_20201227195151",
  "_20220323182716", "_20220323182717", "_20220323182718", "_20220323182719", "_20220323182720"
  )

sim_name_minus30_5 <- c(
  "-30.5.-10.30", "-30.5.-10.25", "-30.5.-10.20", "-30.5.-10.15", "-30.5.-10.10",
  "-30.5.-50.30", "-30.5.-50.25", "-30.5.-50.20", "-30.5.-50.15", "-30.5.-50.10"
  )

# 以上を一つのリストにまとめる

params <- list(
  pattern_name = c(pattern_name_30_5, pattern_name_20_5, pattern_name_10_5, pattern_name_0_5, pattern_name_minus10_5, pattern_name_minus20_5, pattern_name_minus30_5),
  sim_name = c(sim_name_30_5, sim_name_20_5, sim_name_10_5, sim_name_0_5, sim_name_minus10_5, sim_name_minus20_5, sim_name_minus30_5)
  )

# 上記のベクトルを削除
rm(list = ls()[stringr::str_starts(string = ls(), pattern = "pattern_name")])
rm(list = ls()[stringr::str_starts(string = ls(), pattern = "sim_name")])

# dfを作成
DataDir <- "Data"
DataDir_sub <- "WithinGeneration_Sim_SingleTask"

df_withingene <- purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDfWithinGene(.x, .y, DataDir, DataDir_sub, "_nat.csv"))
```


### ランダム複数課題シミュレーション


```{r}
# taskinfo系のdataframeを作成

pattern_name <- c("_20220905162206", "_20220909161625", "_20220919103516", "_20220921105827", "_20220923105509")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

params <- list(
  pattern_name = pattern_name,
  sim_name = sim_name
)

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"


df_randmulti_taskinfo <- 
  purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_task.csv")) %>% 
  dplyr::mutate(
    area_rate = (pnorm(0, m1, sd1) + pnorm(0, m2, sd2))/2,
    eff_size = EffectSize(m1, sd1, m2, sd2)
    ) %>% 
  dplyr::mutate(
    posi_nega = case_when(
      (m1 > 0) & (m2 > 0) ~ "posi",
      (m1 < 0) & (m2 < 0) ~ "nega",
      TRUE ~ "other"
    ),
    task_type = case_when(
      m1 > m2 ~ "risk_seeking",
      m2 > m1 ~ "risk_aversion"
    ),
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
    )

df_randmulti_taskgroup <- 
  purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_taskgroup.csv")) %>% 
  dplyr::mutate(area_rate = (pnorm(0, m1, sd1) + pnorm(0, m2, sd2))/2) %>% 
  dplyr::mutate(
    posi_nega = case_when(
      (m1 > 0) & (m2 > 0) ~ "posi",
      (m1 < 0) & (m2 < 0) ~ "nega",
      TRUE ~ "other"
    ),
    task_type = case_when(
      m1 > m2 ~ "risk_seeking",
      m2 > m1 ~ "risk_aversion"
    ),
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
    )

# 各課題の平均的な効果量と負の領域量を計算
df_randmulti_taskinfo %>% 
  dplyr::group_by(sim, sim_i) %>% 
  dplyr::summarise(
    mean_eff_size = mean(eff_size),
    mean_area_rate = mean(area_rate)
  ) %>% 
  dplyr::ungroup() ->
  df_randmulti_mean_taskinfo
```


```{r}
# _gene.csv

pattern_name <- c("_20220905162206", "_20220909161625", "_20220919103516", "_20220921105827", "_20220923105509")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

params <- list(
  pattern_name = pattern_name,
  sim_name = sim_name
)

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"

df_gene_randmulti <- purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_gene.csv"))

df_gene_randmulti %>% 
  dplyr::group_by(sim, generation) %>% 
  dplyr::summarise(
    MEAN_ap = mean(mean_ap),
    MEAN_an = mean(mean_an),
    MEAN_bt = mean(mean_bt)
  ) %>% 
  dplyr::ungroup() -> 
  df_gene_randmulti_summary


# 課題情報と遺伝子のdfと結合
df_gene_randmulti %>% 
  dplyr::filter(generation == 2999) %>% 
  dplyr::full_join(df_randmulti_mean_taskinfo, by = c("sim", "sim_i")) ->
  df_gene_randmulti_taskinfo


# 全体のまとめで使用するdfを作成
df_gene_randmulti %>% 
  dplyr::group_by(sim, generation) %>% 
  dplyr::summarise(
    MEAN_ap = mean(mean_ap),
    MEAN_an = mean(mean_an),
    MEAN_bt = mean(mean_bt)
  ) %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_longer(cols = -c(sim, generation), names_to = c("stat", "para"), names_sep = "_") %>% 
  tidyr::pivot_wider(names_from = stat, values_from = value) -> 
  df_gene_randmulti_summary_longer

df_gene_randmulti %>% 
  tidyr::pivot_longer(cols = -c(sim, sim_i, generation), names_to = c("stat", "para"), names_sep = "_") %>% 
  tidyr::pivot_wider(names_from = stat, values_from = value) ->
  df_gene_randmulti_longer

df_gene_randmulti_longer %>% 
  dplyr::filter(generation == 2999) %>% 
  dplyr::full_join(df_randmulti_mean_taskinfo, by = c("sim", "sim_i")) ->
  df_gene_randmulti_taskinfo_longer
```


```{r, eval=FALSE}
# _nat.csvについて

# ------ 5種類のシミュレーション ------ #
# 時間がかかるので実行しない方がいい
# 下のRDSファイルの読み込みをした方がいい

pattern_name <- c("_20220905162206", "_20220909161625", "_20220919103516", "_20220921105827", "_20220923105509")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"

AgentN <- 1000
GeneN <- 3000
TaskN <- 4
Extract_SimN <- 100

#df_agent_randmulti <- purrr::map2_dfr(pattern_name, sim_name, ~MakeDfNat_Rand(.x, .y, DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN))

df_agent_randmulti %>%
  dplyr::group_by(sim, sim_i, task_i, generation) %>%
  dplyr::summarise(
    MEAN_payoff = mean(mean_payoff),
    SD_payoff = sqrt(variance(mean_payoff)),
    MEAN_rate_choice1 = mean(rate_choice1),
    SD_rate_choice1 = sqrt(variance(rate_choice1))
  ) %>% 
  dplyr::ungroup() %>%
  dplyr::mutate(
    mean_risk_aversion = 1 - MEAN_rate_choice1
  ) ->
  df_agent_randmulti_summary

#saveRDS(df_agent_randmulti_summary, file = here("Data", "Evo_RandMultiTask", "df_agent_randmulti_summary_rev.obj"))
```

  
- agentデータを読み込み


```{r}
#  ------ # _nat.csv：続き ------ #

df_agent_randmulti_summary_rev <- readRDS(here("Data", "Evo_RandMultiTask", "df_agent_randmulti_summary_rev.obj"))

# 課題情報と結合する
df_randmulti_taskinfo %>%
  dplyr::full_join(df_agent_randmulti_summary_rev, by = c("sim", "sim_i", "task_i")) ->
  df_agent_randmulti_summary

df_agent_randmulti_summary %>%
  dplyr::group_by(sim, generation, task_type) %>%
  dplyr::summarise(
    MEAN_risk_aversion = mean(mean_risk_aversion),
    SD_risk_aversion = sqrt(variance(mean_risk_aversion)),
    N = n()
  ) %>%
  dplyr::ungroup() %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) ->
  df_agent_randmulti_simMEAN
```


```{r, eval=FALSE}
# _trial.csv.gz 

# ------ 5種類のシミュレーション ------ #
# 時間がかかるので実行しない方がいい
# 下のRDSファイルの読み込みをした方がいい


pattern_name <- c("_20220905162206", "_20220909161625", "_20220919103516", "_20220921105827", "_20220923105509")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"

Extract_SimN <- 100

df_trial_randmulti_summary <- purrr::map2_dfr(pattern_name, sim_name, ~MakeDfTrial_Rand(.x, .y, DataDir, DataDir_sub, "_trial.csv.gz", Extract_SimN))

# 課題情報と結合する
df_randmulti_taskinfo %>%
  dplyr::full_join(df_trial_randmulti_summary, by = c("sim", "sim_i", "task_i")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) -> 
  df_trial_randmulti_summary

#saveRDS(df_trial_randmulti_summary, file = here("Data", "Evo_RandMultiTask", "df_trial_randmulti_summary.obj"))
```


```{r}
# _trial.csv.gz：続き ------ #

df_trial_randmulti_summary <- readRDS(here("Data", "Evo_RandMultiTask", "df_trial_randmulti_summary.obj"))

df_trial_randmulti_summary %>% 
  dplyr::group_by(sim_n, generation, trial, task_type) %>% # sim_i間の平均とSDを計算する
  dplyr::summarise(
    MEAN_risk_aversion = mean(mean_risk_aversion),
    SD_risk_aversion = sqrt(variance(mean_risk_aversion)) # sim_i間のSD
  ) -> 
df_trial_randmulti_simMEAN
```


### 期待値が同じ課題のデータ


```{r, eval=FALSE}
# _nat.csvについて

# ------ 5種類のシミュレーション ------ #
# 時間がかかるので実行しない方がいい
# 下のRDSファイルの読み込みをした方がいい

pattern_name <- c("_20220905162206", "_20220909161625", "_20220919103516", "_20220921105827", "_20220923105509")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"

AgentN <- 1000
GeneN <- 3000
TaskN <- 4
Extract_SimN <- 100


# df_agent_randmulti_FisrtLastGenePara <- purrr::map2_dfr(pattern_name, sim_name, ~MakeDfNat_Rand(.x, .y, DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)) %>%
#   dplyr::filter(task_i == 0) %>%  # 4つの課題は必要ないので1つだけ取り出す
#   dplyr::select(sim, sim_i, generation, agent, ap, an, bt)
# 
# saveRDS(df_agent_randmulti_FisrtLastGenePara, file = here(DataDir, DataDir_sub, "df_agent_randmulti_FirstLastGenePara.obj"))


# df_agent_randmulti %>%
#   dplyr::group_by(sim, sim_i, task_i, generation) %>%
#   dplyr::summarise(
#     MEAN_payoff = mean(mean_payoff),
#     SD_payoff = sqrt(variance(mean_payoff)),
#     MEAN_rate_choice1 = mean(rate_choice1),
#     SD_rate_choice1 = sqrt(variance(rate_choice1))
#   ) %>%
#   dplyr::mutate(
#     mean_risk_aversion = 1 - MEAN_rate_choice1
#   ) ->
#   df_agent_randmulti_summary
```


```{r, eval=FALSE}
# 第一世代・最終世代のパラメータ

df_agent_randmulti_FirstLastGenePara <- readRDS(here("Data", "Evo_RandMultiTask", "df_agent_randmulti_FirstLastGenePara.obj"))

trial_N <- 500
task_struct_list <- list(
  c(20, 20, 20, 5), 
  c(10, 20, 10, 5), 
  c(-10, 20, -10, 5), 
  c(-20, 20, -20, 5)
)


# 最終世代

df_agent_randmulti_Last <- df_agent_randmulti_FirstLastGenePara %>% 
  dplyr::filter(generation == 2999)

# res_ql_list <- purrr::map(task_struct_list, ~RunQL_dual(df_agent_randmulti_Last, .x, trial_N))
# 
# res_ql_list_choice <-
#   res_ql_list %>%
#   purrr::map("Choice")

# RDS保存
# saveRDS(object = res_ql_list_choice, file = here(simout_SameExp_path, "res_ql_list_choice_LastGene_500T.RDS"))
```


```{r}
# 最終世代
res_ql_list_choice_500T_last <- readRDS(file = here(simout_SameExp_path, "res_ql_list_choice_LastGene_500T.RDS"))

# 最初の世代
# res_ql_list_choice_500T_first <- readRDS(file = here(simout_SameExp_path, "res_ql_list_choice_FirstGene_500T.RDS"))

# 第一世代・最終世代のパラメータ
df_agent_randmulti_FirstLastGenePara <- readRDS(here("Data", "Evo_RandMultiTask", "df_agent_randmulti_FirstLastGenePara.obj"))

df_agent_randmulti_Last <-
  df_agent_randmulti_FirstLastGenePara %>% 
  dplyr::filter(generation == 2999)

# df_agent_randmulti_First <-
#   df_agent_randmulti_FirstLastGenePara %>% 
#   dplyr::filter(generation == 0)
```


```{r, eval=FALSE}
# 最後の100試行
# RDSファイルに保存済みなので実行しない方がいい

purrr::map(res_ql_list_choice_500T_last, 
           ~{.x %>% 
               tibble::as_tibble(.) %>% 
               dplyr::bind_cols(df_agent_randmulti_Last) %>% 
               tidyr::pivot_longer(
                 cols = starts_with("V"),
                 names_to = "trial",
                 names_prefix = "V",
                 values_to = "choice",
                 names_transform = list(trial = as.integer)
               ) %>% 
               dplyr::mutate(
                 choice = if_else(choice == 2, 0, 1)
               ) %>% 
               dplyr::filter(trial > 400) %>% # 最後の100試行だけ取り出す
               dplyr::group_by(sim, sim_i, agent, an, ap, bt) %>% # trialで平均をとる
               dplyr::summarise(
                 risk_aversion = 1 - mean(choice)
               ) %>% 
               dplyr::ungroup() %>% 
               dplyr::mutate(an_ap = (an - ap)/(an + ap))
               }) %>% 
  dplyr::bind_rows(.id = "task") %>% 
  dplyr::mutate(generation = 2999) ->
  df_choice_res_latter100_last


purrr::map(res_ql_list_choice_500T_first, 
           ~{.x %>% 
               tibble::as_tibble(.) %>% 
               dplyr::bind_cols(df_agent_randmulti_First) %>% 
               tidyr::pivot_longer(
                 cols = starts_with("V"),
                 names_to = "trial",
                 names_prefix = "V",
                 values_to = "choice",
                 names_transform = list(trial = as.integer)
               ) %>% 
               dplyr::mutate(
                 choice = if_else(choice == 2, 0, 1)
               ) %>% 
               dplyr::filter(trial > 400) %>% # 最後の100試行だけ取り出す
               dplyr::group_by(sim, sim_i, agent, an, ap, bt) %>% # trialで平均をとる
               dplyr::summarise(
                 risk_aversion = 1 - mean(choice)
               ) %>% 
               dplyr::ungroup() %>% 
               dplyr::mutate(an_ap = (an - ap)/(an + ap))
               }) %>% 
  dplyr::bind_rows(.id = "task") %>% 
  dplyr::mutate(generation = 0) ->
  df_choice_res_latter100_first


df_choice_res_latter100_last %>% 
  dplyr::bind_rows(df_choice_res_latter100_first) %>% 
  dplyr::mutate(task = as.integer(task)) %>% 
  dplyr::mutate(
    task_struct =
      case_when(
        task == 1 ~ "N(20, 20) vs N(20, 5) (Gain)",
        task == 2 ~ "N(10, 20) vs N(10, 5) (Gain)",
        task == 3 ~ "N(-10, 20) vs N(-10, 5) (Loss)",
        task == 4 ~ "N(-20, 20) vs N(-20, 5) (Loss)",
      ) %>% forcats::fct_reorder(., task),
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) ->
  df_choice_res_500T_latter100

#saveRDS(df_choice_res_500T_latter100, file = here(simout_SameExp_path, "df_choice_res_500T_lat.RDS"))
```


```{r}
# 500試行シミュレーションで、最後の100試行でヒストグラム
df_choice_res_500T_latter100 <- readRDS(file = here(simout_SameExp_path, "df_choice_res_500T_lat.RDS"))
```


```{r}
df_choice_res_500T_latter100 %>% 
  
  dplyr::filter(generation == 2999) %>% 
  
  dplyr::mutate(gain_loss = if_else(task == 1 | task == 2, "gain", "loss")) %>% 
  dplyr::group_by(sim_n, sim_i, agent, ap, an, bt, an_ap, gain_loss) %>% 
  dplyr::summarise(
    mean_risk_aversion = mean(risk_aversion)
  ) %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(id_cols = c(sim_n, sim_i, agent, ap, an, bt, an_ap), names_from = gain_loss, values_from = mean_risk_aversion) %>% 
  dplyr::mutate(
    risk_aver_gain_loss = gain - loss
  ) ->
  df_choice_gainloss_500T_latter100_last
```


# Fig.1a 単一：全シミュレーション リスク回避率


- 横軸: 課題の期待値、縦軸: 最終世代のリスク回避率の平均値(+SD)

```{r, eval = FALSE}
# リスク回避が適応的な課題
target_simexp <- c("-50 vs -30", "-40 vs -20", "-30 vs -10", "-20 vs 0", "-10 vs 10", "0 vs 20", "10 vs 30")

g <- VisFirstLastGene_RiskAversion(df_gene_riskaversion_mean, target_simexp, "Risk-aversion task", tag = "(a)")

ggsave(plot = g, filename = here(output_path, "Fig1a.1_FirstLastGene_RiskAversion_risk-aversion_inrow.png"), width = 20.0, height = 6.0, dpi = 400)
```

 
```{r, eval = FALSE}
# リスク追求が適応的な課題
target_simexp <- c("-10 vs -30", "0 vs -20", "10 vs -10", "20 vs 0", "30 vs 10", "40 vs 20", "50 vs 30")

g <- VisFirstLastGene_RiskAversion(df_gene_riskaversion_mean, target_simexp, "Risk-seeking task", tag = "    ", legend = FALSE)

ggsave(plot = g, filename = here(output_path, "Fig1a.2_FirstLastGene_RiskAversion_risk-seeking_inrow.png"), width = 20.0, height = 6.0, dpi = 400)
```


```{r}
# 論文に載せる情報
# リスク追求課題の第一世代の平均リスク回避率を表示する

target_simexp <- c("-10 vs -30", "0 vs -20", "10 vs -10", "20 vs 0", "30 vs 10", "40 vs 20", "50 vs 30")
df_gene_riskaversion_mean %>% 
  dplyr::filter(generation == 0) %>% 
  dplyr::filter(task_exp %in% target_simexp) %>% 
  dplyr::select(sim, mean_risk_aversion) %>% 
  dplyr::arrange(mean_risk_aversion)
```


# Fig.1b 単一：全シミュレーション 進化

- 横軸: 課題の期待値、縦軸: 最終世代の遺伝子の平均値（+SD）


```{r, eval = FALSE}
# リスク回避が適応的な課題
target_simexp <- c("-50 vs -30", "-40 vs -20", "-30 vs -10", "-20 vs 0", "-10 vs 10", "0 vs 20", "10 vs 30")

g <- VisLastGene_Para_RunMean(df_gene_longer, target_simexp, "alpha", "Risk-aversion task", tag = "(b)")

ggsave(plot = g, filename = here(output_path, "Fig1b.1_LastGene_apan_risk-aversion_inrow.png"), width = 20.0, height = 6.0, dpi = 400)
```


```{r, eval = FALSE}
# リスク追求が適応的な課題
target_simexp <- c("-10 vs -30", "0 vs -20", "10 vs -10", "20 vs 0", "30 vs 10", "40 vs 20", "50 vs 30")

g <- VisLastGene_Para_RunMean(df_gene_longer, target_simexp, "alpha", "Risk-seeking task", tag = "    ", legend = FALSE)

ggsave(plot = g, filename = here(output_path, "Fig1b.2_LastGene_apan_risk-seeking_inrow.png"), width = 20.0, height = 6.0, dpi = 400)
```


```{r}
# 論文に載せる数値 # anの最終世代の値

# リスク回避が適応的な課題
target_simexp <- c("-50 vs -30", "-40 vs -20", "-30 vs -10", "-20 vs 0", "-10 vs 10", "0 vs 20", "10 vs 30")

df_gene_longer %>% 
  dplyr::filter(para == "an") %>% 
  dplyr::filter(generation == 4999) %>% 
  dplyr::filter(task_exp %in% target_simexp) %>% 
  dplyr::select(sim, task_exp, sd1, mean_rate) %>% 
  dplyr::arrange(sd1) -> df_mean_rate

print(df_mean_rate)

df_mean_rate %>% 
  dplyr::pull(mean_rate) %>% 
  summary


# リスク追求が適応的な課題
target_simexp <- c("-10 vs -30", "0 vs -20", "10 vs -10", "20 vs 0", "30 vs 10", "40 vs 20", "50 vs 30")

df_gene_longer %>% 
  dplyr::filter(para == "an") %>% 
  dplyr::filter(generation == 4999) %>% 
  dplyr::filter(task_exp %in% target_simexp) %>% 
  dplyr::select(sim, task_exp, sd1, mean_rate) %>% 
  dplyr::arrange(sd1) -> df_mean_rate

print(df_mean_rate)

df_mean_rate %>% 
  dplyr::pull(mean_rate) %>% 
  summary

```


# Fig.2a ランダム複数：進化の結果

  
- 横軸: 世代、縦軸: 遺伝子の値（細い線は1つのシミュレーション）


```{r, eval = FALSE} 
df_gene_randmulti_summary_longer %>% 
  dplyr::filter(para %in% c("ap", "an")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = "),
    para_rev = case_when(
      para == "ap" ~ "alpha[p]",
      para == "an" ~ "alpha[n]"
    )
  ) -> 
  df_gene_randmulti_summary_longer_rev

df_gene_randmulti_longer %>% 
  dplyr::filter(para %in% c("ap", "an")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = "),
    para_rev = case_when(
      para == "ap" ~ "alpha[p]",
      para == "an" ~ "alpha[n]"
    )
  ) %>% 
  
  ggplot(aes(x = generation, y = mean)) + geom_line(aes(group = sim_i), size = 0.08) + 
  geom_line(data = df_gene_randmulti_summary_longer_rev, aes(x = generation, y = MEAN, color = para), size = 2.0) +
  my_theme2 + labs(x = 'Generation', y = 'Parameter value', 
                   tag = "(a)") + guides(color = "none") + 
  scale_color_manual(name = "", values = c("#1F78B4", "#FF7F00"), 
                     labels = c(expression(paste(alpha[n])), expression(paste(alpha[p])))) +  
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 15), 
    axis.title = element_text(size = 23, face = "bold"), 
    strip.text.x = element_text(size = 17),
    strip.text.y = element_text(angle = 0),
    plot.tag = element_text(size = 30)
  ) + 
  facet_grid(para_rev~sim_n, 
             labeller = labeller(para_rev = label_parsed)) + 
  coord_cartesian(ylim = c(0, 1.0)) ->
  g
  
ggsave(plot = g, filename = here(output_path, "Fig2a_Evo_RandMulti_apan.png"), width = 19.0, height = 7.5)
```


```{r}
# 補足：最終世代のalpha_nの範囲を表示する

df_gene_randmulti_summary_longer_rev %>% 
  dplyr::filter(para == "an") %>% 
  dplyr::filter(generation == 2999) -> a

print(a)

# リスク回避とリスク追求の混在条件をとりだし、平均値を求める
a %>% 
  dplyr::filter(sim %in% c("cond_1/3", "cond_2/2", "cond_3/1")) %>% 
  dplyr::pull(MEAN) %>% 
  mean(.)
```


```{r}
# 補足：最終世代にan > apであるようなシミュレーションの数をcountする

df_gene_randmulti %>% 
  dplyr::filter(generation == 2999) %>% 
  dplyr::mutate(
    positivity = if_else(mean_ap > mean_an, 1, 0)
  ) %>% 
  dplyr::group_by(sim) %>% 
  dplyr::summarise(
    positivity_count = sum(positivity),
    positivity_rate = positivity_count/100
  )
```



# Fig 2b ランダム複数：$\alpha_p$は負の領域の大きさで説明される


```{r}
df_gene_randmulti_taskinfo_longer %>% 
  dplyr::filter(para %in% c("ap")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) %>% 
  
  ggplot(aes(x = mean_area_rate, y = mean)) + geom_point() + geom_smooth(method = "lm") + 
  my_theme2 + facet_grid(.~sim_n) + 
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 15), 
    axis.title = element_text(size = 23, face = "bold"), 
    strip.text.x = element_text(size = 17),
    plot.tag = element_text(size = 30)
  ) + 
  labs(x = "Mean negative area rate", y = expression(alpha[p]), 
       tag = "(b)") -> g

ggsave(plot = g, filename = here(output_path, "Fig2b_Relation_RandMulti_ap_NegaArea.png"), width = 18.0, height = 6.0)
```


# Fig.2c ランダム複数：各条件でのリスク回避率


```{r, eval=FALSE, fig.width=20, fig.height=8}
df_agent_randmulti_simMEAN %>% 
  
  dplyr::mutate(
    generation = generation + 1,
    task_type_rev = if_else(task_type == "risk_aversion", "risk aversion", "risk seeking")
    ) %>% 
  
  ggplot(aes(x = as.factor(generation), y = MEAN_risk_aversion, color = task_type_rev, group = task_type_rev)) + 
  geom_linerange(aes(ymin = MEAN_risk_aversion - SD_risk_aversion, ymax = MEAN_risk_aversion + SD_risk_aversion), size = 1.5, position = position_dodge(width = 0.5)) + 
  geom_point(size = 3.0, stroke = 1.5, shape = 21, fill = "white", position = position_dodge(width = 0.5)) + 
  my_theme2 + 
  theme(axis.text.x = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        axis.title = element_text(size = 23, face = "bold"),
        strip.text.x = element_text(size = 17),
        legend.title = element_text(size = 16), #change legend title font size
        legend.text = element_text(size = 16),
        legend.background = element_rect(fill = "transparent"), 
        legend.key = element_rect(fill = "white"), 
        legend.position = c(1, 0.98), 
        legend.justification = c(1, 1),
        plot.tag = element_text(size = 30)
        ) + 
  scale_color_manual(values=c("deepskyblue", "tan3")) + 
  coord_cartesian(ylim = c(0, 1)) + 
  labs(x = "Generation", 
       y = "Rate of risk aversion",
       color = "Task",
       tag = "(c)") + 
  guides(fill = 'none') + 
  facet_wrap(~sim_n, ncol = 5) -> g
  
ggsave(plot = g, filename = here(output_path, "Fig2c_FirstLastGene_RiskAversion_RandMulti.png"), width = 18.0, height = 6.0, dpi = 400)
```


```{r}
# 論文に載せる数値

# リスク追求課題の第一世代での平均リスク回避率を表示する

df_agent_randmulti_simMEAN %>% 
  dplyr::filter(generation == 0) %>% 
  dplyr::filter(task_type == "risk_seeking") %>% 
  dplyr::select(sim, MEAN_risk_aversion) -> 
  x_simMEAN

print(x_simMEAN)

# 平均を表示
mean(x_simMEAN$MEAN_risk_aversion)

```


```{r}
# 論文に載せる数値

# パフォーマンスの改善を計算する

df_agent_randmulti_summary %>% 
  #dplyr::filter(sim %in% c("cond_2/2", "cond_1/3", "cond_3/1")) %>% 
  tidyr::pivot_wider(id_cols = c(sim, sim_i, task_i, task_number, task_type), names_from = generation, values_from = mean_risk_aversion, names_prefix = "gene_") %>% 
  dplyr::mutate(improve = case_when(
    (task_type == "risk_seeking") & (gene_0 > gene_2999) ~ 1,
    (task_type == "risk_seeking") & (gene_0 <= gene_2999) ~ 0,
    (task_type == "risk_aversion") & (gene_0 < gene_2999) ~ 1,
    (task_type == "risk_aversion") & (gene_0 >= gene_2999) ~ 0,
  )) %>% 
  dplyr::group_by(sim, task_type) %>% 
  dplyr::summarise(
    count = sum(improve),
    rate = count/n()
  )
```


```{r}
# 論文に載せる数値

# 最終世代で、リスク回避で0.9以上、リスク追求で0.1以下になった課題数を数える

df_agent_randmulti_summary %>%
  dplyr::filter(generation == 2999) %>% 
  dplyr::mutate(achieve = case_when(
    (task_type == "risk_seeking") & (mean_risk_aversion < 0.1) ~ 1,
    (task_type == "risk_seeking") & (mean_risk_aversion >= 0.1) ~ 0,
    (task_type == "risk_aversion") & (mean_risk_aversion > 0.9) ~ 1,
    (task_type == "risk_aversion") & (mean_risk_aversion <= 0.9) ~ 0,
  )) %>% 
  dplyr::group_by(sim, task_type) %>% 
  dplyr::summarise(
    count = sum(achieve),
    rate = count/n()
  )
```



# Fig.3 apとanの組合せと平均リスク回避率


```{r} 
# リスク回避が適応的な課題
## リスク選択肢のリスク = 20の課題だけ取り出す
target_sim <- as.factor(c(
 "30.5.10.20", "20.5.0.20", "10.5.-10.20", "0.5.-20.20", "-10.5.-30.20", "-20.5.-40.20", "-30.5.-50.20"
))

g <- VisHeatmap_RiskAversion(df_withingene, target_sim, "Risk-aversion task")

ggsave(plot = g, filename = here(output_path, "Fig3.1_Heatmap_RiskAversion_risk-aversion.png"), width = 17.0, height = 4.5, dpi = 400)
```


```{r}
# リスク追求が適応的な課題
## リスク選択肢のリスク = 20の課題だけ取り出す
target_sim <- factor(c(
  "30.5.50.20", "20.5.40.20", "10.5.30.20", "0.5.20.20", "-10.5.10.20", "-20.5.0.20", "-30.5.-10.20"
))

g <- VisHeatmap_RiskAversion(df_withingene, target_sim, "Risk-seeking task")

ggsave(plot = g, filename = here(output_path, "Fig3.2_Heatmap_RiskAversion_risk-seeking.png"), width = 17.0, height = 4.5, dpi = 400)
```


```{r}
# 論文に載せる数値 
# リスク追求課題

target_sim <- factor(c(
  "30.5.50.20", "20.5.40.20", "10.5.30.20", "0.5.20.20", "-10.5.10.20", "-20.5.0.20", "-30.5.-10.20"
))

df_rev <- 
  df_withingene %>%
  dplyr::filter(sim %in% target_sim) %>% 
  dplyr::mutate(
    ap = round(ap, 4),
    an = round(an, 4),
    bt = round(bt, 4),
    rate_risk_aversion = 1 - choice_rate1,
    sim_fac = factor(sim, levels = target_sim) %>% as.numeric()
  ) %>% 
  dplyr::mutate(
    sim_sort = factor(paste0('N(', m2, ',', sd2, ') vs N(', m1, ',', sd1, ')')) %>% forcats::fct_reorder(., sim_fac, .desc = TRUE)
  ) %>%
  dplyr::group_by(sim_sort, ap, an, bt) %>%
  dplyr::summarise(
    mean_pvalue = mean(average_pvalue), 
    sd_pvalue = sqrt(variance(average_pvalue)),
    mean_risk_aversion = mean(rate_risk_aversion),
    sd_risk_aversion = sqrt(variance(rate_risk_aversion))
  ) %>%
  dplyr::filter(bt == 0.25)


# 75%以上リスク回避ができる最小のanパラメータは？
df_rev %>%
  dplyr::filter(mean_risk_aversion > 0.75) %>% 
  dplyr::select(sim_sort, ap, an, mean_risk_aversion) %>% 
  dplyr::group_by(sim_sort, ap) %>% 
  tidyr::nest() %>% 
  dplyr::mutate(
    min_risk_aversion = purrr::map(data, "mean_risk_aversion") %>% purrr::map_dbl(~min(.x))
  ) %>% 
  tidyr::unnest(data) %>%
  dplyr::filter(mean_risk_aversion == min_risk_aversion) ->
  df_min_an
  
print(df_min_an)

df_min_an %>% 
  ggplot(aes(x = ap, y = an)) + geom_point() + facet_wrap(~sim_sort)


# an = 0.3を下回ったらリスク回避率はどうなる

df_rev %>% 
  dplyr::filter(an <= 0.3) %>% 
  dplyr::group_by(sim_sort) %>% 
  dplyr::summarise(
   MEAN_risk_aversion = mean(mean_risk_aversion),
   SD_risk_aversion = mean(sd_risk_aversion)
  ) %>% 
  dplyr::ungroup() ->
  df_an_below03

mean(df_an_below03$MEAN_risk_aversion)

# an = 0.7を上回ったらリスク回避率はどうなる

df_rev %>% 
  dplyr::filter(an >= 0.7) %>% 
  dplyr::group_by(sim_sort) %>% 
  dplyr::summarise(
   MEAN_risk_aversion = mean(mean_risk_aversion),
   SD_risk_aversion = mean(sd_risk_aversion)
  ) %>% 
  dplyr::ungroup() ->
  df_an_above07

mean(df_an_above07$MEAN_risk_aversion)
```


# Fig.4a 期待値が同じリスク回避率

- 横軸: リスク回避率、縦軸: 頻度

```{r}
# 課題 * 条件のグラフを作成
df_choice_res_500T_latter100 %>% 
  
  ggplot(aes(x = risk_aversion)) + 
  geom_histogram() + 
  my_theme2 + 
  theme(axis.text.x = element_text(size = 18), 
        axis.text.y = element_text(size = 18), 
        axis.title = element_text(size = 26, face = "bold"), 
        strip.text.x = element_text(size = 17),
        plot.tag = element_text(size = 30)
        ) + 
  facet_grid(sim_n~task_struct) + 
  labs(x = "Rate of risk aversion", y = "Frequency of agent",
       tag = "(a)") -> g

ggsave(plot = g, filename = here(output_path, "Fig4a_RiskPref_RandMulti_latter100.png"), width = 17.0, height = 24.0, dpi = 400)
```


```{r}
# 発表用：2/2条件のみでグラフを作成
# 課題 * 条件のグラフを作成

df_choice_res_500T_latter100 %>% 
  dplyr::filter(sim == "cond_2/2") %>% 
  
  ggplot(aes(x = risk_aversion)) + 
  geom_histogram() + 
  my_theme2 + 
  theme(axis.text.x = element_text(size = 18), 
        axis.text.y = element_text(size = 18), 
        axis.title = element_text(size = 23, face="bold"), 
        strip.text.x = element_text(size = 17)
        ) + 
  facet_grid(.~task_struct) + 
  labs(x = "Rate of risk aversion", y = "Frequency of agent") -> g

ggsave(plot = g, filename = here(output_path, "Fig4a_RiskPref_RandMulti_latter100_cond2.png"), width = 18.0, height = 6.0)
```



# Fig.4b Gain-Lossの差のヒストグラム

  
- 2つのGain課題、2つのLoss課題で、それぞれの課題の平均値を計算

```{r}
df_choice_gainloss_500T_latter100_last %>% 
  
  ggplot(aes(x = risk_aver_gain_loss)) + geom_histogram() + 
  geom_vline(xintercept = 0, color = "black") + 
  my_theme2 + 
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 18), 
    axis.title.y = element_text(size = 21, face = "bold"), 
    axis.title.x = element_text(size = 18, face = "bold"), 
    strip.text.y = element_text(size = 18),
    plot.tag = element_text(size = 30)
    ) +
  labs(x = "Gain-loss differece in risk aversion", y = "",
       tag = "(b)") + 
  facet_grid(sim_n~.) -> g

ggsave(plot = g, filename = here(output_path, "Fig4b_RiskPrefDif_RandMulti_latter100_vert.png"), width = 5.5, height = 18.0, dpi = 400)
```



```{r}
# 数値　分布のピークを取り出す

df_choice_gainloss_500T_latter100_last %>% 
  
  dplyr::group_by(sim_n) %>% 
  tidyr::nest() %>% 
  dplyr::mutate(mode_riskavers = purrr::map(data, "risk_aver_gain_loss") %>% purrr::map_dbl(~map_value(.x))) %>% 
  
  dplyr::ungroup() %>% 
  dplyr::select(sim_n, mode_riskavers) %>% 
  formattable::formattable(.)
```



```{r}
# リスク回避増加/減少の割合：gain - loss > 0 (lossに比べてgainでリスク回避傾向が増加した) である個体の数

df_choice_gainloss_500T_latter100_last %>% 
  
  dplyr::mutate(
    gain_loss_plus = if_else(risk_aver_gain_loss > 0, "gain > loss", "loss > gain")
  ) %>% 
  dplyr::group_by(sim_n, gain_loss_plus) %>% 
  dplyr::summarise(
    n = n(),
    rate = n/100000
  ) %>% 
  dplyr::select(sim_n, gain_loss_plus, rate) %>% 
  dplyr::filter(gain_loss_plus == "gain > loss") %>% 
  formattable::formattable(.)
```


# Session Info

- RStudio Version：1.4.1717
    
    
```{r, eval = FALSE}
RStudio.Version()$version
```

- Packages

```{r}
sessionInfo()
```

