---
title: "Figures for Paper"
author: "Shogo Homma"
date: "`r format(Sys.time(), '%Y/%m/%d')`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 2
    theme: spacelab
    highlight: haddock
    fig_caption: yes
    fig_width: 9
    fig_height: 8
    self_contained: true
    md_extensions: -ascii_identifiers
---


# Setup

```{r, load-library}
library(tidyverse)
library(here)
library(data.table)
library(patchwork)
```


```{r}
# set the path for saving figs and sim results
output_path <- here("Output", "FiguresForPaper")
simout_SameExp_path <- here("Data", "SameExp_Sim_RandMultiTask") # dir for sim same exp tasks

# dir.create(output_path, recursive = TRUE)
# dir.create(simout_SameExp_path, recursive = TRUE)
```


```{r setup knit_environment, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, comment="", warning=FALSE, message=FALSE, fig.align="center", cache=F)
```


## Load functions

```{r}
common_functions_path <- here("Analysis_Script", "_functions_common")
common_functions <- here(common_functions_path, dir(common_functions_path))
purrr::walk(common_functions, ~source(.x))

project_functions_path <- here("Analysis_Script", "_functions_project")
project_functions <- here(project_functions_path, dir(project_functions_path))
purrr::walk(project_functions, ~source(.x))
```


## Load data

### Single-task simulations

```{r}
## load _gene.csv (averaged para info for each generation)

## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name_30_5 <- c(
  "_20191214183504", "_20191214183505", "_20191214183506", "_20191214183507", "_20191214183508",
  "_20191216111051", "_20191216111052", "_20191216111053", "_20191216111054", "_20191216111055",
  "_20191217145232", "_20191217145233", "_20191217145234", "_20191217145235", "_20191217145236",
  "_20191218152742", "_20191218152743", "_20191218152744", "_20191218152745", "_20191218152746")

sim_name_30_5 <- c(
  "30.5.50.30", "30.5.50.25", "30.5.50.20", "30.5.50.15", "30.5.50.10", 
  "30.5.40.30", "30.5.40.25", "30.5.40.20", "30.5.40.15", "30.5.40.10", 
  "30.5.20.30", "30.5.20.25", "30.5.20.20", "30.5.20.15", "30.5.20.10", 
  "30.5.10.30", "30.5.10.25", "30.5.10.20", "30.5.10.15", "30.5.10.10")

pattern_name_20_5 <- c(
  "_20191119144338", "_20191118142201", "_20190916204328", "_20191118142145", "_20191118142115",
  "_20191223104741", "_20191223104742", "_20191223104743", "_20191223104744", "_20191223104745",
  "_20200110152317", "_20200110152318", "_20200110152319", "_20200110152320", "_20200110152321",
  "_20191219134742", "_20191224122806", "_20190916204119", "_20191224122807", "_20191220110720")

sim_name_20_5 <- c(
  "20.5.40.30", "20.5.40.25", "20.5.40.20", "20.5.40.15", "20.5.40.10",
  "20.5.30.30", "20.5.30.25", "20.5.30.20", "20.5.30.15", "20.5.30.10", 
  "20.5.10.30", "20.5.10.25", "20.5.10.20", "20.5.10.15", "20.5.10.10",
  "20.5.0.30", "20.5.0.25", "20.5.0.20", "20.5.0.15", "20.5.0.10")

pattern_name_10_5 <- c(
  "_20191225105829", "_20191225105830", "_20191225105831", "_20191225105832", "_20191226115412",
  "_20200111161131", "_20200111161132", "_20200111161133", "_20200111161134", "_20200111161135", 
  "_20200113142323", "_20200113142324", "_20200113142325", "_20200113142326", "_20200113142327",
  "_20191226115336", "_20191226115337", "_20191226115338", "_20191226115339", "_20191227142311")

sim_name_10_5 <- c(
  "10.5.30.30", "10.5.30.25", "10.5.30.20", "10.5.30.15", "10.5.30.10",
  "10.5.20.30", "10.5.20.25", "10.5.20.20", "10.5.20.15", "10.5.20.10",
  "10.5.0.30", "10.5.0.25", "10.5.0.20", "10.5.0.15", "10.5.0.10",
  "10.5.-10.30", "10.5.-10.25", "10.5.-10.20", "10.5.-10.15", "10.5.-10.10")

pattern_name_0_5 <- c(
  "_20191121180423", "_20191121180252", "_20190916204538", "_20191121180225", "_20191121180208",
  "_20200114122539", "_20200114122540", "_20200114122541", "_20200114122542", "_20200114122543",
  "_20200115150219", "_20200115150220", "_20200115150221", "_20200115150222", "_20200115150223", 
  "_20191224123053", "_20191224123054", "_20190916204210", "_20191224123055", "_20191225105953")

sim_name_0_5 <- c(
  "0.5.20.30", "0.5.20.25", "0.5.20.20", "0.5.20.15", "0.5.20.10",
  "0.5.10.30", "0.5.10.25", "0.5.10.20", "0.5.10.15", "0.5.10.10",
  "0.5.-10.30", "0.5.-10.25", "0.5.-10.20", "0.5.-10.15", "0.5.-10.10",
  "0.5.-20.30", "0.5.-20.25", "0.5.-20.20", "0.5.-20.15", "0.5.-20.10")

pattern_name_minus10_5 <- c(
  "_20191227142546", "_20191227142547", "_20191227142548", "_20191227142549", "_20191228112810",
  "_20200116170128", "_20200116170129", "_20200116170130", "_20200116170131", "_20200116170132",
  "_20200118155206", "_20200118155207", "_20200118155208", "_20200118155209", "_20200118155210",
  "_20191228112846", "_20191228112847", "_20191228112848", "_20191228112849", "_20191228184927")

sim_name_minus10_5 <- c(
  "-10.5.10.30", "-10.5.10.25", "-10.5.10.20", "-10.5.10.15", "-10.5.10.10",
  "-10.5.0.30", "-10.5.0.25", "-10.5.0.20", "-10.5.0.15", "-10.5.0.10",
  "-10.5.-20.30", "-10.5.-20.25", "-10.5.-20.20", "-10.5.-20.15", "-10.5.-20.10",
  "-10.5.-30.30", "-10.5.-30.25", "-10.5.-30.20", "-10.5.-30.15", "-10.5.-30.10")

pattern_name_minus20_5 <- c(
  "_20191219130414", "_20191219130415", "_20190916204750", "_20191219130416", "_20191219130417",
  "_20191221121729", "_20191221121730", "_20191221121731", "_20191221121732", "_20191221121733",
  "_20191222102255", "_20191222102256", "_20191222102257", "_20191222102258", "_20191222102259",
  "_20191220110603", "_20191220110604", "_20191114220026", "_20191220110605", "_20191220110606")

sim_name_minus20_5 <- c(
  "-20.5.0.30", "-20.5.0.25", "-20.5.0.20", "-20.5.0.15", "-20.5.0.10",
  "-20.5.-10.30", "-20.5.-10.25", "-20.5.-10.20", "-20.5.-10.15", "-20.5.-10.10",
  "-20.5.-30.30", "-20.5.-30.25", "-20.5.-30.20", "-20.5.-30.15", "-20.5.-30.10",
  "-20.5.-40.30", "-20.5.-40.25", "-20.5.-40.20", "-20.5.-40.15", "-20.5.-40.10")

pattern_name_minus30_5 <- c(
  "_20191229191133", "_20191229191134", "_20191229191135", "_20191229191136", "_20191229191137",
  "_20220104104342", "_20220104104343", "_20220104104344", "_20220104104345", "_20220104104346", 
  "_20220322151600", "_20220322151601", "_20220322151602", "_20220323153501", "_20220323153502", 
  "_20211230173101", "_20211230173102", "_20211230173103", "_20211230173104", "_20211230173105")

sim_name_minus30_5 <- c(
  "-30.5.-10.30", "-30.5.-10.25", "-30.5.-10.20", "-30.5.-10.15", "-30.5.-10.10",
  "-30.5.-20.30", "-30.5.-20.25", "-30.5.-20.20", "-30.5.-20.15", "-30.5.-20.10",
  "-30.5.-40.30", "-30.5.-40.25", "-30.5.-40.20", "-30.5.-40.15", "-30.5.-40.10",
  "-30.5.-50.30", "-30.5.-50.25", "-30.5.-50.20", "-30.5.-50.15", "-30.5.-50.10")


# unite as a single list

params <- list(
  pattern_name = c(pattern_name_30_5, pattern_name_20_5, pattern_name_10_5, pattern_name_0_5, pattern_name_minus10_5, pattern_name_minus20_5, pattern_name_minus30_5),
  sim_name = c(sim_name_30_5, sim_name_20_5, sim_name_10_5, sim_name_0_5, sim_name_minus10_5, sim_name_minus20_5, sim_name_minus30_5)
  )

DataDir <- "Data"
DataDir_sub <- "Evo_Sim_SingleTask"

# a dataframe for averaged data by generation
df_gene <- purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_gene.csv"))
df_gene_longer <- ConvertDfGeneLonger_MeanSD(df_gene)

```


```{r}
# load GeneAverage_*.csv (averaged beha info for each generation)

df_gene_riskaversion <- 
  purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "GeneAverage_"))

df_gene_riskaversion_mean <- 
  df_gene_riskaversion %>% 
  dplyr::group_by(sim, generation) %>% 
  dplyr::summarise(
    mean_choice1 = mean(MEAN_rate_choice1),
    sd_choice1 = mean(SD_rate_choice1)
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    mean_risk_aversion = 1 - mean_choice1
  ) %>% 
  tidyr::separate(col = "sim", into = c("m2", "sd2", "m1", "sd1"), sep = "\\.", remove = FALSE) %>% 
  dplyr::mutate(
    m1 = as.integer(m1),
    sd1 = as.integer(sd1),
    m2 = as.integer(m2),
    sd2 = as.integer(sd2)
  ) %>% 
  dplyr::mutate(
    discriminability = EffectSize(m1, sd1, m2, sd2),
    task_exp = paste(m1, " vs ", m2, sep = "")
  ) %>% 
  dplyr::arrange(desc(discriminability))

```


```{r}
# remove vectors above
rm(list = ls()[stringr::str_starts(string = ls(), pattern = "pattern_name")])
rm(list = ls()[stringr::str_starts(string = ls(), pattern = "sim_name")])
```


### Data of effect of learning rates in the single task (heatmap)


```{r}
## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name_30_5 <- c(
  "_20201227183815", "_20201227191810", "_20201227191811", "_20201227191812", "_20201227191813",
  "_20201227183031", "_20201227183152", "_20201227183354", "_20201227183600", "_20201227183713"
  )

sim_name_30_5 <- c(
  "30.5.50.30", "30.5.50.25", "30.5.50.20", "30.5.50.15", "30.5.50.10",
  "30.5.10.30", "30.5.10.25", "30.5.10.20", "30.5.10.15", "30.5.10.10")

pattern_name_20_5 <- c(
  "_20191229145232", "_20191229145233", "_20191023105942", "_20191229145234", "_20191229145235",
  "_20191229152907", "_20191229152908", "_20191023145842", "_20191229152909", "_20191229152910"
  )

sim_name_20_5 <- c(
  "20.5.40.30", "20.5.40.25", "20.5.40.20", "20.5.40.15", "20.5.40.10",
  "20.5.0.30", "20.5.0.25", "20.5.0.20", "20.5.0.15", "20.5.0.10")

pattern_name_10_5 <- c(
  "_20200108205820", "_20200108205821", "_20200108205822", "_20200108205823", "_20200108205824",
  "_20200109143326", "_20200109143327", "_20200109143328", "_20200109143329", "_20200109143330"
  )

sim_name_10_5 <- c(
  "10.5.30.30", "10.5.30.25", "10.5.30.20", "10.5.30.15", "10.5.30.10",
  "10.5.-10.30", "10.5.-10.25", "10.5.-10.20", "10.5.-10.15", "10.5.-10.10")

pattern_name_0_5 <- c(
  "_20191229161041", "_20191229161042", "_20191023141508", "_20191229161043", "_20191229161044",
  "_20191229164648", "_20191229164649", "_20191023145854", "_20191229164650", "_20191229164651"
  )

sim_name_0_5 <- c(
  "0.5.20.30", "0.5.20.25", "0.5.20.20", "0.5.20.15", "0.5.20.10",
  "0.5.-20.30", "0.5.-20.25", "0.5.-20.20", "0.5.-20.15", "0.5.-20.10")

pattern_name_minus10_5 <- c(
  "_20200109152359", "_20200109152360", "_20200109152361", "_20200109152362", "_20200109152363",
  "_20200109161034", "_20200109161035", "_20200109161036", "_20200109161037", "_20200109161038"
  )

sim_name_minus10_5 <- c(
  "-10.5.10.30", "-10.5.10.25", "-10.5.10.20", "-10.5.10.15", "-10.5.10.10",
  "-10.5.-30.30", "-10.5.-30.25", "-10.5.-30.20", "-10.5.-30.15", "-10.5.-30.10")

pattern_name_minus20_5 <- c(
  "_20191229172653", "_20191229172654", "_20191023141626", "_20191229172655", "_20191229172656",
  "_20191229181936", "_20191229181937", "_20191229181938", "_20191229181939", "_20191229181940"
  )

sim_name_minus20_5 <- c(
  "-20.5.0.30", "-20.5.0.25", "-20.5.0.20", "-20.5.0.15", "-20.5.0.10",
  "-20.5.-40.30", "-20.5.-40.25", "-20.5.-40.20", "-20.5.-40.15", "-20.5.-40.10")

pattern_name_minus30_5 <- c(
  "_20201227192101", "_20201227192253", "_20201227195149", "_20201227195150", "_20201227195151",
  "_20220323182716", "_20220323182717", "_20220323182718", "_20220323182719", "_20220323182720"
  )

sim_name_minus30_5 <- c(
  "-30.5.-10.30", "-30.5.-10.25", "-30.5.-10.20", "-30.5.-10.15", "-30.5.-10.10",
  "-30.5.-50.30", "-30.5.-50.25", "-30.5.-50.20", "-30.5.-50.15", "-30.5.-50.10"
  )


# unite as a single list

params <- list(
  pattern_name = c(pattern_name_30_5, pattern_name_20_5, pattern_name_10_5, pattern_name_0_5, pattern_name_minus10_5, pattern_name_minus20_5, pattern_name_minus30_5),
  sim_name = c(sim_name_30_5, sim_name_20_5, sim_name_10_5, sim_name_0_5, sim_name_minus10_5, sim_name_minus20_5, sim_name_minus30_5)
  )

# remove vectors above
rm(list = ls()[stringr::str_starts(string = ls(), pattern = "pattern_name")])
rm(list = ls()[stringr::str_starts(string = ls(), pattern = "sim_name")])

DataDir <- "Data"
DataDir_sub <- "WithinGeneration_Sim_SingleTask"

# a dataframe for para effect
df_withingene <- purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDfWithinGene(.x, .y, DataDir, DataDir_sub, "_nat.csv"))
```


### Multiple-task simulation (random tasks)


```{r}
# create dataframes for task info

## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name <- c("_20220905162206", "_20220909161625", "_20220919103516", "_20220921105827", "_20220923105509")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

params <- list(
  pattern_name = pattern_name,
  sim_name = sim_name
)

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"


df_randmulti_taskinfo <- 
  purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_task.csv")) %>% 
  dplyr::mutate(
    area_rate = (pnorm(0, m1, sd1) + pnorm(0, m2, sd2))/2,
    eff_size = EffectSize(m1, sd1, m2, sd2)
    ) %>% 
  dplyr::mutate(
    posi_nega = case_when(
      (m1 > 0) & (m2 > 0) ~ "posi",
      (m1 < 0) & (m2 < 0) ~ "nega",
      TRUE ~ "other"
    ),
    task_type = case_when(
      m1 > m2 ~ "risk_seeking",
      m2 > m1 ~ "risk_aversion"
    ),
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
    )

df_randmulti_taskgroup <- 
  purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_taskgroup.csv")) %>% 
  dplyr::mutate(area_rate = (pnorm(0, m1, sd1) + pnorm(0, m2, sd2))/2) %>% 
  dplyr::mutate(
    posi_nega = case_when(
      (m1 > 0) & (m2 > 0) ~ "posi",
      (m1 < 0) & (m2 < 0) ~ "nega",
      TRUE ~ "other"
    ),
    task_type = case_when(
      m1 > m2 ~ "risk_seeking",
      m2 > m1 ~ "risk_aversion"
    ),
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
    )


# calculate the averaged effect size and negative area for each sim
df_randmulti_taskinfo %>% 
  dplyr::group_by(sim, sim_i) %>% 
  dplyr::summarise(
    mean_eff_size = mean(eff_size),
    mean_area_rate = mean(area_rate)
  ) %>% 
  dplyr::ungroup() ->
  df_randmulti_mean_taskinfo
```


```{r}
# load _gene.csv

## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name <- c("_20220905162206", "_20220909161625", "_20220919103516", "_20220921105827", "_20220923105509")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

params <- list(
  pattern_name = pattern_name,
  sim_name = sim_name
)

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"

df_gene_randmulti <- purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_gene.csv"))

df_gene_randmulti %>% 
  dplyr::group_by(sim, generation) %>% 
  dplyr::summarise(
    MEAN_ap = mean(mean_ap),
    MEAN_an = mean(mean_an),
    MEAN_bt = mean(mean_bt)
  ) %>% 
  dplyr::ungroup() -> 
  df_gene_randmulti_summary


# combine para df (filtered by last generation) with task info
df_gene_randmulti %>% 
  dplyr::filter(generation == 2999) %>% 
  dplyr::full_join(df_randmulti_mean_taskinfo, by = c("sim", "sim_i")) ->
  df_gene_randmulti_taskinfo


# df for overall summary
df_gene_randmulti %>% 
  dplyr::group_by(sim, generation) %>% 
  dplyr::summarise(
    MEAN_ap = mean(mean_ap),
    MEAN_an = mean(mean_an),
    MEAN_bt = mean(mean_bt)
  ) %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_longer(cols = -c(sim, generation), names_to = c("stat", "para"), names_sep = "_") %>% 
  tidyr::pivot_wider(names_from = stat, values_from = value) -> 
  df_gene_randmulti_summary_longer

df_gene_randmulti %>% 
  tidyr::pivot_longer(cols = -c(sim, sim_i, generation), names_to = c("stat", "para"), names_sep = "_") %>% 
  tidyr::pivot_wider(names_from = stat, values_from = value) ->
  df_gene_randmulti_longer

df_gene_randmulti_longer %>% 
  dplyr::filter(generation == 2999) %>% 
  dplyr::full_join(df_randmulti_mean_taskinfo, by = c("sim", "sim_i")) ->
  df_gene_randmulti_taskinfo_longer
```



```{r, eval=FALSE}
# load _nat.csv.gz (averaged info for each agent)

## Because the size of _nat.csv is big, we create another object for containing only the info of the first and last generation (the .RDS file below).

## This process takes much time and memory. So, once the .RDS file is created, you should not run this chunk again. 

## The main code is temporarily commented out in case that you run this chunk mistakenly. If you want to run, the comment should be removed. 


## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name <- c("_20220905162206", "_20220909161625", "_20220919103516", "_20220921105827", "_20220923105509")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"

AgentN <- 1000
GeneN <- 3000
TaskN <- 4
Extract_SimN <- 100


# # save agent data for each condition


# df_agent_randmulti_22 <- MakeDfNat_Rand(pattern_name[1], sim_name[1], DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)
# saveRDS(df_agent_randmulti_22, file = here(DataDir, DataDir_sub, "df_agent_randmulti_22.RDS"))
# 
# df_agent_randmulti_13 <- MakeDfNat_Rand(pattern_name[2], sim_name[2], DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)
# saveRDS(df_agent_randmulti_13, file = here(DataDir, DataDir_sub, "df_agent_randmulti_13.RDS"))
# 
# df_agent_randmulti_31 <- MakeDfNat_Rand(pattern_name[3], sim_name[3], DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)
# saveRDS(df_agent_randmulti_31, file = here(DataDir, DataDir_sub, "df_agent_randmulti_31.RDS"))
# 
# df_agent_randmulti_04 <- MakeDfNat_Rand(pattern_name[4], sim_name[4], DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)
# saveRDS(df_agent_randmulti_04, file = here(DataDir, DataDir_sub, "df_agent_randmulti_04.RDS"))
# 
# df_agent_randmulti_40 <- MakeDfNat_Rand(pattern_name[5], sim_name[5], DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)
# saveRDS(df_agent_randmulti_40, file = here(DataDir, DataDir_sub, "df_agent_randmulti_40.RDS"))
```


```{r}
# load df_agent_randmulti.RDS
# -> create df_agent_randmulti_summary & df_agent_randmulti_simMEAN

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"

names_randmulti_rds <- c("df_agent_randmulti_22.RDS", "df_agent_randmulti_13.RDS", "df_agent_randmulti_31.RDS", "df_agent_randmulti_04.RDS", "df_agent_randmulti_40.RDS")

df_agent_randmulti <-
  purrr::map_dfr(names_randmulti_rds, ~readRDS(here(DataDir, DataDir_sub, .x)))


# create _summary dataframe

df_agent_randmulti %>% 
  dplyr::group_by(sim, sim_i, task_i, generation) %>%
  dplyr::summarise(
    MEAN_payoff = mean(mean_payoff),
    SD_payoff = sqrt(variance(mean_payoff)),
    MEAN_rate_choice1 = mean(rate_choice1),
    SD_rate_choice1 = sqrt(variance(rate_choice1))
  ) %>%
  dplyr::ungroup() %>% 
  dplyr::mutate(
    mean_risk_aversion = 1 - MEAN_rate_choice1
  ) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) ->
  df_agent_randmulti_summary


# combine _summary with taskinfo

df_randmulti_taskinfo %>% 
  dplyr::full_join(df_agent_randmulti_summary, by = c("sim_n", "sim", "sim_i", "task_i")) ->
  df_agent_randmulti_summary


# summmarise by sim & generation

df_agent_randmulti_summary %>%
  dplyr::group_by(sim, generation, task_type) %>%
  dplyr::summarise(
    MEAN_risk_aversion = mean(mean_risk_aversion),
    SD_risk_aversion = sqrt(variance(mean_risk_aversion)),
    N = n()
  ) %>%
  dplyr::ungroup() %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) ->
  df_agent_randmulti_simMEAN
```

 
 
### Tasks where the expected values are the same 


#### Run simulations


```{r}
# load df_beha_agent_randmulti.RDS
# -> create and save df_para_agent_randmulti_FirstLastGene.RDS

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"

names_randmulti_rds <- c("df_agent_randmulti_22.RDS", "df_agent_randmulti_13.RDS", "df_agent_randmulti_31.RDS", "df_agent_randmulti_04.RDS", "df_agent_randmulti_40.RDS")

df_agent_randmulti <-
  purrr::map_dfr(names_randmulti_rds, ~readRDS(here(DataDir, DataDir_sub, .x)))

df_para_agent_randmulti_FirstLastGene <-
  df_agent_randmulti %>%
  dplyr::filter(task_i == 0) %>%  # one task is adequate
  dplyr::select(sim, sim_i, generation, agent, ap, an, bt)

# If you want to run, the comment symbol below should be removed.
# saveRDS(df_para_agent_randmulti_FirstLastGene, file = here(DataDir, DataDir_sub, "df_para_agent_randmulti_FirstLastGene.RDS"))
```


```{r, eval=FALSE}
# Simulate task where the expected values are the same

## The main code is temporarily commented out in case that you run this chunk mistakenly. If you want to run, the comment should be removed. 

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"

# load para info of the first and last generation
df_para_agent_randmulti_FirstLastGene <- readRDS(here(DataDir, DataDir_sub, "df_para_agent_randmulti_FirstLastGene.RDS"))

trial_N <- 500
task_struct_list <- list(
  c(20, 20, 20, 5), 
  c(10, 20, 10, 5), 
  c(-10, 20, -10, 5), 
  c(-20, 20, -20, 5)
)

# Simulation of agents of the last generation

# df_agent_randmulti_Last <- df_para_agent_randmulti_FirstLastGene %>%
#   dplyr::filter(generation == 2999) # filtered by the last generation
# 
# res_ql_list_Last <- purrr::map(task_struct_list, ~RunQL_dual(df_agent_randmulti_Last, .x, trial_N))
# 
# res_ql_list_choice_Last <-
#   res_ql_list_Last %>%
#   purrr::map("Choice")
# 
# # save RDS file
# saveRDS(object = res_ql_list_choice_Last, file = here(simout_SameExp_path, "res_ql_list_choice_LastGene_500T.RDS"))


# Simulation of agents of the first generation

# df_agent_randmulti_First <- df_para_agent_randmulti_FirstLastGene %>%
#   dplyr::filter(generation == 0)
# 
# res_ql_list_First <- purrr::map(task_struct_list, ~RunQL_dual(df_agent_randmulti_First, .x, trial_N))
# 
# res_ql_list_choice_First <-
#   res_ql_list_First %>%
#   purrr::map("Choice")
# 
# # save RDS file
# saveRDS(object = res_ql_list_choice_First, file = here(simout_SameExp_path, "res_ql_list_choice_FirstGene_500T.RDS"))
```


#### Load simulations results

```{r}
# load the simu results

res_ql_list_choice_500T_last <- readRDS(file = here(simout_SameExp_path, "res_ql_list_choice_LastGene_500T.RDS"))

# load the sim results of the parameters of the first generation
res_ql_list_choice_500T_first <- readRDS(file = here(simout_SameExp_path, "res_ql_list_choice_FirstGene_500T.RDS"))

# load of the para info of the first and last generation
df_para_agent_randmulti_FirstLastGene <- readRDS(here("Data", "Evo_RandMultiTask", "df_para_agent_randmulti_FirstLastGene.RDS"))

df_agent_randmulti_Last <-
  df_para_agent_randmulti_FirstLastGene %>% 
  dplyr::filter(generation == 2999)

df_agent_randmulti_First <-
  df_para_agent_randmulti_FirstLastGene %>%
  dplyr::filter(generation == 0)
```



```{r, eval=FALSE}
# extract the data of the last 100 trials

## The main code temporarily is commented out in case that you run this chunk mistakenly. If you want to run, the comment should be removed. 

# purrr::map(res_ql_list_choice_500T_last,
#            ~{.x %>%
#                tibble::as_tibble(.) %>%
#                dplyr::bind_cols(df_agent_randmulti_Last) %>%
#                tidyr::pivot_longer(
#                  cols = starts_with("V"),
#                  names_to = "trial",
#                  names_prefix = "V",
#                  values_to = "choice",
#                  names_transform = list(trial = as.integer)
#                ) %>%
#                dplyr::mutate(
#                  choice = if_else(choice == 2, 0, 1)
#                ) %>%
#                dplyr::filter(trial > 400) %>% # extract the last 100 trials
#                dplyr::group_by(sim, sim_i, agent, an, ap, bt) %>% # averaging across trial
#                dplyr::summarise(
#                  risk_aversion = 1 - mean(choice)
#                ) %>%
#                dplyr::ungroup() %>%
#                dplyr::mutate(an_ap = (an - ap)/(an + ap))
#                }) %>%
#   dplyr::bind_rows(.id = "task") %>%
#   dplyr::mutate(generation = 2999) ->
#   df_choice_res_latter100_last
# 
# 
# purrr::map(res_ql_list_choice_500T_first,
#            ~{.x %>%
#                tibble::as_tibble(.) %>%
#                dplyr::bind_cols(df_agent_randmulti_First) %>%
#                tidyr::pivot_longer(
#                  cols = starts_with("V"),
#                  names_to = "trial",
#                  names_prefix = "V",
#                  values_to = "choice",
#                  names_transform = list(trial = as.integer)
#                ) %>%
#                dplyr::mutate(
#                  choice = if_else(choice == 2, 0, 1)
#                ) %>%
#                dplyr::filter(trial > 400) %>% # extract the last 100 trials
#                dplyr::group_by(sim, sim_i, agent, an, ap, bt) %>% # averaging across trial
#                dplyr::summarise(
#                  risk_aversion = 1 - mean(choice)
#                ) %>%
#                dplyr::ungroup() %>%
#                dplyr::mutate(an_ap = (an - ap)/(an + ap))
#                }) %>%
#   dplyr::bind_rows(.id = "task") %>%
#   dplyr::mutate(generation = 0) ->
#   df_choice_res_latter100_first
# 
# 
# # combine first and last generation data
# df_choice_res_latter100_last %>%
#   dplyr::bind_rows(df_choice_res_latter100_first) %>%
#   dplyr::mutate(task = as.integer(task)) %>%
#   dplyr::mutate(
#     task_struct =
#       case_when(
#         task == 1 ~ "N(20, 20) vs N(20, 5) (Gain)",
#         task == 2 ~ "N(10, 20) vs N(10, 5) (Gain)",
#         task == 3 ~ "N(-10, 20) vs N(-10, 5) (Loss)",
#         task == 4 ~ "N(-20, 20) vs N(-20, 5) (Loss)",
#       ) %>% forcats::fct_reorder(., task),
#     sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
#   ) ->
#   df_choice_res_500T_latter100
# 
# saveRDS(df_choice_res_500T_latter100, file = here(simout_SameExp_path, "df_choice_res_500T_lat.RDS"))
```


```{r}
# load 500-trials simulation, last 100-trials data
df_choice_res_500T_latter100 <- readRDS(file = here(simout_SameExp_path, "df_choice_res_500T_lat.RDS"))
```


```{r}
df_choice_res_500T_latter100 %>% 
  
  dplyr::filter(generation == 2999) %>% 
  
  dplyr::mutate(gain_loss = if_else(task == 1 | task == 2, "gain", "loss")) %>% 
  dplyr::group_by(sim_n, sim_i, agent, ap, an, bt, an_ap, gain_loss) %>% 
  dplyr::summarise(
    mean_risk_aversion = mean(risk_aversion)
  ) %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(id_cols = c(sim_n, sim_i, agent, ap, an, bt, an_ap), names_from = gain_loss, values_from = mean_risk_aversion) %>% 
  dplyr::mutate(
    risk_aver_gain_loss = gain - loss # calculate gain-loss difference
  ) ->
  df_choice_gainloss_500T_latter100_last
```


# Fig.1a Single task：Risk aversion rate


- horizontal axis: task, vertical axis: mean rate of risk aversion in the last generation (+SD)

```{r, eval = FALSE}
# Risk-aversion task
target_simexp <- c("-50 vs -30", "-40 vs -20", "-30 vs -10", "-20 vs 0", "-10 vs 10", "0 vs 20", "10 vs 30")

g1_a1 <- VisFirstLastGene_RiskAversion(df_gene_riskaversion_mean, target_simexp, "Risk-aversion task", tag = "(a)")

#ggsave(plot = g, filename = here(output_path, "Fig1a.1_FirstLastGene_RiskAversion_risk-aversion_inrow.tiff"), width = 20.0, height = 6.0, dpi = 300, device = "tiff")


# Risk-seeking task
target_simexp <- c("-10 vs -30", "0 vs -20", "10 vs -10", "20 vs 0", "30 vs 10", "40 vs 20", "50 vs 30")

g1_a2 <- VisFirstLastGene_RiskAversion(df_gene_riskaversion_mean, target_simexp, "Risk-seeking task", tag = "    ", legend = FALSE)


#ggsave(plot = g, filename = here(output_path, "Fig1_FirstLastGene_RiskAversion_risk-seeking_inrow.tiff"), width = 20.0, height = 12.0, dpi = 100, device = "tiff")
```


```{r}
# calculate values for the paper
# mean rate of risk aversion in the first generation in the risk-seeking tasks

target_simexp <- c("-10 vs -30", "0 vs -20", "10 vs -10", "20 vs 0", "30 vs 10", "40 vs 20", "50 vs 30")
df_gene_riskaversion_mean %>% 
  dplyr::filter(generation == 0) %>% 
  dplyr::filter(task_exp %in% target_simexp) %>% 
  dplyr::select(sim, mean_risk_aversion) %>% 
  dplyr::arrange(mean_risk_aversion)
```


# Fig.1b Single task：Evolutionary results of alpha_p and alpha_n

  
- horizontal: task, vertical: mean parameter values of the last generation (+SD）

```{r, eval = FALSE}
# Risk-aversion task

target_simexp <- c("-50 vs -30", "-40 vs -20", "-30 vs -10", "-20 vs 0", "-10 vs 10", "0 vs 20", "10 vs 30")

g1_b1 <- VisLastGene_Para_RunMean(df_gene_longer, target_simexp, "alpha", "Risk-aversion task", tag = "(b)")

#ggsave(plot = g, filename = here(output_path, "Fig1b.1_LastGene_apan_risk-aversion_inrow.png"), width = 20.0, height = 6.0, dpi = 400)


# Risk-seeking task

target_simexp <- c("-10 vs -30", "0 vs -20", "10 vs -10", "20 vs 0", "30 vs 10", "40 vs 20", "50 vs 30")

g1_b2 <- VisLastGene_Para_RunMean(df_gene_longer, target_simexp, "alpha", "Risk-seeking task", tag = "    ", legend = FALSE)

#ggsave(plot = g, filename = here(output_path, "Fig1b.2_LastGene_apan_risk-seeking_inrow.png"), width = 20.0, height = 6.0, dpi = 400)
```

# save Fig 1

```{r}
# save Fig 1 a & b

g <- g1_a1 / g1_a2 / g1_b1 / g1_b2

ggsave(plot = g, filename = here(output_path, "Fig1.png"), width = 20.0, height = 24.0, dpi = 70)

ggsave(plot = g, filename = here(output_path, "Fig1.tiff"), width = 20.0, height = 24.0, dpi = 70, device = "tiff")
```



```{r}
# calculate values for the paper
# alpha_n value in the last generation

# Risk-aversion task
target_simexp <- c("-50 vs -30", "-40 vs -20", "-30 vs -10", "-20 vs 0", "-10 vs 10", "0 vs 20", "10 vs 30")

df_gene_longer %>% 
  dplyr::filter(para == "an") %>% 
  dplyr::filter(generation == 4999) %>% 
  dplyr::filter(task_exp %in% target_simexp) %>% 
  dplyr::select(sim, task_exp, sd1, mean_rate) %>% 
  dplyr::arrange(sd1) -> 
  df_mean_rate

print(df_mean_rate)

df_mean_rate %>% 
  dplyr::pull(mean_rate) %>% 
  summary

# Risk-seeking task
target_simexp <- c("-10 vs -30", "0 vs -20", "10 vs -10", "20 vs 0", "30 vs 10", "40 vs 20", "50 vs 30")

df_gene_longer %>% 
  dplyr::filter(para == "an") %>% 
  dplyr::filter(generation == 4999) %>% 
  dplyr::filter(task_exp %in% target_simexp) %>% 
  dplyr::select(sim, task_exp, sd1, mean_rate) %>% 
  dplyr::arrange(sd1) -> 
  df_mean_rate

print(df_mean_rate)

df_mean_rate %>% 
  dplyr::pull(mean_rate) %>% 
  summary
```


# Fig.2a Multiple-task：Evolutionary dynamics of alpha_p and alpha_n

  
- horizontal axis: generation, vertical axis: alpha value（each line corresponds to a simulation）


```{r, eval = FALSE} 
df_gene_randmulti_summary_longer %>% 
  dplyr::filter(para %in% c("ap", "an")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = "),
    para_rev = case_when(
      para == "ap" ~ "alpha[p]",
      para == "an" ~ "alpha[n]"
    )
  ) -> 
  df_gene_randmulti_summary_longer_rev

df_gene_randmulti_longer %>% 
  dplyr::filter(para %in% c("ap", "an")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = "),
    para_rev = case_when(
      para == "ap" ~ "alpha[p]",
      para == "an" ~ "alpha[n]"
    )
  ) %>% 
  
  ggplot(aes(x = generation, y = mean)) + geom_line(aes(group = sim_i), size = 0.08) + 
  geom_line(data = df_gene_randmulti_summary_longer_rev, aes(x = generation, y = MEAN, color = para), size = 2.0) +
  my_theme2 + labs(x = 'Generation', y = 'Parameter value', 
                   tag = "(a)") + guides(color = "none") + 
  scale_color_manual(name = "", values = c("#1F78B4", "#FF7F00"), 
                     labels = c(expression(paste(alpha[n])), expression(paste(alpha[p])))) +  
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 19), 
    axis.title = element_text(size = 26, face = "bold"), 
    strip.text.x = element_text(size = 18),
    strip.text.y = element_text(angle = 0),
    plot.tag = element_text(size = 30)
  ) + 
  facet_grid(para_rev~sim_n, 
             labeller = labeller(para_rev = label_parsed)) + 
  coord_cartesian(ylim = c(0, 1.0)) ->
  g2_a
  
#ggsave(plot = g, filename = here(output_path, "Fig2a_Evo_RandMulti_apan.png"), width = 19.0, height = 7.5)
```


```{r}
# calculate values for the paper
# show the range of alpha_n in the last generation

df_gene_randmulti_summary_longer_rev %>% 
  dplyr::filter(para == "an") %>% 
  dplyr::filter(generation == 2999) -> a

print(a)

# extract averaged value of the condition where the both of the risk-aversion and risk-seeking task exist
a %>% 
  dplyr::filter(sim %in% c("cond_1/3", "cond_2/2", "cond_3/1")) %>% 
  dplyr::pull(MEAN) %>% 
  mean(.)
```


# Fig 2b Multiple-task：$\alpha_p$ and negative area rate


```{r}
df_gene_randmulti_taskinfo_longer %>% 
  dplyr::filter(para %in% c("ap")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) %>% 
  
  ggplot(aes(x = mean_area_rate, y = mean)) + geom_point() + geom_smooth(method = "lm") + 
  my_theme2 + facet_grid(.~sim_n) + 
  theme(
    axis.text.x = element_text(size = 20), 
    axis.text.y = element_text(size = 18), 
    axis.title = element_text(size = 25, face = "bold"), 
    strip.text.x = element_text(size = 18),
    plot.tag = element_text(size = 30)
  ) + 
  labs(x = "Mean negative area rate", y = expression(alpha[p]), 
       tag = "(b)") -> 
  g2_b

#ggsave(plot = g, filename = here(output_path, "Fig2b_Relation_RandMulti_ap_NegaArea.png"), width = 18.0, height = 6.0)
```


# Fig.2c Multiple-task：Risk aversion rate of conditions

## additional simulations  
  
- additional simulations for 0/4 cond & 4/0 cond
  
- simulate how agents who evolved 0/4 cond (only risk-aversion tasks) would behave in risk-seeking tasks

- randomly sample a risk-seeking task from the task group and simulate it in one population (1000 agents) of the first and last generation

- repeated it for each multiple-task simulation (100 times in total)

- the same simulations are run for 4/0 cond (only risk-seeking tasks) in risk-aversion tasks


```{r}
# set agents and task for additional simulations

# path for saving of simulated data
simout_Multiple_path <- here("Data", "Evo_RandMultiTask")


#--- cond risk seeking/aversion = 0/4

df_agent_randmulti_04_First <- # extract first generation
  df_agent_randmulti %>% 
  dplyr::filter(sim == "cond_0/4") %>% 
  dplyr::filter(generation == 0) %>% 
  dplyr::filter(task_i == 0) # one task is adequate

df_agent_randmulti_04_Last <- # extract last generation
  df_agent_randmulti %>% 
  dplyr::filter(sim == "cond_0/4") %>% 
  dplyr::filter(generation == 2999) %>% 
  dplyr::filter(task_i == 0) # one task is adequate

task_04_riskseeking <-
  df_randmulti_taskgroup %>% # taskgroup info
  dplyr::filter(sim == "cond_0/4") %>% 
  dplyr::filter(task_type == "risk_seeking") %>% # extract risk-seeking tasks of taskgroup
  dplyr::select(task_i, m1, sd1, m2, sd2)

# randomly sample a risk-seeking task
set.seed(789)

task_struct_temp <- NULL
for (sim_i in 1:100) {
  
  sampled_task <- sample(0:49, size = 1) # sample one task, task ID 0~49 are risk-seeking tasks
  temp <- 
    tibble(
      sim_i = sim_i,
      task_i = sampled_task[1]
    )
  
  task_struct_temp <- 
    task_struct_temp %>% 
    dplyr::bind_rows(temp)
  
}

task_struct_04_riskseeking <-
  task_struct_temp %>% 
  dplyr::left_join(task_04_riskseeking, by = "task_i") %>% 
  tidyr::pivot_longer(cols = c(m1, sd1, m2, sd2), names_to = "stat", values_to = "val") %>% 
  dplyr::group_by(sim_i, task_i) %>% 
  tidyr::nest() %>% 
  dplyr::mutate(stat_vec = purrr::map(data, "val"))


## if you want to save the sampled task data, run below (temporarily commented out)
## once run, you need not run again

# simout_Multiple_04_path <- here(simout_Multiple_path, "sim_res_Multiple04")
# dir.create(simout_Multiple_04_path)
# 
# save_task_struct_04_riskseeking <-
#   task_struct_04_riskseeking %>%
#   tidyr::unnest() %>%
#   dplyr::select(-stat_vec)
# 
# readr::write_csv(save_task_struct_04_riskseeking, file = here(simout_Multiple_04_path, "save_task_struct_04_riskseeking.csv"))


#--- cond risk seeking/aversion = 4/0

df_agent_randmulti_40_First <- 
  df_agent_randmulti %>% 
  dplyr::filter(sim == "cond_4/0") %>% 
  dplyr::filter(generation == 0) %>% 
  dplyr::filter(task_i == 0)  # 1つのtaskで十分

df_agent_randmulti_40_Last <- 
  df_agent_randmulti %>% 
  dplyr::filter(sim == "cond_4/0") %>% 
  dplyr::filter(generation == 2999) %>% 
  dplyr::filter(task_i == 0)  # 1つのtaskで十分

task_40_riskaversion <-
  df_randmulti_taskgroup %>% 
  dplyr::filter(sim == "cond_4/0") %>% 
  dplyr::filter(task_type == "risk_aversion") %>% 
  dplyr::select(task_i, m1, sd1, m2, sd2)

# randomly sample a risk-aversion task
set.seed(423)

task_struct_temp <- NULL
for (sim_i in 1:100) {
  
  sampled_task <- sample(50:99, size = 1) # sample one task, task ID 50~99 are risk-aversion tasks
  temp <- 
    tibble(
      sim_i = sim_i,
      task_i = sampled_task[1]
    )
  
  task_struct_temp <- 
    task_struct_temp %>% 
    dplyr::bind_rows(temp)
  
}

task_struct_40_riskaversion <-
  task_struct_temp %>% 
  dplyr::left_join(task_40_riskaversion, by = "task_i") %>% 
  tidyr::pivot_longer(cols = c(m1, sd1, m2, sd2), names_to = "stat", values_to = "val") %>% 
  dplyr::group_by(sim_i, task_i) %>% 
  tidyr::nest() %>% 
  dplyr::mutate(stat_vec = purrr::map(data, "val"))


## if you want to save the sampled task data, run below (temporarily commented out)
## once run, you need not run again

# simout_Multiple_40_path <- here(simout_Multiple_path, "sim_res_Multiple40")
# dir.create(simout_Multiple_40_path)
# 
# save_task_struct_40_riskaversion <-
#   task_struct_40_riskaversion %>%
#   tidyr::unnest() %>%
#   dplyr::select(-stat_vec)
# 
# readr::write_csv(save_task_struct_40_riskaversion, file = here(simout_Multiple_40_path, "save_task_struct_40_riskaversion.csv"))
```


```{r, eval=FALSE}
# Simulate 0/4 condition by RunQL_dual()
# Once the simulations are run, you need not run again

simout_Multiple_04_path <- here(simout_Multiple_path, "sim_res_Multiple04")
# dir.create(simout_Multiple_04_path)

trial_N <- 500

#--- agents of the first generation

# simulate the choice for a sampled task & save as .RDS
for (s_i in 1:100) {
  
  print(paste0("sim: ", s_i))
  
  task_struct_04_riskseeking_filtered <-
    task_struct_04_riskseeking %>% 
    dplyr::filter(sim_i == s_i) %>% 
    dplyr::pull(stat_vec)
    
  df_agent_randmulti_04_First_filtered <-
    df_agent_randmulti_04_First %>% 
    dplyr::filter(sim_i == s_i)
  
  # simulate for one task
  res_ql_04_list_First <- purrr::map(task_struct_04_riskseeking_filtered, ~RunQL_dual(df_agent_randmulti_04_First_filtered, .x, trial_N))
  
  res_ql_04_list_choice_First <-
  res_ql_04_list_First %>%
  purrr::map("Choice")

  # save RDS file
  saveRDS(object = res_ql_04_list_choice_First, file = here(simout_Multiple_04_path, paste0( "res_ql_04_list_choice_First_", s_i, ".RDS")))
  
}

#--- agents of the last generation

# simulate the choice for a sampled task & save as .RDS
for (s_i in 1:100) {
  
  print(paste0("sim: ", s_i))
  
  task_struct_04_riskseeking_filtered <-
    task_struct_04_riskseeking %>% 
    dplyr::filter(sim_i == s_i) %>% 
    dplyr::pull(stat_vec)
    
  df_agent_randmulti_04_Last_filtered <-
    df_agent_randmulti_04_Last %>% 
    dplyr::filter(sim_i == s_i)
  
  # simulate for one task
  res_ql_04_list_Last <- purrr::map(task_struct_04_riskseeking_filtered, ~RunQL_dual(df_agent_randmulti_04_Last_filtered, .x, trial_N))
  
  res_ql_04_list_choice_Last <-
  res_ql_04_list_Last %>%
  purrr::map("Choice")

  # save RDS file
  saveRDS(object = res_ql_04_list_choice_Last, file = here(simout_Multiple_04_path, paste0( "res_ql_04_list_choice_Last_", s_i, ".RDS")))
  
}


#------ summarize the choice and save as .csv ------#

#--- agents of the first generation

RDS_04_First <- dir(simout_Multiple_04_path, pattern = ".RDS") %>% stringr::str_subset(., pattern = "_First")
path_RDS_04_First <- here(simout_Multiple_04_path, RDS_04_First)

task_number <- 1 # task number is set to process any number of task

# for each simulated data (.RDS), summarize the choice and combine it as one df
df_04_First <- NULL
for (s_i in 1:100) {
  
  target_path_RDS_04_First <- path_RDS_04_First %>% stringr::str_subset(., pattern = paste0("_", s_i, ".RDS"))
  print(paste0("read : ", target_path_RDS_04_First))
  res <- readRDS(target_path_RDS_04_First)
  
  df_temp <-
    purrr::map_dfr(task_number, 
           ~{res[[.x]] %>% 
              tibble::as_tibble(.) %>% 
              dplyr::mutate(agent = 1:nrow(.)) %>% 
              tidyr::pivot_longer(cols = -agent, names_to = c("V", "trial"), values_to = "choice", 
                                  names_sep = 1L, names_transform = list(Trial = as.integer)) %>% 
              dplyr::mutate(choice = if_else(choice == 2, 0, 1)) %>% # 0: safe, 1: risky
              dplyr::group_by(agent) %>% 
              dplyr::summarise(
                risk_aversion = 1 - mean(choice)
              ) %>% 
              dplyr::ungroup() %>% 
              dplyr::mutate(
                task_i = .x,
                sim_i = s_i)
            }
           )
  
  df_04_First <- dplyr::bind_rows(df_04_First, df_temp)
  
}

# save as .csv
readr::write_csv(df_04_First, file = here(simout_Multiple_04_path, "df_04_First.csv"))


#--- agents of the last generation

RDS_04_Last <- dir(simout_Multiple_04_path, pattern = ".RDS") %>% stringr::str_subset(., pattern = "_Last")
path_RDS_04_Last <- here(simout_Multiple_04_path, RDS_04_Last)

task_number <- 1 # task number is set to process any number of task

# for each simulated data (.RDS), summarize the choice and combine it as one df
df_04_Last <- NULL
for (s_i in 1:100) {
  
  target_path_RDS_04_Last <- path_RDS_04_Last %>% stringr::str_subset(., pattern = paste0("_", s_i, ".RDS"))
  print(paste0("read : ", target_path_RDS_04_Last))
  res <- readRDS(target_path_RDS_04_Last)
  
  df_temp <-
    purrr::map_dfr(task_number, 
           ~{res[[.x]] %>% 
              tibble::as_tibble(.) %>% 
              dplyr::mutate(agent = 1:nrow(.)) %>% 
              tidyr::pivot_longer(cols = -agent, names_to = c("V", "trial"), values_to = "choice", 
                                  names_sep = 1L, names_transform = list(Trial = as.integer)) %>% 
              dplyr::mutate(choice = if_else(choice == 2, 0, 1)) %>% # 0: safe, 1: risky
              dplyr::group_by(agent) %>% 
              dplyr::summarise(
                risk_aversion = 1 - mean(choice)
              ) %>% 
              dplyr::ungroup() %>% 
              dplyr::mutate(
                task_i = .x,
                sim_i = s_i)
            }
           )
  
  
  df_04_Last <- dplyr::bind_rows(df_04_Last, df_temp)
  
}

# save as .csv
readr::write_csv(df_04_Last, file = here(simout_Multiple_04_path, "df_04_Last.csv"))
```




```{r, eval=FALSE}
# Simulate 4/0 condition by RunQL_dual()
# Once the simulations are run, you need not run again

simout_Multiple_40_path <- here(simout_Multiple_path, "sim_res_Multiple40")
# dir.create(simout_Multiple_40_path)

trial_N <- 500

#--- agents of the first generation

# simulate the choice for a sampled task & save as .RDS

for (s_i in 1:100) {
  
  print(paste0("sim: ", s_i))
  
  task_struct_40_riskaversion_filtered <-
    task_struct_40_riskaversion %>% 
    dplyr::filter(sim_i == s_i) %>% 
    dplyr::pull(stat_vec)
    
  df_agent_randmulti_40_First_filtered <-
    df_agent_randmulti_40_First %>% 
    dplyr::filter(sim_i == s_i)
  
  # simulate for one task
  res_ql_40_list_First <- purrr::map(task_struct_40_riskaversion_filtered, ~RunQL_dual(df_agent_randmulti_40_First_filtered, .x, trial_N))
  
  res_ql_40_list_choice_First <-
  res_ql_40_list_First %>%
  purrr::map("Choice")

  # save RDS file
  saveRDS(object = res_ql_40_list_choice_First, file = here(simout_Multiple_40_path, paste0( "res_ql_40_list_choice_First_", s_i, ".RDS")))

}


#--- agents of the last generation

# simulate the choice for a sampled task & save as .RDS
for (s_i in 1:100) {
  
  print(paste0("sim: ", s_i))
  
  task_struct_40_riskaversion_filtered <-
    task_struct_40_riskaversion %>% 
    dplyr::filter(sim_i == s_i) %>% 
    dplyr::pull(stat_vec)
    
  df_agent_randmulti_40_Last_filtered <-
    df_agent_randmulti_40_Last %>% 
    dplyr::filter(sim_i == s_i)
  
  # simulate for one task
  res_ql_40_list_Last <- purrr::map(task_struct_40_riskaversion_filtered, ~RunQL_dual(df_agent_randmulti_40_Last_filtered, .x, trial_N))
  
  res_ql_40_list_choice_Last <-
  res_ql_40_list_Last %>%
  purrr::map("Choice")

  # save RDS file
  saveRDS(object = res_ql_40_list_choice_Last, file = here(simout_Multiple_40_path, paste0( "res_ql_40_list_choice_Last_", s_i, ".RDS")))

}


#------ summarize the choice and save as .csv ------#

#--- agents of the first generation

RDS_40_First <- dir(simout_Multiple_40_path, pattern = ".RDS") %>% stringr::str_subset(., pattern = "_First")
path_RDS_40_First <- here(simout_Multiple_40_path, RDS_40_First)

task_number <- 1 # task number is set to process any number of task

# for each simulated data (.RDS), summarize the choice and combine it as one df
df_40_First <- NULL
for (s_i in 1:100) {
  
  target_path_RDS_40_First <- path_RDS_40_First %>% stringr::str_subset(., pattern = paste0("_", s_i, ".RDS"))
  print(paste0("read : ", target_path_RDS_40_First))
  res <- readRDS(target_path_RDS_40_First)
  
  df_temp <-
    purrr::map_dfr(task_number, 
           ~{res[[.x]] %>% 
              tibble::as_tibble(.) %>% 
              dplyr::mutate(agent = 1:nrow(.)) %>% 
              tidyr::pivot_longer(cols = -agent, names_to = c("V", "trial"), values_to = "choice", 
                                  names_sep = 1L, names_transform = list(Trial = as.integer)) %>% 
              dplyr::mutate(choice = if_else(choice == 2, 0, 1)) %>% 
              dplyr::group_by(agent) %>% 
              dplyr::summarise(
                risk_aversion = 1 - mean(choice)
              ) %>% 
              dplyr::ungroup() %>% 
              dplyr::mutate(
                task_i = .x,
                sim_i = s_i)
            }
           )
  
  
  df_40_First <- dplyr::bind_rows(df_40_First, df_temp)
  
}

readr::write_csv(df_40_First, file = here(simout_Multiple_40_path, "df_40_First.csv"))


#--- agents of the last generation

RDS_40_Last <- dir(simout_Multiple_40_path, pattern = ".RDS") %>% stringr::str_subset(., pattern = "_Last")
path_RDS_40_Last <- here(simout_Multiple_40_path, RDS_40_Last)

task_number <- 1 # task number is set to process any number of task

# for each simulated data (.RDS), summarize the choice and combine it as one df
df_40_Last <- NULL
for (s_i in 1:100) {
  
  target_path_RDS_40_Last <- path_RDS_40_Last %>% stringr::str_subset(., pattern = paste0("_", s_i, ".RDS"))
  print(paste0("read : ", target_path_RDS_40_Last))
  res <- readRDS(target_path_RDS_40_Last)
  
  df_temp <-
    purrr::map_dfr(task_number, 
           ~{res[[.x]] %>% 
              tibble::as_tibble(.) %>% 
              dplyr::mutate(agent = 1:nrow(.)) %>% 
              tidyr::pivot_longer(cols = -agent, names_to = c("V", "trial"), values_to = "choice", 
                                  names_sep = 1L, names_transform = list(Trial = as.integer)) %>% 
              dplyr::mutate(choice = if_else(choice == 2, 0, 1)) %>% 
              dplyr::group_by(agent) %>% 
              dplyr::summarise(
                risk_aversion = 1 - mean(choice)
              ) %>% 
              dplyr::ungroup() %>% 
              dplyr::mutate(
                task_i = .x,
                sim_i = s_i)
            }
           )
  
  
  df_40_Last <- dplyr::bind_rows(df_40_Last, df_temp)
  
}

readr::write_csv(df_40_Last, file = here(simout_Multiple_40_path, "df_40_Last.csv"))
```


## make Fig 2c

```{r}
# read additional simulations data & make df

simout_Multiple_path <- here("Data", "Evo_RandMultiTask") # dir for sim multiple-task agents 04 & 40

simout_Multiple_04_path <- here(simout_Multiple_path, "sim_res_Multiple04")
simout_Multiple_40_path <- here(simout_Multiple_path, "sim_res_Multiple40")

df_04_First <- readr::read_csv(here(simout_Multiple_04_path, "df_04_First.csv")) %>% 
  dplyr::mutate(
    sim = "cond_0/4",
    generation = 0,
    task_type = "risk_seeking",
    sim_n = "risk seeking/aversion = 0/4"
  )

df_04_Last <- readr::read_csv(here(simout_Multiple_04_path, "df_04_Last.csv")) %>% 
  dplyr::mutate(
    sim = "cond_0/4",
    generation = 2999,
    task_type = "risk_seeking",
    sim_n = "risk seeking/aversion = 0/4"
  ) 

df_40_First <- readr::read_csv(here(simout_Multiple_40_path, "df_40_First.csv")) %>% 
  dplyr::mutate(
    sim = "cond_4/0",
    generation = 0,
    task_type = "risk_aversion",
    sim_n = "risk seeking/aversion = 4/0"
  )

df_40_Last <- readr::read_csv(here(simout_Multiple_40_path, "df_40_Last.csv")) %>% 
  dplyr::mutate(
    sim = "cond_4/0",
    generation = 2999,
    task_type = "risk_aversion",
    sim_n = "risk seeking/aversion = 4/0"
  )


# simごとに平均を算出 -> 条件ごとに算出
df_agent_randmulti_04_40 <-
  df_04_First %>% 
  dplyr::bind_rows(df_04_Last, df_40_First, df_40_Last)

df_agent_randmulti_summary_04_40 <-
  df_agent_randmulti_04_40 %>% 
  dplyr::group_by(sim, sim_n, sim_i, task_type, task_i, generation) %>% 
  dplyr::summarise(
    mean_risk_aversion = mean(risk_aversion)
  ) %>% 
  dplyr::ungroup()

df_agent_randmulti_simMEAN_04_40 <-
  df_agent_randmulti_summary_04_40 %>% 
  dplyr::group_by(sim, sim_n, generation, task_type) %>% 
  dplyr::summarise(
    MEAN_risk_aversion = mean(mean_risk_aversion),
    SD_risk_aversion = sqrt(variance(mean_risk_aversion)),
    N = n()
  ) %>% 
  dplyr::ungroup()
```


```{r, eval=FALSE, fig.width=20, fig.height=8}
# make Fig 2c (including additional simulations data)

df_agent_randmulti_simMEAN %>% 
  dplyr::bind_rows(df_agent_randmulti_simMEAN_04_40) %>% # additional data of cond 0/4 + 4/0
  
  dplyr::mutate(
    generation = generation + 1,
    task_type_rev = if_else(task_type == "risk_aversion", "risk aversion", "risk seeking")
    ) %>% 
  
  ggplot(aes(x = as.factor(generation), y = MEAN_risk_aversion, color = task_type_rev, group = task_type_rev)) + 
  geom_linerange(aes(ymin = MEAN_risk_aversion - SD_risk_aversion, ymax = MEAN_risk_aversion + SD_risk_aversion), size = 1.5, position = position_dodge(width = 0.5)) + 
  geom_point(size = 3.0, stroke = 1.5, shape = 21, fill = "white", position = position_dodge(width = 0.5)) + 
  my_theme2 + 
  theme(axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title = element_text(size = 26, face = "bold"),
        strip.text.x = element_text(size = 17.5),
        legend.title = element_text(size = 17.5), #change legend title font size
        legend.text = element_text(size = 17),
        plot.tag = element_text(size = 30)
        ) + 
  scale_color_manual(values=c("deepskyblue", "tan3")) + 
  coord_cartesian(ylim = c(0, 1)) + 
  labs(x = "Generation", 
       y = "Rate of risk aversion",
       color = "Task",
       tag = "(c)") + 
  guides(fill = 'none') + 
  facet_wrap(~sim_n, ncol = 5) -> 
  g2_c
  
#ggsave(plot = g, filename = here(output_path, "Fig2c_FirstLastGene_RiskAversion_RandMulti.png"), width = 20.0, height = 6.0, dpi = 400)
```


```{r}
# calculate values for the paper
# mean rate of risk aversion in the first generation of risk-seeking tasks

df_agent_randmulti_simMEAN %>% 
  dplyr::filter(generation == 0) %>% 
  dplyr::filter(task_type == "risk_seeking") %>% 
  dplyr::select(sim, MEAN_risk_aversion) -> 
  x_simMEAN

print(x_simMEAN)

mean(x_simMEAN$MEAN_risk_aversion)
```


# save Fig 2


```{r}
# save Fig 2 (a~c)

g <- g2_a / g2_b / g2_c

ggsave(plot = g, filename = here(output_path, "Fig2.png"), width = 22.0, height = 20.0, dpi = 75)

ggsave(plot = g, filename = here(output_path, "Fig2.tiff"), width = 22.0, height = 20.0, dpi = 75, device = "tiff")
```



# Fig.3 Effect of combination of ap and an on the risk aversion (heatmap)

 
- Heatmap: axis: ap and an values, color: risk aversion rate

```{r} 
# Risk-aversion tasks

## extract the case where risk of risky option = 20
target_sim <- as.factor(c(
 "30.5.10.20", "20.5.0.20", "10.5.-10.20", "0.5.-20.20", "-10.5.-30.20", "-20.5.-40.20", "-30.5.-50.20"
))

g3_1 <- VisHeatmap_RiskAversion(df_withingene, target_sim, "Risk-aversion task")

#ggsave(plot = g, filename = here(output_path, "Fig3.1_Heatmap_RiskAversion_risk-aversion.png"), width = 17.0, height = 4.5, dpi = 400)
```


```{r}
# Risk-seeking tasks

## extract the case where risk of risky option = 20
target_sim <- factor(c(
  "30.5.50.20", "20.5.40.20", "10.5.30.20", "0.5.20.20", "-10.5.10.20", "-20.5.0.20", "-30.5.-10.20"
))

g3_2 <- VisHeatmap_RiskAversion(df_withingene, target_sim, "Risk-seeking task")

#ggsave(plot = g, filename = here(output_path, "Fig3.2_Heatmap_RiskAversion_risk-seeking.png"), width = 17.0, height = 4.5, dpi = 400)
```


```{r}
# save Fig 3
g <- g3_1 / g3_2

ggsave(plot = g, filename = here(output_path, "Fig3.png"), width = 17.0, height = 9.0, dpi = 120)

ggsave(plot = g, filename = here(output_path, "Fig3.tiff"), width = 17.0, height = 9.0, dpi = 120, device = "tiff")
```



# Fig.4a Histogram of risk aversion of the tasks where the expected values are the same

  
- horizontal: risk aversion rate, vertical: frequency


```{r}
df_choice_res_500T_latter100 %>% 
  
  ggplot(aes(x = risk_aversion)) + 
  geom_histogram() + 
  my_theme2 + 
  theme(axis.text.x = element_text(size = 20), 
        axis.text.y = element_text(size = 23), 
        axis.title.x = element_text(size = 30, face = "bold"), 
        axis.title.y = element_text(size = 35, face = "bold"), 
        strip.text.x = element_text(size = 17),
        strip.text.y = element_text(size = 24),
        plot.tag = element_text(size = 40)
        ) + 
  facet_grid(sim_n~task_struct) + 
  labs(x = "Rate of risk aversion", y = "Frequency of agent",
       tag = "(a)") -> 
  g4_a

#ggsave(plot = g, filename = here(output_path, "Fig4a_RiskPref_RandMulti_latter100.png"), width = 17.0, height = 24.0, dpi = 400)
```



# Fig.4b Histogram of difference in gain-loss

  
```{r}
df_choice_gainloss_500T_latter100_last %>% 
  
  ggplot(aes(x = risk_aver_gain_loss)) + geom_histogram() + 
  geom_vline(xintercept = 0, color = "black") + 
  my_theme2 + 
  theme(
    axis.text.x = element_text(size = 20), 
    axis.text.y = element_text(size = 23), 
    axis.title.y = element_text(size = 21, face = "bold"),
    axis.title.x = element_text(size = 21, face = "bold"), 
    strip.text.y = element_text(size = 24),
    plot.tag = element_text(size = 40)
    ) +
  labs(x = "Gain-loss differece in risk aversion", y = "",
       tag = "(b)") + 
  facet_grid(sim_n~.) -> 
  g4_b

#ggsave(plot = g, filename = here(output_path, "Fig4b_RiskPrefDif_RandMulti_latter100_vert.png"), width = 5.5, height = 18.0, dpi = 400)
```


```{r}
# calculate values for the paper
# peak of the histogram

df_choice_gainloss_500T_latter100_last %>% 
  
  dplyr::group_by(sim_n) %>% 
  tidyr::nest() %>% 
  dplyr::mutate(mode_riskavers = purrr::map(data, "risk_aver_gain_loss") %>% purrr::map_dbl(~map_value(.x))) %>% 
  
  dplyr::ungroup() %>% 
  dplyr::select(sim_n, mode_riskavers) %>% 
  formattable::formattable(.)
```



```{r}
# calculate values for the paper
# the rate of gain - loss > 0

df_choice_gainloss_500T_latter100_last %>% 
  
  dplyr::mutate(
    gain_loss_plus = if_else(risk_aver_gain_loss > 0, "gain > loss", "loss > gain")
  ) %>% 
  dplyr::group_by(sim_n, gain_loss_plus) %>% 
  dplyr::summarise(
    n = n(),
    rate = n/100000
  ) %>% 
  dplyr::select(sim_n, gain_loss_plus, rate) %>% 
  dplyr::filter(gain_loss_plus == "gain > loss") %>% 
  formattable::formattable(.)
```


# save Fig 4

```{r}
# save Fig 4
g <- g4_a + g4_b + plot_layout(ncol = 2, widths = c(4, 1))

ggsave(plot = g, filename = here(output_path, "Fig4.png"), width = 23.0, height = 24.0, dpi = 65)

ggsave(plot = g, filename = here(output_path, "Fig4.tiff"), width = 23.0, height = 24.0, dpi = 65, device = "tiff")
```


# Session Info


- RStudio Version：2023.12.1.402
    
    
```{r, eval = FALSE}
RStudio.Version()$version
```

- Packages

```{r}
sessionInfo()

# output

# R version 4.1.0 (2021-05-18)
# Platform: x86_64-apple-darwin17.0 (64-bit)
# Running under: macOS 13.6.7
# 
# Matrix products: default
# LAPACK: /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRlapack.dylib
# 
# locale:
# [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
# 
# attached base packages:
# [1] stats     graphics  grDevices utils     datasets  methods   base     
# 
# other attached packages:
#  [1] patchwork_1.1.1   data.table_1.14.6 here_1.0.1        forcats_0.5.1     stringr_1.4.0     dplyr_1.0.8      
#  [7] purrr_0.3.4       readr_2.1.2       tidyr_1.2.0       tibble_3.1.6      ggplot2_3.3.5     tidyverse_1.3.1  
# 
# loaded via a namespace (and not attached):
#  [1] tidyselect_1.1.2  xfun_0.30         haven_2.4.3       colorspace_2.0-3  vctrs_0.6.5       generics_0.1.2   
#  [7] htmltools_0.5.2   yaml_2.3.5        utf8_1.2.2        rlang_1.1.3       pillar_1.7.0      glue_1.6.2       
# [13] withr_2.5.0       DBI_1.1.2         dbplyr_2.1.1      modelr_0.1.8      readxl_1.4.0      lifecycle_1.0.4  
# [19] munsell_0.5.0     gtable_0.3.0      cellranger_1.1.0  rvest_1.0.2       formattable_0.2.1 htmlwidgets_1.5.4
# [25] evaluate_0.15     knitr_1.38        tzdb_0.3.0        fastmap_1.1.0     fansi_1.0.3       broom_0.7.12     
# [31] backports_1.4.1   scales_1.1.1      jsonlite_1.8.0    fs_1.5.2          hms_1.1.1         digest_0.6.29    
# [37] stringi_1.7.6     rprojroot_2.0.2   grid_4.1.0        cli_3.6.2         tools_4.1.0       magrittr_2.0.2   
# [43] crayon_1.5.1      pkgconfig_2.0.3   ellipsis_0.3.2    xml2_1.3.3        reprex_2.0.1      lubridate_1.8.0  
# [49] assertthat_0.2.1  rmarkdown_2.13    httr_1.4.2        rstudioapi_0.13   R6_2.5.1          compiler_4.1.0
```

