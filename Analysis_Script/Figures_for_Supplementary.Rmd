---
title: "Figures for Supplementary Information"
author: "Shogo Homma"
date: "`r format(Sys.time(), '%Y/%m/%d')`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 2
    theme: spacelab
    highlight: haddock
    fig_caption: yes
    fig_width: 9
    fig_height: 8
    self_contained: true
    md_extensions: -ascii_identifiers
---


# Setup

```{r, include=FALSE}
library(tidyverse)
library(here)
library(data.table)
library(patchwork)
library(gt)
library(webshot2)
```


```{r}
# set the path for saving figs and sim results
output_path <- here("Output", "FiguresForSupplementary")
simout_SameExp_path <- here("Data", "SameExp_Sim_RandMultiTask")

# dir.create(output_path)
# dir.create(simout_SameExp_path)
```


```{r setup knit_environment, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, comment="", warning=FALSE, message=FALSE, fig.align="center", cache=F)
```


## Load functions

```{r}
common_functions_path <- here("Analysis_Script", "_functions_common")
common_functions <- here(common_functions_path, dir(common_functions_path))
purrr::walk(common_functions, ~source(.x))

project_functions_path <- here("Analysis_Script", "_functions_project")
project_functions <- here(project_functions_path, dir(project_functions_path))
purrr::walk(project_functions, ~source(.x))
```


## Load data

### Single-task simulations

```{r}
## load _gene.csv (averaged para info for each generation)

## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name_30_5 <- c(
  "_20191214183504", "_20191214183505", "_20191214183506", "_20191214183507", "_20191214183508",
  "_20191216111051", "_20191216111052", "_20191216111053", "_20191216111054", "_20191216111055",
  "_20191217145232", "_20191217145233", "_20191217145234", "_20191217145235", "_20191217145236",
  "_20191218152742", "_20191218152743", "_20191218152744", "_20191218152745", "_20191218152746")

sim_name_30_5 <- c(
  "30.5.50.30", "30.5.50.25", "30.5.50.20", "30.5.50.15", "30.5.50.10", 
  "30.5.40.30", "30.5.40.25", "30.5.40.20", "30.5.40.15", "30.5.40.10", 
  "30.5.20.30", "30.5.20.25", "30.5.20.20", "30.5.20.15", "30.5.20.10", 
  "30.5.10.30", "30.5.10.25", "30.5.10.20", "30.5.10.15", "30.5.10.10")

pattern_name_20_5 <- c(
  "_20191119144338", "_20191118142201", "_20190916204328", "_20191118142145", "_20191118142115",
  "_20191223104741", "_20191223104742", "_20191223104743", "_20191223104744", "_20191223104745",
  "_20200110152317", "_20200110152318", "_20200110152319", "_20200110152320", "_20200110152321",
  "_20191219134742", "_20191224122806", "_20190916204119", "_20191224122807", "_20191220110720")

sim_name_20_5 <- c(
  "20.5.40.30", "20.5.40.25", "20.5.40.20", "20.5.40.15", "20.5.40.10",
  "20.5.30.30", "20.5.30.25", "20.5.30.20", "20.5.30.15", "20.5.30.10", 
  "20.5.10.30", "20.5.10.25", "20.5.10.20", "20.5.10.15", "20.5.10.10",
  "20.5.0.30", "20.5.0.25", "20.5.0.20", "20.5.0.15", "20.5.0.10")

pattern_name_10_5 <- c(
  "_20191225105829", "_20191225105830", "_20191225105831", "_20191225105832", "_20191226115412",
  "_20200111161131", "_20200111161132", "_20200111161133", "_20200111161134", "_20200111161135", 
  "_20200113142323", "_20200113142324", "_20200113142325", "_20200113142326", "_20200113142327",
  "_20191226115336", "_20191226115337", "_20191226115338", "_20191226115339", "_20191227142311")

sim_name_10_5 <- c(
  "10.5.30.30", "10.5.30.25", "10.5.30.20", "10.5.30.15", "10.5.30.10",
  "10.5.20.30", "10.5.20.25", "10.5.20.20", "10.5.20.15", "10.5.20.10",
  "10.5.0.30", "10.5.0.25", "10.5.0.20", "10.5.0.15", "10.5.0.10",
  "10.5.-10.30", "10.5.-10.25", "10.5.-10.20", "10.5.-10.15", "10.5.-10.10")

pattern_name_0_5 <- c(
  "_20191121180423", "_20191121180252", "_20190916204538", "_20191121180225", "_20191121180208",
  "_20200114122539", "_20200114122540", "_20200114122541", "_20200114122542", "_20200114122543",
  "_20200115150219", "_20200115150220", "_20200115150221", "_20200115150222", "_20200115150223", 
  "_20191224123053", "_20191224123054", "_20190916204210", "_20191224123055", "_20191225105953")

sim_name_0_5 <- c(
  "0.5.20.30", "0.5.20.25", "0.5.20.20", "0.5.20.15", "0.5.20.10",
  "0.5.10.30", "0.5.10.25", "0.5.10.20", "0.5.10.15", "0.5.10.10",
  "0.5.-10.30", "0.5.-10.25", "0.5.-10.20", "0.5.-10.15", "0.5.-10.10",
  "0.5.-20.30", "0.5.-20.25", "0.5.-20.20", "0.5.-20.15", "0.5.-20.10")

pattern_name_minus10_5 <- c(
  "_20191227142546", "_20191227142547", "_20191227142548", "_20191227142549", "_20191228112810",
  "_20200116170128", "_20200116170129", "_20200116170130", "_20200116170131", "_20200116170132",
  "_20200118155206", "_20200118155207", "_20200118155208", "_20200118155209", "_20200118155210",
  "_20191228112846", "_20191228112847", "_20191228112848", "_20191228112849", "_20191228184927")

sim_name_minus10_5 <- c(
  "-10.5.10.30", "-10.5.10.25", "-10.5.10.20", "-10.5.10.15", "-10.5.10.10",
  "-10.5.0.30", "-10.5.0.25", "-10.5.0.20", "-10.5.0.15", "-10.5.0.10",
  "-10.5.-20.30", "-10.5.-20.25", "-10.5.-20.20", "-10.5.-20.15", "-10.5.-20.10",
  "-10.5.-30.30", "-10.5.-30.25", "-10.5.-30.20", "-10.5.-30.15", "-10.5.-30.10")

pattern_name_minus20_5 <- c(
  "_20191219130414", "_20191219130415", "_20190916204750", "_20191219130416", "_20191219130417",
  "_20191221121729", "_20191221121730", "_20191221121731", "_20191221121732", "_20191221121733",
  "_20191222102255", "_20191222102256", "_20191222102257", "_20191222102258", "_20191222102259",
  "_20191220110603", "_20191220110604", "_20191114220026", "_20191220110605", "_20191220110606")

sim_name_minus20_5 <- c(
  "-20.5.0.30", "-20.5.0.25", "-20.5.0.20", "-20.5.0.15", "-20.5.0.10",
  "-20.5.-10.30", "-20.5.-10.25", "-20.5.-10.20", "-20.5.-10.15", "-20.5.-10.10",
  "-20.5.-30.30", "-20.5.-30.25", "-20.5.-30.20", "-20.5.-30.15", "-20.5.-30.10",
  "-20.5.-40.30", "-20.5.-40.25", "-20.5.-40.20", "-20.5.-40.15", "-20.5.-40.10")

pattern_name_minus30_5 <- c(
  "_20191229191133", "_20191229191134", "_20191229191135", "_20191229191136", "_20191229191137",
  "_20220104104342", "_20220104104343", "_20220104104344", "_20220104104345", "_20220104104346", 
  "_20220322151600", "_20220322151601", "_20220322151602", "_20220323153501", "_20220323153502", 
  "_20211230173101", "_20211230173102", "_20211230173103", "_20211230173104", "_20211230173105")

sim_name_minus30_5 <- c(
  "-30.5.-10.30", "-30.5.-10.25", "-30.5.-10.20", "-30.5.-10.15", "-30.5.-10.10",
  "-30.5.-20.30", "-30.5.-20.25", "-30.5.-20.20", "-30.5.-20.15", "-30.5.-20.10",
  "-30.5.-40.30", "-30.5.-40.25", "-30.5.-40.20", "-30.5.-40.15", "-30.5.-40.10",
  "-30.5.-50.30", "-30.5.-50.25", "-30.5.-50.20", "-30.5.-50.15", "-30.5.-50.10")


# unite as a single list

params <- list(
  pattern_name = c(pattern_name_30_5, pattern_name_20_5, pattern_name_10_5, pattern_name_0_5, pattern_name_minus10_5, pattern_name_minus20_5, pattern_name_minus30_5),
  sim_name = c(sim_name_30_5, sim_name_20_5, sim_name_10_5, sim_name_0_5, sim_name_minus10_5, sim_name_minus20_5, sim_name_minus30_5)
  )

DataDir <- "Data"
DataDir_sub <- "Evo_Sim_SingleTask"

# a dataframe for averaged data by generation

df_gene <- purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_gene.csv"))
df_gene_longer <- ConvertDfGeneLonger_MeanSD(df_gene)
```



```{r}
# load GeneAverage_*.csv (averaged beha info for each generation)

df_gene_riskaversion <- 
  purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "GeneAverage_"))

df_gene_riskaversion_mean <- 
  df_gene_riskaversion %>% 
  dplyr::group_by(sim, generation) %>% 
  dplyr::summarise(
    mean_choice1 = mean(MEAN_rate_choice1),
    sd_choice1 = mean(SD_rate_choice1)
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    mean_risk_aversion = 1 - mean_choice1
  ) %>% 
  tidyr::separate(col = "sim", into = c("m2", "sd2", "m1", "sd1"), sep = "\\.", remove = FALSE) %>% 
  dplyr::mutate(
    m1 = as.integer(m1),
    sd1 = as.integer(sd1),
    m2 = as.integer(m2),
    sd2 = as.integer(sd2)
  ) %>% 
  dplyr::mutate(
    discriminability = EffectSize(m1, sd1, m2, sd2),
    task_exp = paste(m1, " vs ", m2, sep = "")
  ) %>% 
  dplyr::arrange(desc(discriminability))

```


```{r, eval=FALSE}
##--- when running this chunck, the comment # should be removed

##--- load first_lastgene.csv
##--- Preparation for making df_first_last_single_XXX

# DataDir <- "Data"
# DataDir_sub <- "Evo_Sim_SingleTask"
# 
# df_first_last_single <- 
#   purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "first_lastgene.csv"))
# 
# df_first_last_single_rev <-
#   df_first_last_single %>% 
#   dplyr::select(sim, replication, generation, agent, ap, an, bt, rate_choice1) %>% 
#   dplyr::mutate(
#     relative_an_ap = (an - ap)/(an + ap) # relative_an_ap = Niv index
#   ) 


##--- saving df_first_last_single_ as RDS file

##--- Risk-seeking task # only D = 20

# target_simexp <- c("30.5.50.30", "30.5.50.25", "30.5.50.20", "30.5.50.15", "30.5.50.10",
#                    "20.5.40.30", "20.5.40.25", "20.5.40.20", "20.5.40.15", "20.5.40.10",
#                    "10.5.30.30", "10.5.30.25", "10.5.30.20", "10.5.30.15", "10.5.30.10",
#                    "0.5.20.30", "0.5.20.25", "0.5.20.20", "0.5.20.15", "0.5.20.10",
#                    "-10.5.10.30", "-10.5.10.25", "-10.5.10.20", "-10.5.10.15", "-10.5.10.10",
#                    "-20.5.0.30", "-20.5.0.25", "-20.5.0.20", "-20.5.0.15", "-20.5.0.10",
#                    "-30.5.-10.30", "-30.5.-10.25", "-30.5.-10.20", "-30.5.-10.15", "-30.5.-10.10")
#
# df_first_last_single_riskseek_D20 <-
#   df_first_last_single_rev %>% 
#   dplyr::filter(sim %in% target_simexp) %>% 
#   tidyr::separate(col = "sim", into = c("m2", "sd2", "m1", "sd1"), sep = "\\.", remove = FALSE) %>% 
#   dplyr::mutate(
#     m1 = as.integer(m1),
#     sd1 = as.integer(sd1),
#     m2 = as.integer(m2),
#     sd2 = as.integer(sd2)
#   ) %>% 
#   dplyr::mutate(
#     task_exp = paste0(m1, " vs ", m2),
#     generation = generation + 1
#   )
# 
# DataDir <- "Data"
# DataDir_sub <- "Evo_Sim_SingleTask"
# saveRDS(df_first_last_single_riskseek_D20, file = here(DataDir, DataDir_sub, "df_first_last_single_riskseek_D20.RDS"))


##--- Risk-seeking task # only D = 10

# target_simexp <- c("30.5.40.30", "30.5.40.25", "30.5.40.20", "30.5.40.15", "30.5.40.10",
#                    "20.5.30.30", "20.5.30.25", "20.5.30.20", "20.5.30.15", "20.5.30.10",
#                    "10.5.20.30", "10.5.20.25", "10.5.20.20", "10.5.20.15", "10.5.20.10",
#                    "0.5.10.30", "0.5.10.25", "0.5.10.20", "0.5.10.15", "0.5.10.10",
#                    "-10.5.0.30", "-10.5.0.25", "-10.5.0.20", "-10.5.0.15", "-10.5.0.10",
#                    "-20.5.-10.30", "-20.5.-10.25", "-20.5.-10.20", "-20.5.-10.15", "-20.5.-10.10",
#                    "-30.5.-20.30", "-30.5.-20.25", "-30.5.-20.20", "-30.5.-20.15", "-30.5.-20.10")
#
# df_first_last_single_riskseek_D10 <-
#   df_first_last_single_rev %>%
#   dplyr::filter(sim %in% target_simexp) %>%
#   tidyr::separate(col = "sim", into = c("m2", "sd2", "m1", "sd1"), sep = "\\.", remove = FALSE) %>%
#   dplyr::mutate(
#     m1 = as.integer(m1),
#     sd1 = as.integer(sd1),
#     m2 = as.integer(m2),
#     sd2 = as.integer(sd2)
#   ) %>%
#   dplyr::mutate(
#     task_exp = paste0(m1, " vs ", m2),
#     generation = generation + 1
#   )
# 
# DataDir <- "Data"
# DataDir_sub <- "Evo_Sim_SingleTask"
# saveRDS(df_first_last_single_riskseek_D10, file = here(DataDir, DataDir_sub, "df_first_last_single_riskseek_D10.RDS"))


## Risk-aversion task # only D = -20

# target_simexp <- c("30.5.10.30", "30.5.10.25", "30.5.10.20", "30.5.10.15", "30.5.10.10",
#                    "20.5.0.30", "20.5.0.25", "20.5.0.20", "20.5.0.15", "20.5.0.10",
#                    "10.5.-10.30", "10.5.-10.25", "10.5.-10.20", "10.5.-10.15", "10.5.-10.10",
#                    "0.5.-20.30", "0.5.-20.25", "0.5.-20.20", "0.5.-20.15", "0.5.-20.10",
#                    "-10.5.-30.30", "-10.5.-30.25", "-10.5.-30.20", "-10.5.-30.15", "-10.5.-30.10",
#                    "-20.5.-40.30", "-20.5.-40.25", "-20.5.-40.20", "-20.5.-40.15", "-20.5.-40.10",
#                    "-30.5.-50.30", "-30.5.-50.25", "-30.5.-50.20", "-30.5.-50.15", "-30.5.-50.10")
#
# df_first_last_single_riskaverse_D20 <-
#   df_first_last_single_rev %>% 
#   dplyr::filter(sim %in% target_simexp) %>% 
#   tidyr::separate(col = "sim", into = c("m2", "sd2", "m1", "sd1"), sep = "\\.", remove = FALSE) %>% 
#   dplyr::mutate(
#     m1 = as.integer(m1),
#     sd1 = as.integer(sd1),
#     m2 = as.integer(m2),
#     sd2 = as.integer(sd2)
#   ) %>% 
#   dplyr::mutate(
#     task_exp = paste0(m1, " vs ", m2),
#     generation = generation + 1
#   )
# 
# DataDir <- "Data"
# DataDir_sub <- "Evo_Sim_SingleTask"
# saveRDS(df_first_last_single_riskaverse_D20, file = here(DataDir, DataDir_sub, "df_first_last_single_riskaverse_D20.RDS"))


## Risk-averse task # only D = -10

# target_simexp <- c("30.5.20.30", "30.5.20.25", "30.5.20.20", "30.5.20.15", "30.5.20.10",
#                    "20.5.10.30", "20.5.10.25", "20.5.10.20", "20.5.10.15", "20.5.10.10",
#                    "10.5.0.30", "10.5.0.25", "10.5.0.20", "10.5.0.15", "10.5.0.10",
#                    "0.5.-10.30", "0.5.-10.25", "0.5.-10.20", "0.5.-10.15", "0.5.-10.10",
#                    "-10.5.-20.30", "-10.5.-20.25", "-10.5.-20.20", "-10.5.-20.15", "-10.5.-20.10",
#                    "-20.5.-30.30", "-20.5.-30.25", "-20.5.-30.20", "-20.5.-30.15", "-20.5.-30.10",
#                    "-30.5.-40.30", "-30.5.-40.25", "-30.5.-40.20", "-30.5.-40.15", "-30.5.-40.10")
#
# df_first_last_single_riskaverse_D10 <-
#   df_first_last_single_rev %>%
#   dplyr::filter(sim %in% target_simexp) %>%
#   tidyr::separate(col = "sim", into = c("m2", "sd2", "m1", "sd1"), sep = "\\.", remove = FALSE) %>%
#   dplyr::mutate(
#     m1 = as.integer(m1),
#     sd1 = as.integer(sd1),
#     m2 = as.integer(m2),
#     sd2 = as.integer(sd2)
#   ) %>%
#   dplyr::mutate(
#     task_exp = paste0(m1, " vs ", m2),
#     generation = generation + 1
#   )
# 
# DataDir <- "Data"
# DataDir_sub <- "Evo_Sim_SingleTask"
# saveRDS(df_first_last_single_riskaverse_D10, file = here(DataDir, DataDir_sub, "df_first_last_single_riskaverse_D10.RDS"))
```


```{r}
# load df_first_last_single_.RDS
# these dataframes are mainly used for Figs of S17-19

DataDir <- "Data"
DataDir_sub <- "Evo_Sim_SingleTask"

df_first_last_single_riskaverse_D20 <- readRDS(file = here(DataDir, DataDir_sub, "df_first_last_single_riskaverse_D20.RDS")) %>% 
  dplyr::mutate(
    task_sd = paste0("Variance of Risky Option = ", sd1),
    rate_risk_aversion = 1-rate_choice1
    )

df_first_last_single_riskaverse_D10 <- readRDS(file = here(DataDir, DataDir_sub, "df_first_last_single_riskaverse_D10.RDS")) %>% 
  dplyr::mutate(
    task_sd = paste0("Variance of Risky Option = ", sd1),
    rate_risk_aversion = 1-rate_choice1
    )
  

df_first_last_single_riskseek_D20 <- readRDS(file = here(DataDir, DataDir_sub, "df_first_last_single_riskseek_D20.RDS")) %>% 
  dplyr::mutate(
    task_sd = paste0("Variance of Risky Option = ", sd1),
    rate_risk_aversion = 1-rate_choice1
    )

df_first_last_single_riskseek_D10 <- readRDS(file = here(DataDir, DataDir_sub, "df_first_last_single_riskseek_D10.RDS")) %>% 
  dplyr::mutate(
    task_sd = paste0("Variance of Risky Option = ", sd1),
    rate_risk_aversion = 1-rate_choice1
    )
```


```{r}
# remove vectors above
rm(list = ls()[stringr::str_starts(string = ls(), pattern = "pattern_name")])
rm(list = ls()[stringr::str_starts(string = ls(), pattern = "sim_name")])
```


### Data of effect of learning rates in the single task (heatmap)


```{r}
## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name_30_5 <- c(
  "_20201227183815", "_20201227191810", "_20201227191811", "_20201227191812", "_20201227191813",
  "_20201227183031", "_20201227183152", "_20201227183354", "_20201227183600", "_20201227183713"
  )

sim_name_30_5 <- c(
  "30.5.50.30", "30.5.50.25", "30.5.50.20", "30.5.50.15", "30.5.50.10",
  "30.5.10.30", "30.5.10.25", "30.5.10.20", "30.5.10.15", "30.5.10.10"
  )

pattern_name_20_5 <- c(
  "_20191229145232", "_20191229145233", "_20191023105942", "_20191229145234", "_20191229145235",
  "_20191229152907", "_20191229152908", "_20191023145842", "_20191229152909", "_20191229152910"
  )

sim_name_20_5 <- c(
  "20.5.40.30", "20.5.40.25", "20.5.40.20", "20.5.40.15", "20.5.40.10",
  "20.5.0.30", "20.5.0.25", "20.5.0.20", "20.5.0.15", "20.5.0.10"
  )

pattern_name_10_5 <- c(
  "_20200108205820", "_20200108205821", "_20200108205822", "_20200108205823", "_20200108205824",
  "_20200109143326", "_20200109143327", "_20200109143328", "_20200109143329", "_20200109143330"
  )

sim_name_10_5 <- c(
  "10.5.30.30", "10.5.30.25", "10.5.30.20", "10.5.30.15", "10.5.30.10",
  "10.5.-10.30", "10.5.-10.25", "10.5.-10.20", "10.5.-10.15", "10.5.-10.10"
  )

pattern_name_0_5 <- c(
  "_20191229161041", "_20191229161042", "_20191023141508", "_20191229161043", "_20191229161044",
  "_20191229164648", "_20191229164649", "_20191023145854", "_20191229164650", "_20191229164651"
  )

sim_name_0_5 <- c(
  "0.5.20.30", "0.5.20.25", "0.5.20.20", "0.5.20.15", "0.5.20.10",
  "0.5.-20.30", "0.5.-20.25", "0.5.-20.20", "0.5.-20.15", "0.5.-20.10"
  )

pattern_name_minus10_5 <- c(
  "_20200109152359", "_20200109152360", "_20200109152361", "_20200109152362", "_20200109152363",
  "_20200109161034", "_20200109161035", "_20200109161036", "_20200109161037", "_20200109161038"
  )

sim_name_minus10_5 <- c(
  "-10.5.10.30", "-10.5.10.25", "-10.5.10.20", "-10.5.10.15", "-10.5.10.10",
  "-10.5.-30.30", "-10.5.-30.25", "-10.5.-30.20", "-10.5.-30.15", "-10.5.-30.10"
  )

pattern_name_minus20_5 <- c(
  "_20191229172653", "_20191229172654", "_20191023141626", "_20191229172655", "_20191229172656",
  "_20191229181936", "_20191229181937", "_20191229181938", "_20191229181939", "_20191229181940"
  )

sim_name_minus20_5 <- c(
  "-20.5.0.30", "-20.5.0.25", "-20.5.0.20", "-20.5.0.15", "-20.5.0.10",
  "-20.5.-40.30", "-20.5.-40.25", "-20.5.-40.20", "-20.5.-40.15", "-20.5.-40.10"
  )

pattern_name_minus30_5 <- c(
  "_20220323182716", "_20220323182717", "_20220323182718", "_20220323182719", "_20220323182720",
  "_20201227192101", "_20201227192253", "_20201227195149", "_20201227195150", "_20201227195151"
  )

sim_name_minus30_5 <- c(
  "-30.5.-50.30", "-30.5.-50.25", "-30.5.-50.20", "-30.5.-50.15", "-30.5.-50.10",
  "-30.5.-10.30", "-30.5.-10.25", "-30.5.-10.20", "-30.5.-10.15", "-30.5.-10.10"
  )


# unite as a single list

params <- list(
  pattern_name = c(pattern_name_30_5, pattern_name_20_5, pattern_name_10_5, pattern_name_0_5, pattern_name_minus10_5, pattern_name_minus20_5, pattern_name_minus30_5),
  sim_name = c(sim_name_30_5, sim_name_20_5, sim_name_10_5, sim_name_0_5, sim_name_minus10_5, sim_name_minus20_5, sim_name_minus30_5)
  )


# remove vectors above
rm(list = ls()[stringr::str_starts(string = ls(), pattern = "pattern_name")])
rm(list = ls()[stringr::str_starts(string = ls(), pattern = "sim_name")])

# dfを作成
DataDir <- "Data"
DataDir_sub <- "WithinGeneration_Sim_SingleTask"

df_withingene <- purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDfWithinGene(.x, .y, DataDir, DataDir_sub, "_nat.csv"))


# averaged across replication -> df_withingene_riskaverse_summary
df_withingene %>% 
  dplyr::mutate(
    ap = round(ap, 4),
    an = round(an, 4),
    bt = round(bt, 4),
    rate_risk_aversion = 1 - choice_rate1
  ) %>% 
  dplyr::group_by(sim, m2, sd2, m1, sd1, ap, an, bt) %>% 
  dplyr::summarise(
    mean_pvalue = mean(average_pvalue), 
    sd_pvalue = sqrt(variance(average_pvalue)),
    mean_risk_aversion = mean(rate_risk_aversion),
    sd_risk_aversion = sqrt(variance(rate_risk_aversion))
  ) %>% 
  dplyr::ungroup() ->
  df_withingene_riskaverse_summary

```


### Multiple-task simulation (random tasks)


```{r}
# create dataframes for task info


## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name <- c("_20220905162206", "_20220909161625", "_20220919103516", "_20220921105827", "_20220923105509")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

params <- list(
  pattern_name = pattern_name,
  sim_name = sim_name
)

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"


df_randmulti_taskinfo <- 
  purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_task.csv")) %>% 
  dplyr::mutate(
    area_rate = (pnorm(0, m1, sd1) + pnorm(0, m2, sd2))/2,
    eff_size = EffectSize(m1, sd1, m2, sd2)
    ) %>% 
  dplyr::mutate(
    posi_nega = case_when(
      (m1 > 0) & (m2 > 0) ~ "posi",
      (m1 < 0) & (m2 < 0) ~ "nega",
      TRUE ~ "other"
    ),
    task_type = case_when(
      m1 > m2 ~ "risk_seeking",
      m2 > m1 ~ "risk_aversion"
    ),
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  )

df_randmulti_taskgroup <- 
  purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_taskgroup.csv")) %>% 
  dplyr::mutate(area_rate = (pnorm(0, m1, sd1) + pnorm(0, m2, sd2))/2) %>% 
  dplyr::mutate(
    posi_nega = case_when(
      (m1 > 0) & (m2 > 0) ~ "posi",
      (m1 < 0) & (m2 < 0) ~ "nega",
      TRUE ~ "other"
    ),
    task_type = case_when(
      m1 > m2 ~ "risk_seeking",
      m2 > m1 ~ "risk_aversion"
    ),
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  )


# calculate the averaged effect size and negative area for each sim
df_randmulti_taskinfo %>% 
  dplyr::group_by(sim, sim_n, sim_i) %>% 
  dplyr::summarise(
    mean_eff_size = mean(eff_size),
    mean_area_rate = mean(area_rate)
  ) %>% 
  dplyr::ungroup() ->
  df_randmulti_mean_taskinfo
```


```{r}
# load _gene.csv

## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name <- c("_20220905162206", "_20220909161625", "_20220919103516", "_20220921105827", "_20220923105509")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

params <- list(
  pattern_name = pattern_name,
  sim_name = sim_name
)

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"

df_gene_randmulti <- purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_gene.csv"))

df_gene_randmulti %>% 
  dplyr::group_by(sim, generation) %>% 
  dplyr::summarise(
    MEAN_ap = mean(mean_ap),
    MEAN_an = mean(mean_an),
    MEAN_bt = mean(mean_bt)
  ) %>% 
  dplyr::ungroup() -> 
  df_gene_randmulti_summary


# combine para df (filtered by last generation) and task info
df_gene_randmulti %>% 
  dplyr::filter(generation == 2999) %>% 
  dplyr::full_join(df_randmulti_mean_taskinfo, by = c("sim", "sim_i")) ->
  df_gene_randmulti_taskinfo


# df for overall summary
df_gene_randmulti %>% 
  dplyr::group_by(sim, generation) %>% 
  dplyr::summarise(
    MEAN_ap = mean(mean_ap),
    MEAN_an = mean(mean_an),
    MEAN_bt = mean(mean_bt)
  ) %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_longer(cols = -c(sim, generation), names_to = c("stat", "para"), names_sep = "_") %>% 
  tidyr::pivot_wider(names_from = stat, values_from = value) -> 
  df_gene_randmulti_summary_longer

df_gene_randmulti %>% 
  tidyr::pivot_longer(cols = -c(sim, sim_i, generation), names_to = c("stat", "para"), names_sep = "_") %>% 
  tidyr::pivot_wider(names_from = stat, values_from = value) ->
  df_gene_randmulti_longer

df_gene_randmulti_longer %>% 
  dplyr::filter(generation == 2999) %>% 
  dplyr::full_join(df_randmulti_mean_taskinfo, by = c("sim", "sim_i")) ->
  df_gene_randmulti_taskinfo_longer
```


```{r}
# --- Before running this code, you should run and generate df_beha_agent_randmulti_XX.RDS in Figures_for_Paper.Rmd ----

# load df_beha_agent_randmulti_XX.RDS & create df_agent_randmulti_summary etc.

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"

names_randmulti_rds <- c("df_agent_randmulti_22.RDS", "df_agent_randmulti_13.RDS", "df_agent_randmulti_31.RDS",  "df_agent_randmulti_04.RDS", "df_agent_randmulti_40.RDS")

df_agent_randmulti <-
  purrr::map_dfr(names_randmulti_rds, ~readRDS(here(DataDir, DataDir_sub, .x)))


# create _summary dataframe
df_agent_randmulti %>% 
  dplyr::group_by(sim, sim_i, task_i, generation) %>%
  dplyr::summarise(
    MEAN_payoff = mean(mean_payoff),
    SD_payoff = sqrt(variance(mean_payoff)),
    MEAN_rate_choice1 = mean(rate_choice1),
    SD_rate_choice1 = sqrt(variance(rate_choice1))
  ) %>%
  dplyr::ungroup() %>% 
  dplyr::mutate(
    mean_risk_aversion = 1 - MEAN_rate_choice1
  ) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) ->
  df_agent_randmulti_summary


# combine _summary with taskinfo

df_randmulti_taskinfo %>% 
  dplyr::full_join(df_agent_randmulti_summary, by = c("sim_n", "sim", "sim_i", "task_i")) ->
  df_agent_randmulti_summary


# summmarise by sim & generation

df_agent_randmulti_summary %>%
  dplyr::group_by(sim, generation, task_type) %>%
  dplyr::summarise(
    MEAN_risk_aversion = mean(mean_risk_aversion),
    SD_risk_aversion = sqrt(variance(mean_risk_aversion)),
    N = n()
  ) %>%
  dplyr::ungroup() %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) ->
  df_agent_randmulti_simMEAN


# add task number
df_agent_randmulti_summary %>% 
  dplyr::group_by(generation, task_number) %>% 
  tidyr::nest() -> 
  nested_df

nested_df %>% 
  .$data %>% 
  purrr::map(., ~dplyr::mutate(.x, task_n_count = 1:nrow(.x))) -> 
  data_new
  
nested_df$data_new <- data_new

nested_df %>% 
  tidyr::unnest(data_new) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(-data) %>% 
  dplyr::mutate(
    task_n_sequence = factor(paste0(task_number, "-", task_n_count)) %>% forcats::fct_reorder(., task_number)
  ) ->
  df_agent_randmulti_summary_bytask


# add sim number
df_agent_randmulti_summary %>% 
  dplyr::group_by(sim_n, sim, generation, sim_i) %>% 
  dplyr::mutate(
    task_i_rev = task_i + 1
  ) %>% 
  dplyr::mutate(
    sim_n_sequence = factor(paste0(sim_i, "-", task_i_rev)) %>% forcats::fct_reorder(., sim_i)
  ) %>% 
  dplyr::ungroup() ->
  df_agent_randmulti_summary_bysim
```


```{r}
# ----- df for relative an ap -----

df_agent_randmulti_an_ap <-
  df_agent_randmulti %>% 
  dplyr::filter(task_i == 0) %>% # only one task is adequate
  dplyr::mutate(
    relative_an_ap = (an - ap)/(an + ap) # Niv index
  ) %>% 
  dplyr::full_join(df_randmulti_mean_taskinfo, by = c("sim", "sim_i"))


# summarise by agent -> unused in this script

# df_agent_randmulti_summary_byagent <-
#   df_agent_randmulti %>% 
#   dplyr::full_join(df_randmulti_taskinfo, by = c("sim", "sim_i", "task_i")) %>% 
#   dplyr::mutate(
#     rate_risk_aversion = 1 - rate_choice1,
#     relative_an_ap = (an - ap)/(an + ap)
#   ) %>% 
#   dplyr::group_by(sim, sim_i, generation, task_type, agent, relative_an_ap) %>%
#   dplyr::summarise(
#     mean_risk_aversion = mean(rate_risk_aversion)
#   ) %>% 
#   dplyr::ungroup()
```
 
 

```{r, eval=FALSE}
# load _trial.csv.gz (trial-by-trial data of the first and last generation)

## Because the size of _trial.csv is big, we create another object for containing only the info of the first and last generation (the .RDS file below).

## This process takes much time and memory. So, once the .RDS file is created, you should not run this chunk again. 

## The main code is temporarily commented out in case that you run this chunk mistakenly. If you want to run, the comment should be removed. 


## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name <- c("_20220905162206", "_20220909161625", "_20220919103516", "_20220921105827", "_20220923105509")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"

Extract_SimN <- 100

# df_beha_trial_randmulti_summary <- purrr::map2_dfr(pattern_name, sim_name, ~MakeDfTrial_Rand(.x, .y, DataDir, DataDir_sub, "_trial.csv.gz", Extract_SimN))
# 
# 
# # combine df trial with task info
# 
# df_randmulti_taskinfo %>%
#   dplyr::full_join(df_beha_trial_randmulti_summary, by = c("sim", "sim_i", "task_i")) %>%
#   dplyr::mutate(
#     sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
#   ) ->
#   df_beha_trial_randmulti_summary
# 
# saveRDS(df_beha_trial_randmulti_summary, file = here(DataDir, DataDir_sub, "df_beha_trial_randmulti_summary.RDS"))
```


```{r}
# ------ load _trial.csv data from .RDS file ------ #

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"

df_beha_trial_randmulti_summary <- readRDS(here(DataDir, DataDir_sub, "df_beha_trial_randmulti_summary.RDS"))

df_beha_trial_randmulti_summary %>% 
  dplyr::group_by(sim_n, generation, trial, task_type) %>% # sim_i間の平均とSDを計算する
  dplyr::summarise(
    MEAN_risk_aversion = mean(mean_risk_aversion),
    SD_risk_aversion = sqrt(variance(mean_risk_aversion)) # sim_i間のSD
  ) -> 
df_trial_randmulti_simMEAN
```


### Tasks where the expected values are the same (two learning rates)


#### Run simiulations

  
- Simulations of tasks where the expected values are the same (two learning rates) are run in Figures_for_Paper.Rmd.


```{r}
# --- Before running this code, you should run and generate df_beha_agent_randmulti_XX.RDS in Figures_for_Paper.Rmd ----

# load df_beha_agent_randmulti.RDS
# -> create and save df_para_agent_randmulti_FirstLastGene.RDS

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask"

names_randmulti_rds <- c("df_agent_randmulti_22.RDS", "df_agent_randmulti_13.RDS", "df_agent_randmulti_31.RDS", "df_agent_randmulti_04.RDS", "df_agent_randmulti_40.RDS")

df_agent_randmulti <-
  purrr::map_dfr(names_randmulti_rds, ~readRDS(here(DataDir, DataDir_sub, .x)))

df_para_agent_randmulti_FirstLastGene <-
  df_agent_randmulti %>%
  dplyr::filter(task_i == 0) %>%  # one task is adequate
  dplyr::select(sim, sim_i, generation, agent, ap, an, bt)
  
# saveRDS(df_para_agent_randmulti_FirstLastGene, file = here(DataDir, DataDir_sub, "df_para_agent_randmulti_FirstLastGene.RDS"))
```


#### Load simulations results


```{r}
# load 500-trials simulation, last 100-trials data
df_choice_res_500T_latter100 <- readRDS(file = here(simout_SameExp_path, "df_choice_res_500T_lat.RDS"))
```


```{r}
df_choice_res_500T_latter100 %>% 
  
  dplyr::filter(generation == 0) %>% 
  
  dplyr::mutate(gain_loss = if_else(task == 1 | task == 2, "gain", "loss")) %>% 
  dplyr::group_by(sim_n, sim_i, agent, ap, an, bt, an_ap, gain_loss) %>% 
  dplyr::summarise(
    mean_risk_aversion = mean(risk_aversion)
  ) %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(id_cols = c(sim_n, sim_i, agent, ap, an, bt, an_ap), names_from = gain_loss, values_from = mean_risk_aversion) %>% 
  dplyr::mutate(
    risk_aver_gain_loss = gain - loss
  ) ->
  df_choice_gainloss_500T_latter100_first


df_choice_res_500T_latter100 %>% 
  
  dplyr::filter(generation == 2999) %>% 
  
  dplyr::mutate(gain_loss = if_else(task == 1 | task == 2, "gain", "loss")) %>% 
  dplyr::group_by(sim_n, sim_i, agent, ap, an, bt, an_ap, gain_loss) %>% 
  dplyr::summarise(
    mean_risk_aversion = mean(risk_aversion)
  ) %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(id_cols = c(sim_n, sim_i, agent, ap, an, bt, an_ap), names_from = gain_loss, values_from = mean_risk_aversion) %>% 
  dplyr::mutate(
    risk_aver_gain_loss = gain - loss # calculate gain-loss difference
  ) ->
  df_choice_gainloss_500T_latter100_last
```


### Model with the single learning rate


```{r}
# create dataframes for task info


## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name <- c("_20230221152956", "_20230223100048", "_20230223222143", "_20230224180738", "_20230225091934")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

params <- list(
  pattern_name = pattern_name,
  sim_name = sim_name
)

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask_SingleLR"

df_randmulti_taskinfo_sLR <- 
  purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_task.csv")) %>% 
  dplyr::mutate(
    area_rate = (pnorm(0, m1, sd1) + pnorm(0, m2, sd2))/2,
    eff_size = EffectSize(m1, sd1, m2, sd2)
    ) %>% 
  dplyr::mutate(
    posi_nega = case_when(
      (m1 > 0) & (m2 > 0) ~ "posi",
      (m1 < 0) & (m2 < 0) ~ "nega",
      TRUE ~ "other"
    ),
    task_type = case_when(
      m1 > m2 ~ "risk_seeking",
      m2 > m1 ~ "risk_aversion"
    ),
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
    )

df_randmulti_taskgroup_sLR <- 
  purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_taskgroup.csv")) %>% 
  dplyr::mutate(area_rate = (pnorm(0, m1, sd1) + pnorm(0, m2, sd2))/2) %>% 
  dplyr::mutate(
    posi_nega = case_when(
      (m1 > 0) & (m2 > 0) ~ "posi",
      (m1 < 0) & (m2 < 0) ~ "nega",
      TRUE ~ "other"
    ),
    task_type = case_when(
      m1 > m2 ~ "risk_seeking",
      m2 > m1 ~ "risk_aversion"
    ),
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
    )


# calculate the averaged effect size and negative area for each sim
df_randmulti_taskinfo_sLR %>% 
  dplyr::group_by(sim, sim_i) %>% 
  dplyr::summarise(
    mean_eff_size = mean(eff_size),
    mean_area_rate = mean(area_rate)
  ) %>% 
  dplyr::ungroup() ->
  df_randmulti_mean_taskinfo_sLR
```


```{r}
# load _gene.csv


## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name <- c("_20230221152956", "_20230223100048", "_20230223222143", "_20230224180738", "_20230225091934")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

params <- list(
  pattern_name = pattern_name,
  sim_name = sim_name
)

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask_SingleLR"

df_gene_randmulti_sLR <- purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_gene.csv"))

df_gene_randmulti_sLR %>% 
  dplyr::group_by(sim, generation) %>% 
  dplyr::summarise(
    MEAN_alpha = mean(mean_alpha),
    MEAN_bt = mean(mean_bt)
  ) %>% 
  dplyr::ungroup() -> 
  df_gene_randmulti_sLR_summary


# combine para df (filtered by last generation) with task info
df_gene_randmulti_sLR %>% 
  dplyr::filter(generation == 2999) %>% 
  dplyr::full_join(df_randmulti_mean_taskinfo_sLR, by = c("sim", "sim_i")) ->
  df_gene_randmulti_sLR_taskinfo


# df for overall summary
df_gene_randmulti_sLR %>% 
  dplyr::group_by(sim, generation) %>% 
  dplyr::summarise(
    MEAN_alpha = mean(mean_alpha),
    MEAN_bt = mean(mean_bt)
  ) %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_longer(cols = -c(sim, generation), names_to = c("stat", "para"), names_sep = "_") %>% 
  tidyr::pivot_wider(names_from = stat, values_from = value) -> 
  df_gene_randmulti_sLR_summary_longer

df_gene_randmulti_sLR %>% 
  tidyr::pivot_longer(cols = -c(sim, sim_i, generation), names_to = c("stat", "para"), names_sep = "_") %>% 
  tidyr::pivot_wider(names_from = stat, values_from = value) ->
  df_gene_randmulti_sLR_longer

df_gene_randmulti_sLR_longer %>% 
  dplyr::filter(generation == 2999) %>% 
  dplyr::full_join(df_randmulti_mean_taskinfo_sLR, by = c("sim", "sim_i")) ->
  df_gene_randmulti_sLR_taskinfo_longer
```


```{r, eval=FALSE}
# load _nat.csv.gz (averaged info for each agent)

## Because the size of _nat.csv is big, we create another object for containing only the info of the first and last generation (the .RDS file below).

## This process takes much time and memory. So, once the .RDS file is created, you should not run this chunk again. 

## The main code is temporarily commented out in case that you run this chunk mistakenly. If you want to run, the comment # should be removed. 


## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name <- c("_20230221152956", "_20230223100048", "_20230223222143", "_20230224180738", "_20230225091934")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")


DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask_SingleLR"

AgentN <- 1000
GeneN <- 3000
TaskN <- 4
Extract_SimN <- 100


# # save agent data for each condition

# df_agent_randmulti_sLR_22 <- MakeDfNat_Rand(pattern_name[1], sim_name[1], DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)
# saveRDS(df_agent_randmulti_sLR_22, file = here(DataDir, DataDir_sub, "df_agent_randmulti_sLR_22.RDS"))
# 
# df_agent_randmulti_sLR_13 <- MakeDfNat_Rand(pattern_name[2], sim_name[2], DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)
# saveRDS(df_agent_randmulti_sLR_13, file = here(DataDir, DataDir_sub, "df_agent_randmulti_sLR_13.RDS"))
# 
# df_agent_randmulti_sLR_31 <- MakeDfNat_Rand(pattern_name[3], sim_name[3], DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)
# saveRDS(df_agent_randmulti_sLR_31, file = here(DataDir, DataDir_sub, "df_agent_randmulti_sLR_31.RDS"))
# 
# df_agent_randmulti_sLR_04 <- MakeDfNat_Rand(pattern_name[4], sim_name[4], DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)
# saveRDS(df_agent_randmulti_sLR_04, file = here(DataDir, DataDir_sub, "df_agent_randmulti_sLR_04.RDS"))
# 
# df_agent_randmulti_sLR_40 <- MakeDfNat_Rand(pattern_name[5], sim_name[5], DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)
# saveRDS(df_agent_randmulti_sLR_40, file = here(DataDir, DataDir_sub, "df_agent_randmulti_sLR_40.RDS"))
```



```{r, eval=FALSE}
# ------ load _nat.csv data from .RDS file ------ #

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask_SingleLR"

names_randmulti_sLR_rds <- c("df_agent_randmulti_sLR_22.RDS", "df_agent_randmulti_sLR_13.RDS", "df_agent_randmulti_sLR_31.RDS", "df_agent_randmulti_sLR_04.RDS", "df_agent_randmulti_sLR_40.RDS")

df_agent_randmulti_sLR <-
  purrr::map_dfr(names_randmulti_sLR_rds, ~readRDS(here(DataDir, DataDir_sub, .x)))


# create _summary dataframe

df_agent_randmulti_sLR %>% 
  dplyr::group_by(sim, sim_i, task_i, generation) %>%
  dplyr::summarise(
    MEAN_payoff = mean(mean_payoff),
    SD_payoff = sqrt(variance(mean_payoff)),
    MEAN_rate_choice1 = mean(rate_choice1),
    SD_rate_choice1 = sqrt(variance(rate_choice1))
  ) %>%
  dplyr::ungroup() %>% 
  dplyr::mutate(
    mean_risk_aversion = 1 - MEAN_rate_choice1
  ) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) ->
  df_agent_randmulti_sLR_summary


# combine _summary with task info
df_randmulti_taskinfo_sLR %>%
  dplyr::full_join(df_agent_randmulti_sLR_summary, by = c("sim", "sim_i", "task_i")) ->
  df_agent_randmulti_sLR_summary

# summmarise by sim & generation
df_agent_randmulti_sLR_summary %>%
  dplyr::group_by(sim, generation, task_type) %>%
  dplyr::summarise(
    MEAN_risk_aversion = mean(mean_risk_aversion),
    SD_risk_aversion = sqrt(variance(mean_risk_aversion)),
    N = n()
  ) %>%
  dplyr::ungroup() %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) ->
  df_agent_randmulti_sLR_simMEAN
```


```{r, eval=FALSE}
# load _trial.csv.gz (trial-by-trial data of the first and last generation)

## Because the size of _trial.csv is big, we create another object for containing only the info of the first and last generation (the .RDS file below).

## This process takes much time and memory. So, once the .RDS file is created, you should not run this chunk again. 

## The main code is temporarily commented out in case that you run this chunk mistakenly. If you want to run, the comment should be removed. 


## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name <- c("_20230221152956", "_20230223100048", "_20230223222143", "_20230224180738", "_20230225091934")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask_SingleLR"

Extract_SimN <- 100

# df_beha_trial_randmulti_sLR_summary <- purrr::map2_dfr(pattern_name, sim_name, ~MakeDfTrial_Rand(.x, .y, DataDir, DataDir_sub, "_trial.csv.gz", Extract_SimN))
# 
# # combine df trial with task info
# df_randmulti_taskinfo_sLR %>%
#   dplyr::full_join(df_beha_trial_randmulti_sLR_summary, by = c("sim", "sim_i", "task_i")) %>%
#   dplyr::mutate(
#     sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
#   ) ->
#   df_beha_trial_randmulti_sLR_summary
# 
# saveRDS(df_beha_trial_randmulti_sLR_summary, file = here(DataDir, DataDir_sub, "df_beha_trial_randmulti_sLR_summary.RDS"))
```


```{r}
# ------ load _trial.csv data from .RDS file ------ #

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask_SingleLR"

df_beha_trial_randmulti_sLR_summary <- readRDS(here(DataDir, DataDir_sub, "df_beha_trial_randmulti_sLR_summary.RDS"))

df_beha_trial_randmulti_sLR_summary %>% 
  dplyr::group_by(sim_n, generation, trial, task_type) %>% # calculate mean and SD across sim_iる
  dplyr::summarise(
    MEAN_risk_aversion = mean(mean_risk_aversion),
    SD_risk_aversion = sqrt(variance(mean_risk_aversion)) # SD across sim_i
  ) -> 
df_trial_randmulti_sLR_simMEAN
```



### Tasks where the expected values are the same (single learning rate)


#### Run simulations

```{r, eval=FALSE}
# load df_beha_agent_randmulti.RDS
# -> create and save df_para_agent_randmulti_sLR_FirstLastGene.RDS

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask_SingleLR"

names_randmulti_sLR_rds <- c("df_agent_randmulti_sLR_22.RDS", "df_agent_randmulti_sLR_13.RDS", "df_agent_randmulti_sLR_31.RDS", "df_agent_randmulti_sLR_04.RDS", "df_agent_randmulti_sLR_40.RDS")

df_agent_randmulti_sLR <-
  purrr::map_dfr(names_randmulti_sLR_rds, ~readRDS(here(DataDir, DataDir_sub, .x)))

df_para_agent_randmulti_sLR_FirstLastGene <-
  df_agent_randmulti_sLR %>%
  dplyr::filter(task_i == 0) %>%  # one task is adequate
  dplyr::select(sim, sim_i, generation, agent, alpha, bt)

# If you want to run, the comment symbol below should be removed.
# saveRDS(df_para_agent_randmulti_sLR_FirstLastGene, file = here(DataDir, DataDir_sub, "df_para_agent_randmulti_sLR_FirstLastGene.RDS"))
```


```{r, eval=FALSE}
# Simulate task where the expected values are the same

## The main code is temporarily commented out in case that you run this chunk mistakenly. If you want to run, the comment should be removed. 

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask_SingleLR"

# load para info of the first and last generation
df_para_agent_randmulti_sLR_FirstLastGene <- readRDS(here(DataDir, DataDir_sub, "df_para_agent_randmulti_sLR_FirstLastGene.RDS"))

trial_N <- 500
task_struct_list <- list(
  c(20, 20, 20, 5), 
  c(10, 20, 10, 5), 
  c(-10, 20, -10, 5), 
  c(-20, 20, -20, 5)
)


# Simulation of agents of the last generation

# df_agent_randmulti_sLR_Last <- df_para_agent_randmulti_sLR_FirstLastGene %>%
#   dplyr::filter(generation == 2999)
# 
# res_ql_list_sLR_Last <- purrr::map(task_struct_list, ~RunQL_single(df_agent_randmulti_sLR_Last, .x, trial_N))
# 
# res_ql_list_choice_sLR_Last <-
#   res_ql_list_sLR_Last %>%
#   purrr::map("Choice")
# 
# saveRDS(object = res_ql_list_choice_sLR_Last, file = here(simout_SameExp_path, "res_ql_list_choice_sLR_LastGene_500T.RDS"))


# Simulation of agents of the first generation

# df_agent_randmulti_sLR_First <- df_para_agent_randmulti_sLR_FirstLastGene %>%
#   dplyr::filter(generation == 0)
# 
# res_ql_list_sLR_First <- purrr::map(task_struct_list, ~RunQL_single(df_agent_randmulti_sLR_First, .x, trial_N))
# 
# res_ql_list_choice_sLR_First <-
#   res_ql_list_sLR_First %>%
#   purrr::map("Choice")
# 
# saveRDS(object = res_ql_list_choice_sLR_First, file = here(simout_SameExp_path, "res_ql_list_choice_sLR_FirstGene_500T.RDS"))
```


#### Load simulations results


```{r}
# sim results of last generation
res_ql_list_choice_sLR_500T_last <- readRDS(file = here(simout_SameExp_path, "res_ql_list_choice_sLR_LastGene_500T.RDS"))

# sim results of first generation
res_ql_list_choice_sLR_500T_first <- readRDS(file = here(simout_SameExp_path, "res_ql_list_choice_sLR_FirstGene_500T.RDS"))

# load of the para info of the first and last generation
df_para_agent_randmulti_sLR_FirstLastGene <- readRDS(here("Data", "Evo_RandMultiTask_SingleLR", "df_para_agent_randmulti_sLR_FirstLastGene.RDS"))

df_agent_randmulti_sLR_Last <-
  df_para_agent_randmulti_sLR_FirstLastGene %>% 
  dplyr::filter(generation == 2999)

df_agent_randmulti_sLR_First <-
  df_para_agent_randmulti_sLR_FirstLastGene %>% 
  dplyr::filter(generation == 0)
```


```{r, eval=FALSE}
# extract the data of the last 100 trials

## The main code is temporarily commented out in case that you run this chunk mistakenly. If you want to run, the comment should be removed. 

# purrr::map(res_ql_list_choice_sLR_500T_last,
#            ~{.x %>%
#                tibble::as_tibble(.) %>%
#                dplyr::bind_cols(df_agent_randmulti_sLR_Last) %>%
#                tidyr::pivot_longer(
#                  cols = starts_with("V"),
#                  names_to = "trial",
#                  names_prefix = "V",
#                  values_to = "choice",
#                  names_transform = list(trial = as.integer)
#                ) %>%
#                dplyr::mutate(
#                  choice = if_else(choice == 2, 0, 1)
#                ) %>%
#                dplyr::filter(trial > 400) %>% # extract the last 100 trials
#                dplyr::group_by(sim, sim_i, agent, alpha, bt) %>% # averaging across trial
#                dplyr::summarise(
#                  risk_aversion = 1 - mean(choice)
#                ) %>%
#                dplyr::ungroup()
#                }) %>%
#   dplyr::bind_rows(.id = "task") %>%
#   dplyr::mutate(generation = 2999) ->
#   df_choice_res_sLR_latter100_last
# 
# 
# purrr::map(res_ql_list_choice_sLR_500T_first,
#            ~{.x %>%
#                tibble::as_tibble(.) %>%
#                dplyr::bind_cols(df_agent_randmulti_sLR_First) %>%
#                tidyr::pivot_longer(
#                  cols = starts_with("V"),
#                  names_to = "trial",
#                  names_prefix = "V",
#                  values_to = "choice",
#                  names_transform = list(trial = as.integer)
#                ) %>%
#                dplyr::mutate(
#                  choice = if_else(choice == 2, 0, 1)
#                ) %>%
#                dplyr::filter(trial > 400) %>% # extract the last 100 trials
#                dplyr::group_by(sim, sim_i, agent, alpha, bt) %>% # averaging across trial
#                dplyr::summarise(
#                  risk_aversion = 1 - mean(choice)
#                ) %>%
#                dplyr::ungroup()
#                }) %>%
#   dplyr::bind_rows(.id = "task") %>%
#   dplyr::mutate(generation = 0) ->
#   df_choice_res_sLR_latter100_first
# 
# 
# df_choice_res_sLR_latter100_last %>%
#   dplyr::bind_rows(df_choice_res_sLR_latter100_first) %>%
#   dplyr::mutate(task = as.integer(task)) %>%
#   dplyr::mutate(
#     task_struct =
#       case_when(
#         task == 1 ~ "N(20, 20) vs N(20, 5) (Gain)",
#         task == 2 ~ "N(10, 20) vs N(10, 5) (Gain)",
#         task == 3 ~ "N(-10, 20) vs N(-10, 5) (Loss)",
#         task == 4 ~ "N(-20, 20) vs N(-20, 5) (Loss)",
#       ) %>% forcats::fct_reorder(., task),
#     sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
#   ) ->
#   df_choice_res_sLR_500T_latter100
# 
# saveRDS(df_choice_res_sLR_500T_latter100, file = here(simout_SameExp_path, "df_choice_res_sLR_500T_lat.RDS"))
```


```{r}
# load 500-trials simulation, last 100-trials data
df_choice_res_sLR_500T_latter100 <- readRDS(file = here(simout_SameExp_path, "df_choice_res_sLR_500T_lat.RDS"))
```


```{r}
df_choice_res_sLR_500T_latter100 %>% 
  
  dplyr::filter(generation == 2999) %>% 
  
  dplyr::mutate(gain_loss = if_else(task == 1 | task == 2, "gain", "loss")) %>% 
  dplyr::group_by(sim_n, sim_i, agent, alpha, bt, gain_loss) %>% 
  dplyr::summarise(
    mean_risk_aversion = mean(risk_aversion)
  ) %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(id_cols = c(sim_n, sim_i, agent, alpha, bt), names_from = gain_loss, values_from = mean_risk_aversion) %>% 
  dplyr::mutate(
    risk_aver_gain_loss = gain - loss
  ) ->
  df_choice_gainloss_sLR_500T_latter100_last


df_choice_res_sLR_500T_latter100 %>% 
  
  dplyr::filter(generation == 0) %>% 
  
  dplyr::mutate(gain_loss = if_else(task == 1 | task == 2, "gain", "loss")) %>% 
  dplyr::group_by(sim_n, sim_i, agent, alpha, bt, gain_loss) %>% 
  dplyr::summarise(
    mean_risk_aversion = mean(risk_aversion)
  ) %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(id_cols = c(sim_n, sim_i, agent, alpha, bt), names_from = gain_loss, values_from = mean_risk_aversion) %>% 
  dplyr::mutate(
    risk_aver_gain_loss = gain - loss # calculate gain-loss difference
  ) ->
  df_choice_gainloss_sLR_500T_latter100_first

```


### Model with perseverance parameter


```{r}
# create dataframes for task info


## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name <- c("_20230303173752", "_20230304132536", "_20230306103038", "_20230307111756", "_20230308184847")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

params <- list(
  pattern_name = pattern_name,
  sim_name = sim_name
)

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask_Perseverance"

df_randmulti_taskinfo_Psv <- 
  purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_task.csv")) %>% 
  dplyr::mutate(
    area_rate = (pnorm(0, m1, sd1) + pnorm(0, m2, sd2))/2,
    eff_size = EffectSize(m1, sd1, m2, sd2)
    ) %>% 
  dplyr::mutate(
    posi_nega = case_when(
      (m1 > 0) & (m2 > 0) ~ "posi",
      (m1 < 0) & (m2 < 0) ~ "nega",
      TRUE ~ "other"
    ),
    task_type = case_when(
      m1 > m2 ~ "risk_seeking",
      m2 > m1 ~ "risk_aversion"
    ),
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
    )

df_randmulti_taskgroup_Psv <- 
  purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_taskgroup.csv")) %>% 
  dplyr::mutate(area_rate = (pnorm(0, m1, sd1) + pnorm(0, m2, sd2))/2) %>% 
  dplyr::mutate(
    posi_nega = case_when(
      (m1 > 0) & (m2 > 0) ~ "posi",
      (m1 < 0) & (m2 < 0) ~ "nega",
      TRUE ~ "other"
    ),
    task_type = case_when(
      m1 > m2 ~ "risk_seeking",
      m2 > m1 ~ "risk_aversion"
    ),
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
    )

# calculate the averaged effect size and negative area for each sim
df_randmulti_taskinfo_Psv %>% 
  dplyr::group_by(sim, sim_i) %>% 
  dplyr::summarise(
    mean_eff_size = mean(eff_size),
    mean_area_rate = mean(area_rate)
  ) %>% 
  dplyr::ungroup() ->
  df_randmulti_mean_taskinfo_Psv
```


```{r}
# load _gene.csv  


## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name <- c("_20230303173752", "_20230304132536", "_20230306103038", "_20230307111756", "_20230308184847")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

params <- list(
  pattern_name = pattern_name,
  sim_name = sim_name
)

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask_Perseverance"

df_gene_randmulti_Psv <- purrr::map2_dfr(params$pattern_name, params$sim_name, ~MakeDf(.x, .y, DataDir, DataDir_sub, "_gene.csv"))

df_gene_randmulti_Psv %>% 
  dplyr::group_by(sim, generation) %>% 
  dplyr::summarise(
    MEAN_ap = mean(mean_ap),
    MEAN_an = mean(mean_an),
    MEAN_bt = mean(mean_bt),
    MEAN_phi = mean(mean_phi)
  ) %>% 
  dplyr::ungroup() -> 
  df_gene_randmulti_Psv_summary


# combine para df (filtered by last generation) with task info
df_gene_randmulti_Psv %>% 
  dplyr::filter(generation == 2999) %>% 
  dplyr::full_join(df_randmulti_mean_taskinfo_Psv, by = c("sim", "sim_i")) ->
  df_gene_randmulti_Psv_taskinfo


# df for overall summary
df_gene_randmulti_Psv %>% 
  dplyr::group_by(sim, generation) %>% 
  dplyr::summarise(
    MEAN_ap = mean(mean_ap),
    MEAN_an = mean(mean_an),
    MEAN_bt = mean(mean_bt),
    MEAN_phi = mean(mean_phi)
  ) %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_longer(cols = -c(sim, generation), names_to = c("stat", "para"), names_sep = "_") %>% 
  tidyr::pivot_wider(names_from = stat, values_from = value) -> 
  df_gene_randmulti_Psv_summary_longer

df_gene_randmulti_Psv %>% 
  tidyr::pivot_longer(cols = -c(sim, sim_i, generation), names_to = c("stat", "para"), names_sep = "_") %>% 
  tidyr::pivot_wider(names_from = stat, values_from = value) ->
  df_gene_randmulti_Psv_longer

df_gene_randmulti_Psv_longer %>% 
  dplyr::filter(generation == 2999) %>% 
  dplyr::full_join(df_randmulti_mean_taskinfo_Psv, by = c("sim", "sim_i")) ->
  df_gene_randmulti_Psv_taskinfo_longer
```


```{r, eval=FALSE}
# load _nat.csv.gz (averaged info for each agent)

## Because the size of _nat.csv is big, we create another object for containing only the info of the first and last generation (the .RDS file below).

## This process takes much time and memory. So, once the .RDS file is created, you should not run this chunk again. 

## The main code is temporarily commented out in case that you run this chunk mistakenly. If you want to run, the comment should be removed.


## a directory, which corresponds to a simulation setting, is specified by a suffix "_YYYYMMDDHHMMSS"
## e.g., G05000_N10000_T0500_apR_anR_btR_CN_1mean50.0_1sigma30.0_2mean30.0_2sigma5.0_V_20191214183504
## pattern_name should be specified by the suffix number

pattern_name <- c("_20230303173752", "_20230304132536", "_20230306103038", "_20230307111756", "_20230308184847")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")


DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask_Perseverance"

AgentN <- 1000
GeneN <- 3000
TaskN <- 4
Extract_SimN <- 100



# df_agent_randmulti_Psv_22 <- MakeDfNat_Rand(pattern_name[1], sim_name[1], DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)
# saveRDS(df_agent_randmulti_Psv_22, file = here(DataDir, DataDir_sub, "df_agent_randmulti_Psv_22.RDS"))
# 
# df_agent_randmulti_Psv_13 <- MakeDfNat_Rand(pattern_name[2], sim_name[2], DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)
# saveRDS(df_agent_randmulti_Psv_13, file = here(DataDir, DataDir_sub, "df_agent_randmulti_Psv_13.RDS"))
# 
# df_agent_randmulti_Psv_31 <- MakeDfNat_Rand(pattern_name[3], sim_name[3], DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)
# saveRDS(df_agent_randmulti_Psv_31, file = here(DataDir, DataDir_sub, "df_agent_randmulti_Psv_31.RDS"))
# 
# df_agent_randmulti_Psv_04 <- MakeDfNat_Rand(pattern_name[4], sim_name[4], DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)
# saveRDS(df_agent_randmulti_Psv_04, file = here(DataDir, DataDir_sub, "df_agent_randmulti_Psv_04.RDS"))
# 
# df_agent_randmulti_Psv_40 <- MakeDfNat_Rand(pattern_name[5], sim_name[5], DataDir, DataDir_sub, "_nat.csv.gz", GeneN, AgentN, TaskN, Extract_SimN)
# saveRDS(df_agent_randmulti_Psv_40, file = here(DataDir, DataDir_sub, "df_agent_randmulti_Psv_40.RDS"))
```


- load agent data


```{r, eval=FALSE}
# ------ load _nat.csv data from .RDS file ------ #

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask_Perseverance"

names_randmulti_Psv_rds <- c("df_agent_randmulti_Psv_22.RDS", "df_agent_randmulti_Psv_13.RDS", "df_agent_randmulti_Psv_31.RDS", "df_agent_randmulti_Psv_04.RDS", "df_agent_randmulti_Psv_40.RDS")

df_agent_randmulti_Psv <-
  purrr::map_dfr(names_randmulti_Psv_rds, ~readRDS(here(DataDir, DataDir_sub, .x)))


# create _summary dataframe
df_agent_randmulti_Psv %>% 
  dplyr::group_by(sim, sim_i, task_i, generation) %>%
  dplyr::summarise(
    MEAN_payoff = mean(mean_payoff),
    SD_payoff = sqrt(variance(mean_payoff)),
    MEAN_rate_choice1 = mean(rate_choice1),
    SD_rate_choice1 = sqrt(variance(rate_choice1))
  ) %>%
  dplyr::ungroup() %>% 
  dplyr::mutate(
    mean_risk_aversion = 1 - MEAN_rate_choice1
  ) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) ->
  df_agent_randmulti_Psv_summary


# combine _summary with task info
df_randmulti_taskinfo_Psv %>%
  dplyr::full_join(df_agent_randmulti_Psv_summary, by = c("sim", "sim_i", "task_i")) ->
  df_agent_randmulti_Psv_summary


df_agent_randmulti_Psv_summary %>%
  dplyr::group_by(sim, generation, task_type) %>%
  dplyr::summarise(
    MEAN_risk_aversion = mean(mean_risk_aversion),
    SD_risk_aversion = sqrt(variance(mean_risk_aversion)),
    N = n()
  ) %>%
  dplyr::ungroup() %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) ->
  df_agent_randmulti_Psv_simMEAN
```


```{r, eval=FALSE}
# load _trial.csv.gz (trial-by-trial data of the first and last generation)

## Because the size of _trial.csv is big, we create another object for containing only the info of the first and last generation (the .RDS file below).

## This process takes much time and memory. So, once the .RDS file is created, you should not run this chunk again. 

## The main code is temporarily commented out in case that you run this chunk mistakenly. If you want to run, the comment should be removed. 


pattern_name <- c("_20230303173752", "_20230304132536", "_20230306103038", "_20230307111756", "_20230308184847")
sim_name <- c("cond_2/2", "cond_1/3", "cond_3/1", "cond_0/4", "cond_4/0")

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask_Perseverance"

Extract_SimN <- 100

# df_beha_trial_randmulti_Psv_summary <- purrr::map2_dfr(pattern_name, sim_name, ~MakeDfTrial_Rand(.x, .y, DataDir, DataDir_sub, "_trial.csv.gz", Extract_SimN))
# 
# # combine df with task nifo
# df_randmulti_taskinfo_Psv %>%
#   dplyr::full_join(df_beha_trial_randmulti_Psv_summary, by = c("sim", "sim_i", "task_i")) %>%
#   dplyr::mutate(
#     sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
#   ) ->
#   df_beha_trial_randmulti_Psv_summary
# 
# saveRDS(df_beha_trial_randmulti_Psv_summary, file = here(DataDir, DataDir_sub, "df_beha_trial_randmulti_Psv_summary.RDS"))
```


```{r}
# ------ load _trial.csv data from .RDS file ------ #

DataDir <- "Data"
DataDir_sub <- "Evo_RandMultiTask_Perseverance"

df_beha_trial_randmulti_Psv_summary <- readRDS(here(DataDir, DataDir_sub, "df_beha_trial_randmulti_Psv_summary.RDS"))

df_beha_trial_randmulti_Psv_summary %>% 
  dplyr::group_by(sim_n, generation, trial, task_type) %>% # calculate mean and SD across sim_i
  dplyr::summarise(
    MEAN_risk_aversion = mean(mean_risk_aversion),
    SD_risk_aversion = sqrt(variance(mean_risk_aversion)) # SD across sim_i
  ) -> 
df_trial_randmulti_Psv_simMEAN
```



# S1 Single task：Risk aversion rate


- results with D = +-10

- horizontal axis: task, vertical axis: mean rate of risk aversion in the last generation (+SD)


```{r, eval = FALSE}
# Risk-aversion task
target_simexp <- c("-40 vs -30", "-30 vs -20", "-20 vs -10", "-10 vs 0", "0 vs 10", "10 vs 20", "20 vs 30")

g <- VisFirstLastGene_RiskAversion(df_gene_riskaversion_mean, target_simexp, "Risk-aversion task (D = -10)", tag = "")

ggsave(plot = g, filename = here(output_path, "S1.1_FirstLastGene_RiskAversion_risk-aversion_inrow.png"), width = 20.0, height = 6.0, dpi = 200)
```

 
```{r, eval = FALSE}
# Risk-seeking task
target_simexp <- c("-20 vs -30", "-10 vs -20", "0 vs -10", "10 vs 0", "20 vs 10", "30 vs 20", "40 vs 30")

g <- VisFirstLastGene_RiskAversion(df_gene_riskaversion_mean, target_simexp, "Risk-seeking task (D = +10)", tag = "", legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S1.2_FirstLastGene_RiskAversion_risk-seeking_inrow.png"), width = 20.0, height = 6.0, dpi = 200)
```



# S2 Single task：Evolutionary dynamics of alpha_p and alpha_n


- display all tasks


## Risk-aversion task


- horizontal axis: generation, vertical axis: mean value of parameters (+SD)

- row：safe option (seven)、column：SD of risky option (five)


```{r}
# Risk-aversion task D = -20

maintext_sim <- ""

g <- VisEvol_Para_RunMean_facet_sd1_nonrisky(df_gene_longer, "alpha", "risk-aversion", 20, maintext_sim, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S2.1_Evo_risk_aversion_apan_D20.png"), width = 15.0, height = 20.0, dpi = 100)
```


```{r}
# Risk-aversion task D = -10

maintext_sim <- ""

g <- VisEvol_Para_RunMean_facet_sd1_nonrisky(df_gene_longer, "alpha", "risk-aversion", 10, maintext_sim, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S2.2_Evo_risk_aversion_apan_D10.png"), width = 15.0, height = 20.0, dpi = 100)
```


## Risk-seeking task

  
- horizontal axis: generation, vertical axis: mean value of parameters (+SD)

- row：safe option (seven)、column：SD of risky option (five)

```{r}
# Risk-seeking task D = +20

maintext_sim <- ""

g <- VisEvol_Para_RunMean_facet_sd1_nonrisky(df_gene_longer, "alpha", "risk-seeking", 20, maintext_sim, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S2.3_Evo_risk_seeking_apan_D20.png"), width = 15.0, height = 20.0, dpi = 100)
```


```{r}
# Risk-seeking task D = +10

maintext_sim <- ""

g <- VisEvol_Para_RunMean_facet_sd1_nonrisky(df_gene_longer, "alpha", "risk-seeking", 10, maintext_sim, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S2.4_Evo_risk_seeking_apan_D10.png"), width = 15.0, height = 20.0, dpi = 100)
```


# S3 Single task：Evolutionary results of alpha_p and alpha_n

  
- results with D = +-10

- horizontal axis: task, vertical axis: mean parameter values of the last generation (+SD）


```{r, eval = FALSE}
# Risk-aversion task

target_simexp <- c("-40 vs -30", "-30 vs -20", "-20 vs -10", "-10 vs 0", "0 vs 10", "10 vs 20", "20 vs 30")

g <- VisLastGene_Para_RunMean(df_gene_longer, target_simexp, "alpha", "Risk-aversion task (D = -10)", tag = "")

ggsave(plot = g, filename = here(output_path, "S3.1_LastGene_apan_risk-aversion_inrow.png"), width = 20.0, height = 6.0, dpi = 200)
```


```{r, eval = FALSE}
# Risk-seeking task

target_simexp <- c("-20 vs -30", "-10 vs -20", "0 vs -10", "10 vs 0", "20 vs 10", "30 vs 20", "40 vs 30")

g <- VisLastGene_Para_RunMean(df_gene_longer, target_simexp, "alpha", "Risk-seeking task (D = +10)", tag = "", legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S3.2_LastGene_apan_risk-seeking_inrow.png"), width = 20.0, height = 6.0, dpi = 200)
```



# S4 Single task：Evolutionary dynamics of beta


- display all tasks


## Risk-aversion task


- horizontal axis: generation, vertical axis: mean value of parameters (+SD)

- row：safe option (seven)、column：SD of risky option (five)


```{r}
# Risk-aversion task D = -20

maintext_sim <- ""

g <- VisEvol_Para_RunMean_facet_sd1_nonrisky(df_gene_longer, "beta", "risk-aversion", 20, maintext_sim, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S4.1_Evo_risk_aversion_bt_D20.png"), width = 15.0, height = 20.0, dpi = 100)
```


```{r}
# Risk-aversion task D = -10

maintext_sim <- ""

g <- VisEvol_Para_RunMean_facet_sd1_nonrisky(df_gene_longer, "beta", "risk-aversion", 10, maintext_sim, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S4.2_Evo_risk_aversion_bt_D10.png"), width = 15.0, height = 20.0, dpi = 100)
```


## Risk-seeking task

  
- horizontal axis: generation, vertical axis: mean value of parameters (+SD)

- row：safe option (seven)、column：SD of risky option (five)


```{r}
# Risk-seeking task D = +20

maintext_sim <- ""

g <- VisEvol_Para_RunMean_facet_sd1_nonrisky(df_gene_longer, "beta", "risk-seeking", 20, maintext_sim, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S4.3_Evo_risk_seeking_bt_D20.png"), width = 15.0, height = 20.0, dpi = 100)
```


```{r}
# Risk-seeking task D = +10

maintext_sim <- ""

g <- VisEvol_Para_RunMean_facet_sd1_nonrisky(df_gene_longer, "beta", "risk-seeking", 10, maintext_sim, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S4.4_Evo_risk_seeking_bt_D10.png"), width = 15.0, height = 20.0, dpi = 100)
```



# S5 Single task：Evolutionary results of beta


- results with D = +-20

- horizontal axis: task, vertical axis: mean parameter values of the last generation (+SD）


```{r, eval = FALSE}
# Risk-aversion task D = -20

target_simexp <- c("-50 vs -30", "-40 vs -20", "-30 vs -10", "-20 vs 0", "-10 vs 10", "0 vs 20", "10 vs 30")

g <- VisLastGene_Para_RunMean(df_gene_longer, target_simexp, "beta", "Risk-aversion task (D = -20)", tag = "")

ggsave(plot = g, filename = here(output_path, "S5.1_LastGene_bt_risk-aversion_inrow.png"), width = 20.0, height = 6.0, dpi = 200)
```


```{r, eval = FALSE}
# Risk-seeking task D = +20

target_simexp <- c("-10 vs -30", "0 vs -20", "10 vs -10", "20 vs 0", "30 vs 10", "40 vs 20", "50 vs 30")

g <- VisLastGene_Para_RunMean(df_gene_longer, target_simexp, "beta", "Risk-seeking task (D = +20)", tag = "", legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S5.3_LastGene_bt_risk-seeking_inrow.png"), width = 20.0, height = 6.0, dpi = 200)
```


- results with D = +-10

- horizontal axis: task, vertical axis: mean parameter values of the last generation (+SD）



```{r, eval = FALSE}
# Risk-aversion task D = -10

target_simexp <- c("-40 vs -30", "-30 vs -20", "-20 vs -10", "-10 vs 0", "0 vs 10", "10 vs 20", "20 vs 30")

g <- VisLastGene_Para_RunMean(df_gene_longer, target_simexp, "beta", "Risk-aversion task (D = -10)", tag = "")

ggsave(plot = g, filename = here(output_path, "S5.2_LastGene_bt_risk-aversion_inrow.png"), width = 20.0, height = 6.0, dpi = 200)
```


```{r, eval = FALSE}
# Risk-seeking task D = +10

target_simexp <- c("-20 vs -30", "-10 vs -20", "0 vs -10", "10 vs 0", "20 vs 10", "30 vs 20", "40 vs 30")

g <- VisLastGene_Para_RunMean(df_gene_longer, target_simexp, "beta", "Risk-seeking task (D = +10)", tag = "", legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S5.4_LastGene_bt_risk-seeking_inrow.png"), width = 20.0, height = 6.0, dpi = 200)
```



# S6 Task structure of multiple-task simulations


## Distribution of effect size

```{r}
df_randmulti_taskgroup %>% 

  ggplot(aes(x = eff_size)) + geom_histogram() + 
  my_theme2 + 
  theme(
    strip.text.x = element_text(size = 14),
    axis.text.x = element_text(size = 15), 
    axis.text.y = element_text(size = 15)
  ) + 
  scale_y_continuous(breaks = seq(0, 15, by = 2)) + 
  labs(x = "Effect size", tag  = "(a)") + 
  facet_wrap(~sim_n, ncol = 5) -> g

ggsave(plot = g, filename = here(output_path, "S6.1_randmulti_taskgroup_effsize.png"), width = 15.0, height = 4.0)
```


## Distribution of mean negative rate

```{r}
df_randmulti_taskgroup %>% 

  ggplot(aes(x = area_rate)) + geom_histogram() + 
  my_theme2 + 
  theme(
    strip.text.x = element_text(size = 14),
    axis.text.x = element_text(size = 15), 
    axis.text.y = element_text(size = 15)
  ) + 
  scale_y_continuous(breaks = seq(0, 10, by = 2)) + 
  labs(x = "Negative area rate", tag = "(b)") + 
  facet_wrap(~sim_n, ncol = 5) -> g

ggsave(plot = g, filename = here(output_path, "S6.2_randmulti_taskgroup_arearate.png"), width = 15.0, height = 4.0)
```


## (S1Table) Task set for all conditions


- save table as .png file


```{r, eval = FALSE}
# These tables are displayed as S1 Table in Supporting Info

webshot::install_phantomjs()

df_randmulti_taskinfo %>% 
  
  dplyr::mutate(across(c(m2, sd2, m1, sd1), ~round(.x, digits = 1))) %>% 
  dplyr::mutate(
    task_n = task_i + 1,
    nonrisky = paste0('N(', m2, ', ', sd2, ')'),
    risky = paste0('N(', m1, ', ', sd1, ')')
  ) %>% 
  tidyr::pivot_longer(
    cols = c(nonrisky, risky), names_to = "op", values_to = "dist"
  ) %>% 
  tidyr::pivot_wider(
    id_cols = c(sim_n, sim_i), names_from = c(task_n, op), names_sep = ": ", values_from = dist
  ) %>% 
  dplyr::arrange(sim_n) -> 
  df_gt

coln <- colnames(df_gt)

# cond 0/4
cond <- "risk seeking/aversion = 0/4"
gt_tab <- VisTable_Taskinfo(df_gt, cond)
gtsave(gt_tab, filename = here(output_path, "S6_Table_taskinfo_04.png"), vwidth = 2000, vheight = 4500)


# cond 1/3
cond <- "risk seeking/aversion = 1/3"
gt_tab <- VisTable_Taskinfo(df_gt, cond)
gtsave(gt_tab, filename = here(output_path, "S6_Table_taskinfo_13.png"), vwidth = 2000, vheight = 4500)


# cond 2/2
cond <- "risk seeking/aversion = 2/2"
gt_tab <- VisTable_Taskinfo(df_gt, cond)
gtsave(gt_tab, filename = here(output_path, "S6_Table_taskinfo_22.png"), vwidth = 2000, vheight = 4500)


# cond 3/1
cond <- "risk seeking/aversion = 3/1"
gt_tab <- VisTable_Taskinfo(df_gt, cond)
gtsave(gt_tab, filename = here(output_path, "S6_Table_taskinfo_31.png"), vwidth = 2000, vheight = 4500)


# cond 4/0
cond <- "risk seeking/aversion = 4/0"
gt_tab <- VisTable_Taskinfo(df_gt, cond)
gtsave(gt_tab, filename = here(output_path, "S6_Table_taskinfo_40.png"), vwidth = 2000, vheight = 4500)
```



# S7 Multiple-task：Risk aversion rate of conditions


- display all simulations and tasks
  
- horizontal axis: task number、vertical axis：mean rate of risk aversion
  
- separately display risk-aversion task and risk-seeking task


## condition 0/4


```{r}
# seeking/aversion = 0/4
# risk-aversion task 1~25

sim_filt <- "cond_0/4" 
main_title <- "risk seeking/aversion = 0/4"
sim_range <- c(1, 25)
sub_title <- paste0("Risk-aversion task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-aversion", sim_range, main_title, sub_title)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_04_risk_aversion_1-25.png"), width = 21, height = 7.0)
```


```{r}
# seeking/aversion = 0/4
# risk-aversion task 26~50

sim_filt <- "cond_0/4"
main_title <- "risk seeking/aversion = 0/4"
sim_range <- c(26, 50)
sub_title <- paste0("Risk-aversion task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-aversion", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_04_risk_aversion_26-50.png"), width = 21, height = 7.0)
```


```{r}
# seeking/aversion = 0/4
# risk-aversion task 51~75

sim_filt <- "cond_0/4"
main_title <- "risk seeking/aversion = 0/4"
sim_range <- c(51, 75)
sub_title <- paste0("Risk-aversion task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-aversion", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_04_risk_aversion_51-75.png"), width = 21, height = 7.0)
```


```{r}
# seeking/aversion = 0/4
# risk-aversion task 76~100

sim_filt <- "cond_0/4"
main_title <- "risk seeking/aversion = 0/4"
sim_range <- c(76, 100)
sub_title <- paste0("Risk-aversion task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-aversion", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_04_risk_aversion_76-100.png"), width = 21, height = 7.0)
```


## condition 1/3


```{r}
# seeking/aversion = 1/3
# risk-aversion task 1~33

sim_filt <- "cond_1/3"
main_title <- "risk seeking/aversion = 1/3"
sim_range <- c(1, 33)
sub_title <- paste0("Risk-aversion task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-aversion", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_13_risk_aversion_1-33.png"), width = 21, height = 6.8)
```


```{r}
# seeking/aversion = 1/3
# risk-aversion task 34~66

sim_filt <- "cond_1/3"
main_title <- "risk seeking/aversion = 1/3"
sim_range <- c(34, 66)
sub_title <- paste0("Risk-aversion task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-aversion", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_13_risk_aversion_34-66.png"), width = 21, height = 6.8)
```


```{r}
# seeking/aversion = 1/3
# risk-aversion task 67~100

sim_filt <- "cond_1/3"
main_title <- "risk seeking/aversion = 1/3"
sim_range <- c(67, 100)
sub_title <- paste0("Risk-aversion task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-aversion", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_13_risk_aversion_67-100.png"), width = 21, height = 6.8)
```


```{r}
# seeking/aversion = 1/3
# risk-seeking task 1~100

sim_filt <- "cond_1/3"
main_title <- "risk seeking/aversion = 1/3"
sim_range <- c(1, 100)
sub_title <- paste0("Risk-seeking task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-seeking", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_13_risk_seeking_1-100.png"), width = 21, height = 6.8)
```


## condition 2/2


```{r}
# seeking/aversion = 2/2
# risk-aversion task 1~50

sim_filt <- "cond_2/2"
main_title <- "risk seeking/aversion = 2/2"
sim_range <- c(1, 50)
sub_title <- paste0("Risk-aversion task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-aversion", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_22_risk_aversion_1-50.png"), width = 21, height = 6.8)
```


```{r}
# seeking/aversion = 2/2
# risk-aversion task 51~100

sim_filt <- "cond_2/2"
main_title <- "risk seeking/aversion = 2/2"
sim_range <- c(51, 100)
sub_title <- paste0("Risk-aversion task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-aversion", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_22_risk_aversion_51-100.png"), width = 21, height = 6.8)
```


```{r}
# seeking/aversion = 2/2
# risk-seeking task 1~50

sim_filt <- "cond_2/2"
main_title <- "risk seeking/aversion = 2/2"
sim_range <- c(1, 50)
sub_title <- paste0("Risk-seeking task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-seeking", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_22_risk_seeking_1-50.png"), width = 21, height = 6.8)
```


```{r}
# seeking/aversion = 2/2
# risk-seeking task 51~100

sim_filt <- "cond_2/2"
main_title <- "risk seeking/aversion = 2/2"
sim_range <- c(51, 100)
sub_title <- paste0("Risk-seeking task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-seeking", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_22_risk_seeking_51-100.png"), width = 21, height = 6.8)
```


## condition 3/1


```{r}
# seeking/aversion = 3/1
# risk-aversion task 1~100

sim_filt <- "cond_3/1"
main_title <- "risk seeking/aversion = 3/1"
sim_range <- c(1, 100)
sub_title <- paste0("Risk-aversion task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-aversion", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_31_risk_aversion_1-100.png"), width = 21, height = 7.0)
```


```{r}
# seeking/aversion = 3/1
# risk-seeking task 1~33

sim_filt <- "cond_3/1"
main_title <- "risk seeking/aversion = 3/1"
sim_range <- c(1, 33)
sub_title <- paste0("Risk-seeking task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-seeking", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_31_risk_seeking_1-33.png"), width = 21, height = 7.0)
```


```{r}
# seeking/aversion = 3/1
# risk-seeking task 34~66

sim_filt <- "cond_3/1"
main_title <- "risk seeking/aversion = 3/1"
sim_range <- c(34, 66)
sub_title <- paste0("Risk-seeking task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-seeking", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_31_risk_seeking_34-66.png"), width = 21, height = 7.0)
```


```{r}
# seeking/aversion = 3/1
# risk-seeking task 67~100

sim_filt <- "cond_3/1"
main_title <- "risk seeking/aversion = 3/1"
sim_range <- c(67, 100)
sub_title <- paste0("Risk-seeking task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-seeking", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_31_risk_seeking_67-100.png"), width = 21, height = 7.0)
```


## condition 4/0


```{r}
# seeking/aversion = 4/0
# risk-seeking task 1~25

sim_filt <- "cond_4/0"
main_title <- "risk seeking/aversion = 4/0"
sim_range <- c(1, 25)
sub_title <- paste0("Risk-seeking task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-seeking", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_40_risk_seeking_1-25.png"), width = 21, height = 7.0)
```


```{r}
# seeking/aversion = 4/0
# risk-seeking task 26~50

sim_filt <- "cond_4/0"
main_title <- "risk seeking/aversion = 4/0"
sim_range <- c(26, 50)
sub_title <- paste0("Risk-seeking task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-seeking", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_40_risk_seeking_26-50.png"), width = 21, height = 7.0)
```


```{r}
# seeking/aversion = 4/0
# risk-seeking task 51~75

sim_filt <- "cond_4/0"
main_title <- "risk seeking/aversion = 4/0"
sim_range <- c(51, 75)
sub_title <- paste0("Risk-seeking task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-seeking", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_40_risk_seeking_51-75.png"), width = 21, height = 7.0)
```


```{r}
# seeking/aversion = 4/0
# risk-seeking task 76~100

sim_filt <- "cond_4/0"
main_title <- "risk seeking/aversion = 4/0"
sim_range <- c(76, 100)
sub_title <- paste0("Risk-seeking task in simulation ", sim_range[1], "~", sim_range[2])

g <- VisFirstLastGene_RandMulti_RiskAversion_bySim(df_agent_randmulti_summary_bysim, sim_filt, "risk-seeking", sim_range, main_title, sub_title, legend = FALSE)

ggsave(plot = g, filename = here(output_path, "S7_RiskAversion_40_risk_seeking_76-100.png"), width = 21, height = 7.0)
```



# S8 Multiple-task：Learning dynamics


- horizontal axis: trial, vertical axis: Risk aversion rate


```{r, eval=FALSE}
df_trial_randmulti_simMEAN %>% 
  
  dplyr::mutate(
    generation = generation + 1,
    task_type_rev = if_else(task_type == "risk_aversion", "risk aversion", "risk seeking")
    ) %>% 
  
  ggplot(aes(x = trial, y = MEAN_risk_aversion)) + 
  geom_line(aes(x = trial, y = MEAN_risk_aversion, color = task_type_rev), size = 1.2) + 
  geom_ribbon(aes(x = trial, ymin = MEAN_risk_aversion - SD_risk_aversion, ymax = MEAN_risk_aversion + SD_risk_aversion, fill = task_type_rev), alpha = 0.6) + 
  my_theme2 + 
  theme(axis.text.x = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        axis.title = element_text(size = 23, face = "bold"),
        strip.text.x = element_text(size = 17),
        legend.title = element_text(size = 16), #change legend title font size
        legend.text = element_text(size = 16),
        legend.background = element_rect(fill = "transparent"), 
        legend.key = element_rect(fill = "white"), 
        legend.position = c(1, 1), 
        legend.justification = c(1, 1)
        ) + 
  scale_color_manual(values=c("deepskyblue", "tan3")) + 
  scale_fill_manual(values=c("lightblue3", "goldenrod1")) + 
  coord_cartesian(ylim = c(0, 1)) + 
  labs(x = "Trial",
       y = "Rate of risk aversion",
       color = "Task",
       fill = "Task") + 
  
  facet_grid(generation~sim_n, labeller = labeller(generation = label_both)) -> g

ggsave(plot = g, filename = here(output_path, "S8_Trial_RiskAversion_RandMulti.png"), width = 20.0, height = 8.0, dpi = 400)
```


# S9 Multiple-task：Evolutionary dynamics of beta

 
- horizontal axis: generation, vertical axis: alpha value（each line corresponds to a simulation）


```{r, eval = FALSE} 
df_gene_randmulti_summary_longer %>% 
  dplyr::filter(para %in% c("bt")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) -> 
  df_gene_randmulti_summary_longer_rev

df_gene_randmulti_longer %>% 
  dplyr::filter(para %in% c("bt")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) %>% 
  
  ggplot(aes(x = generation, y = mean)) + geom_line(aes(group = sim_i), size = 0.08) + 
  geom_line(data = df_gene_randmulti_summary_longer_rev, aes(x = generation, y = MEAN, color = para), size = 2.0) +
  my_theme2 + labs(x = 'Generation', y = 'Parameter value') + guides(color = "none") + 
  scale_color_manual(name = "", values = c("#33A02C"), 
                     labels = c(expression(beta))) +  
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 15), 
    axis.title = element_text(size = 23, face = "bold"), 
    strip.text.x = element_text(size = 17),
    strip.text.y = element_text(angle = 0),
    plot.tag = element_text(size = 30)
  ) + 
  facet_grid(.~sim_n, 
             labeller = labeller(para_rev = label_parsed)) + 
  coord_cartesian(ylim = c(0, 0.5)) ->
  g
  
ggsave(plot = g, filename = here(output_path, "S9_Evo_RandMulti_bt.png"), width = 17.0, height = 5.0)
```



# S10 Effect of combination of ap and an on the risk aversion (heatmap)


## Risk-aversion task：bt = 0.10

```{r}
# D = -20

bt_filt <- 0.10

maintext_sim <- ""

g <- VisHeatmap_RiskAversion_facet_sd1_nonrisky(df_withingene_riskaverse_summary, "risk-aversion", 20, maintext_sim, bt_filt)

ggsave(plot = g, filename = here(output_path, "S10_Heatmap_RiskAversion_risk-aversion_bt010.png"), width = 15.0, height = 20.0, dpi = 100)
```


## Risk-aversion task：bt = 0.25

```{r}
# D = -20

bt_filt <- 0.25

maintext_sim <- c(
 "30.5.10.20", "20.5.0.20", "10.5.-10.20", "0.5.-20.20", "-10.5.-30.20", "-20.5.-40.20", "-30.5.-50.20"
)

g <- VisHeatmap_RiskAversion_facet_sd1_nonrisky(df_withingene_riskaverse_summary, "risk-aversion", 20, maintext_sim, bt_filt)

ggsave(plot = g, filename = here(output_path, "S10_Heatmap_RiskAversion_risk-aversion_bt025.png"), width = 15.0, height = 20.0, dpi = 100)
```


## Risk-aversion task：bt = 0.40

```{r}
# D = -20

bt_filt <- 0.40

maintext_sim <- ""

g <- VisHeatmap_RiskAversion_facet_sd1_nonrisky(df_withingene_riskaverse_summary, "risk-aversion", 20, maintext_sim, bt_filt)

ggsave(plot = g, filename = here(output_path, "S10_Heatmap_RiskAversion_risk-aversion_bt040.png"), width = 15.0, height = 20.0, dpi = 100)
```


## Risk-seeking task：bt = 0.10

```{r}
# D = +20

bt_filt <- 0.10

maintext_sim <- ""

g <- VisHeatmap_RiskAversion_facet_sd1_nonrisky(df_withingene_riskaverse_summary, "risk-seeking", 20, maintext_sim, bt_filt)

ggsave(plot = g, filename = here(output_path, "S10_Heatmap_RiskAversion_risk-seeking_bt010.png"), width = 15.0, height = 20.0, dpi = 80)
```


## Risk-seeking task：bt = 0.25

```{r}
# D = +20

bt_filt <- 0.25

maintext_sim <- c(
  "30.5.50.20", "20.5.40.20", "10.5.30.20", "0.5.20.20", "-10.5.10.20", "-20.5.0.20", "-30.5.-10.20"
)

g <- VisHeatmap_RiskAversion_facet_sd1_nonrisky(df_withingene_riskaverse_summary, "risk-seeking", 20, maintext_sim, bt_filt)

ggsave(plot = g, filename = here(output_path, "S10_Heatmap_RiskAversion_risk-seeking_bt025.png"), width = 15.0, height = 20.0, dpi = 80)
```


## Risk-seeking task：bt = 0.40

```{r}
# D = +20

bt_filt <- 0.40

maintext_sim <- ""

g <- VisHeatmap_RiskAversion_facet_sd1_nonrisky(df_withingene_riskaverse_summary, "risk-seeking", 20, maintext_sim, bt_filt)

ggsave(plot = g, filename = here(output_path, "S10_Heatmap_RiskAversion_risk-seeking_bt040.png"), width = 15.0, height = 20.0, dpi = 80)
```


# S11 The tasks where the expected values are the same：first generation


## Histogram of risk aversion 

```{r}
df_choice_res_500T_latter100 %>% 
  
  dplyr::filter(generation == 0) %>% 
  
  ggplot(aes(x = risk_aversion)) + 
  geom_histogram() + 
  my_theme2 + 
  theme(axis.text.x = element_text(size = 18), 
        axis.text.y = element_text(size = 18), 
        axis.title = element_text(size = 26, face = "bold"), 
        strip.text.x = element_text(size = 17),
        plot.tag = element_text(size = 30)
        ) + 
  facet_grid(sim_n~task_struct) + 
  labs(x = "Rate of risk aversion", y = "Frequency of agent", tag = "(a)") -> g

#print(g)
ggsave(plot = g, filename = here(output_path, "S11a_RiskPref_RandMulti_First_500T_lat.png"), width = 17.0, height = 24.0, dpi = 400)
```


## Histogram of difference in gain-loss


```{r}
df_choice_gainloss_500T_latter100_first %>% 
  
  ggplot(aes(x = risk_aver_gain_loss)) + geom_histogram() + 
  geom_vline(xintercept = 0, color = "black") + 
  my_theme2 + 
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 18), 
    axis.title.y = element_text(size = 21, face = "bold"), 
    axis.title.x = element_text(size = 18, face = "bold"), 
    strip.text.y = element_text(size = 18),
    plot.tag = element_text(size = 30)
    ) +
  labs(x = "Gain-loss differece in risk aversion", y = "Frequency of agent", tag = "(b)") + 
  facet_grid(sim_n~.) -> g

print(g)
ggsave(plot = g, filename = here(output_path, "S11b_RiskPrefDif_RandMulti_First_500T_lat.png"), width = 5.5, height = 18.0, dpi = 400)
```


```{r}
# peak of the histogram

df_choice_gainloss_500T_latter100_first %>% 
  
  dplyr::group_by(sim_n) %>% 
  tidyr::nest() %>% 
  dplyr::mutate(mode_riskavers = purrr::map(data, "risk_aver_gain_loss") %>% purrr::map_dbl(~map_value(.x))) %>% 
  
  dplyr::ungroup() %>% 
  dplyr::select(sim_n, mode_riskavers) %>% 
  formattable::formattable(.)
```


## (S2Table) Table of gain - loss > 0
  

```{r}
# the rate of gain - loss > 0

#webshot::install_phantomjs()

df_choice_gainloss_500T_latter100_first %>% 
  dplyr::mutate(generation = "first") %>% 
  dplyr::bind_rows(df_choice_gainloss_500T_latter100_last %>% dplyr::mutate(generation = "last")) %>% 
  
  dplyr::mutate(
    gain_loss_plus = if_else(risk_aver_gain_loss > 0, "gain > loss", "loss > gain")
  ) %>% 
  dplyr::group_by(sim_n, generation, gain_loss_plus) %>% 
  dplyr::summarise(
    n = n(),
    rate = n/100000
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(gain_loss_plus == "gain > loss") %>% 
  dplyr::select(sim_n, generation, rate) %>% 
  tidyr::pivot_wider(id_cols = sim_n, names_from = "generation", values_from = "rate") ->
  df_gt

df_gt %>% 
  gt() %>% 
  cols_label(sim_n = "condition",
             first = "rate gain > loss in first generation",
             last = "rate gain > loss in last generation") %>% 
  tab_options(
      table.width = pct(30), # expand width of overall table
      table_body.hlines.width = 0, # not include a horizontal line
      column_labels.border.top.width = 2, 
      column_labels.border.top.color = "black", 
      column_labels.border.bottom.width = 1, 
      column_labels.border.bottom.color = "black",
      table.border.top.width = 2,
      table_body.border.top.color = "black", 
      table.border.bottom.width = 2,
      table_body.border.bottom.color = "black"
    ) %>% 
    cols_align(align = "center") %>%
    tab_style(
      style = list(cell_text(align="center")),
      locations = cells_row_groups()
    ) ->
  gt_tab

gtsave(gt_tab, filename = here(output_path, "S11_Table_riskdif.png"), vwidth = 2000, vheight = 4500)
# -> diplayed as S2 Table in Supporting Information
```



# S12 Perseverance parameter：evolutionary dynamics of parameters

## alpha_p and alpha_n

```{r, fig.width = 19.0, fig.height = 7.5, eval=FALSE}
df_gene_randmulti_Psv_summary_longer %>% 
  dplyr::filter(para %in% c("ap", "an")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = "),
    para_rev = case_when(
      para == "ap" ~ "alpha[p]",
      para == "an" ~ "alpha[n]"
    )
  ) -> 
  df_gene_randmulti_Psv_summary_longer_rev

df_gene_randmulti_Psv_longer %>% 
  dplyr::filter(para %in% c("ap", "an")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = "),
    para_rev = case_when(
      para == "ap" ~ "alpha[p]",
      para == "an" ~ "alpha[n]"
    )
  ) %>% 
  
  ggplot(aes(x = generation, y = mean)) + geom_line(aes(group = sim_i), size = 0.08) + 
  geom_line(data = df_gene_randmulti_Psv_summary_longer_rev, aes(x = generation, y = MEAN, color = para), size = 2.0) +
  my_theme2 + labs(x = 'Generation', y = 'Parameter', tag = "(a)") + guides(color = "none") + 
  scale_color_manual(name = "", values = c("#1F78B4", "#FF7F00"), 
                     labels = c(expression(paste(alpha[n])), expression(paste(alpha[p])))) +  
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 15), 
    axis.title = element_text(size = 23, face = "bold"), 
    strip.text.x = element_text(size = 17),
    strip.text.y = element_text(angle = 0),
    plot.tag = element_text(size = 30)
  ) + 
  facet_grid(para_rev~sim_n, 
             labeller = labeller(para_rev = label_parsed)) + 
  coord_cartesian(ylim = c(0, 1.0)) ->
  g

#print(g)
ggsave(plot = g, filename = here(output_path, "S12a_Evo_RandMulti_apan_Psv.png"), width = 19.0, height = 7.5)
```


## $\alpha_p$ and negative area rate


```{r, eval=FALSE}
df_gene_randmulti_Psv_taskinfo_longer %>% 
  dplyr::filter(para %in% c("ap")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) %>% 
  
  ggplot(aes(x = mean_area_rate, y = mean)) + geom_point() + geom_smooth(method = "lm") + 
  my_theme2 + facet_grid(.~sim_n) + 
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 15), 
    axis.title = element_text(size = 25, face = "bold"), 
    strip.text.x = element_text(size = 17),
    strip.text.y = element_text(angle = 0),
    plot.tag = element_text(size = 30)
  ) + 
  labs(x = "Mean negative area rate", y = expression(alpha[p]), 
       tag = "(d)") -> g

ggsave(plot = g, filename = here(output_path, "S12d_Relation_RandMulti_ap_NegaArea_Psv.png"), width = 19.0, height = 6.5)
```



## beta

```{r, fig.width = 19.0, fig.height = 5.0, eval=FALSE}
df_gene_randmulti_Psv_summary_longer %>% 
  dplyr::filter(para %in% c("bt")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) -> 
  df_gene_randmulti_Psv_summary_longer_rev

df_gene_randmulti_Psv_longer %>% 
  dplyr::filter(para %in% c("bt")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) %>% 
  
  ggplot(aes(x = generation, y = mean)) + geom_line(aes(group = sim_i), size = 0.08) + 
  geom_line(data = df_gene_randmulti_Psv_summary_longer_rev, aes(x = generation, y = MEAN, color = para), size = 2.0) +
  my_theme2 + labs(x = 'Generation', y = 'Beta', tag = "(b)") + guides(color = "none") + 
  scale_color_manual(name = "", values = c("#33A02C"), 
                     labels = c(expression(beta))) +  
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 15), 
    axis.title = element_text(size = 23, face = "bold"), 
    strip.text.x = element_text(size = 17),
    strip.text.y = element_text(angle = 0),
    plot.tag = element_text(size = 30)
  ) + 
  facet_grid(.~sim_n, 
             labeller = labeller(para_rev = label_parsed)) + 
  coord_cartesian(ylim = c(0, 0.5)) ->
  g

#print(g)
ggsave(plot = g, filename = here(output_path, "S12b_Evo_RandMulti_bt_Psv.png"), width = 19.0, height = 5.0)
```


## Phi


```{r, fig.width = 19.0, fig.height = 7.5, eval=FALSE}
df_gene_randmulti_Psv_summary_longer %>% 
  dplyr::filter(para %in% c("phi")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) -> 
  df_gene_randmulti_Psv_summary_longer_rev

df_gene_randmulti_Psv_longer %>% 
  dplyr::filter(para %in% c("phi")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) %>% 
  
  ggplot(aes(x = generation, y = mean)) + geom_line(aes(group = sim_i), size = 0.08) + 
  geom_line(data = df_gene_randmulti_Psv_summary_longer_rev, aes(x = generation, y = MEAN, color = "violet"), size = 2.0) +
  my_theme2 + labs(x = 'Generation', y = 'Phi', tag = "(c)") + guides(color = "none") +
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 15), 
    axis.title = element_text(size = 23, face = "bold"), 
    strip.text.x = element_text(size = 17),
    strip.text.y = element_text(angle = 0),
    plot.tag = element_text(size = 30)
  ) + 
  facet_wrap(~sim_n, 
             labeller = labeller(para_rev = label_parsed), ncol = 5) + 
  coord_cartesian(ylim = c(0, 10.0)) ->
  g

#print(g)
ggsave(plot = g, filename = here(output_path, "S12c_Evo_RandMulti_phi_Psv.png"), width = 19.0, height = 5.5)
```


# S13 Perseverance parameter：behavior


## Risk aversion rate of conditions


```{r, fig.width = 20.0, fig.height = 5.0, eval=FALSE}
df_agent_randmulti_Psv_simMEAN %>% 
  
  dplyr::mutate(
    generation = generation + 1,
    task_type_rev = if_else(task_type == "risk_aversion", "risk aversion", "risk seeking")
    ) %>% 
  
  ggplot(aes(x = as.factor(generation), y = MEAN_risk_aversion, color = task_type_rev, group = task_type_rev)) + 
  geom_linerange(aes(ymin = MEAN_risk_aversion - SD_risk_aversion, ymax = MEAN_risk_aversion + SD_risk_aversion), size = 1.5, position = position_dodge(width = 0.5)) + 
  geom_point(size = 3.0, stroke = 1.5, shape = 21, fill = "white", position = position_dodge(width = 0.5)) + 
  my_theme2 + 
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 15), 
    axis.title = element_text(size = 23, face = "bold"), 
    strip.text.x = element_text(size = 17),
    legend.title = element_text(size = 16), #change legend title font size
    legend.text = element_text(size = 16),
    legend.background = element_rect(fill = "transparent"), 
    legend.key = element_rect(fill = "white"), 
    legend.position = c(1, 0.98), 
    legend.justification = c(1, 1),
    plot.tag = element_text(size = 30)
    ) + 
  scale_color_manual(values=c("deepskyblue", "tan3")) + 
  coord_cartesian(ylim = c(0, 1)) + 
  labs(x = "Generation",
       y = "Rate of risk aversion",
       color = "Task",
       tag = "(a)") + 
  guides(fill = 'none') + 
  facet_wrap(~sim_n, ncol = 5) -> g

#print(g)
ggsave(plot = g, filename = here(output_path, "S13a_FirstLastGene_RiskAversion_RandMulti_Psv.png"), width = 18.0, height = 6.0)
```


## Learning dynamics


```{r, eval=FALSE}
df_trial_randmulti_Psv_simMEAN %>% 
  
  dplyr::mutate(
    generation = generation + 1,
    task_type_rev = if_else(task_type == "risk_aversion", "risk aversion", "risk seeking")
    ) %>% 
  
  ggplot(aes(x = trial, y = MEAN_risk_aversion)) + 
  geom_line(aes(x = trial, y = MEAN_risk_aversion, color = task_type_rev), size = 1.2) + 
  geom_ribbon(aes(x = trial, ymin = MEAN_risk_aversion - SD_risk_aversion, ymax = MEAN_risk_aversion + SD_risk_aversion, fill = task_type_rev), alpha = 0.6) + 
  my_theme2 + 
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 15), 
    axis.title = element_text(size = 23, face = "bold"), 
    strip.text.x = element_text(size = 17),
    legend.title = element_text(size = 16), #change legend title font size
    legend.text = element_text(size = 16),
    legend.background = element_rect(fill = "transparent"), 
    legend.key = element_rect(fill = "white"), 
    legend.position = c(1, 1), 
    legend.justification = c(1, 1)
    ) + 
  scale_color_manual(values=c("deepskyblue", "tan3")) + 
  scale_fill_manual(values=c("lightblue3", "goldenrod1")) + 
  coord_cartesian(ylim = c(0, 1)) + 
  labs(x = "Trial",
       y = "Rate of risk aversion",
       color = "Task",
       fill = "Task",
       tag = "(b)") + 
  facet_grid(generation~sim_n, labeller = labeller(generation = label_both)) -> g

ggsave(plot = g, filename = here(output_path, "S13b_Trial_RiskAversion_RandMulti_Psv.png"), width = 18.0, height = 8.0)
```



# S14 Single learning rate: evolutionary dynamics of parameters


## alpha


```{r}
df_gene_randmulti_sLR_summary_longer %>% 
  dplyr::filter(para %in% c("alpha")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) -> 
  df_gene_randmulti_summary_longer_rev

df_gene_randmulti_sLR_longer %>% 
  dplyr::filter(para %in% c("alpha")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) %>% 
  
  ggplot(aes(x = generation, y = mean)) + geom_line(aes(group = sim_i), size = 0.08) + 
  geom_line(data = df_gene_randmulti_summary_longer_rev, aes(x = generation, y = MEAN), size = 2.0, color = "violet") +
  my_theme2 + labs(x = 'Generation', y = 'Alpha', tag = "(a)") + guides(color = "none") + 
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 15), 
    axis.title = element_text(size = 23, face = "bold"), 
    strip.text.x = element_text(size = 17),
    strip.text.y = element_text(angle = 0),
    plot.tag = element_text(size = 30)
  ) + 
  facet_wrap(~sim_n, 
             labeller = labeller(para_rev = label_parsed), ncol = 5) + 
  coord_cartesian(ylim = c(0, 1.0)) ->
  g

#print(g)
ggsave(plot = g, filename = here(output_path, "S14a_Evo_RandMulti_sLR_alpha.png"), width = 19.0, height = 5.0)
```


## beta


```{r}
df_gene_randmulti_sLR_summary_longer %>% 
  dplyr::filter(para %in% c("bt")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) -> 
  df_gene_randmulti_sLR_summary_longer_rev

df_gene_randmulti_sLR_longer %>% 
  dplyr::filter(para %in% c("bt")) %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) %>% 
  
  ggplot(aes(x = generation, y = mean)) + geom_line(aes(group = sim_i), size = 0.08) + 
  geom_line(data = df_gene_randmulti_sLR_summary_longer_rev, aes(x = generation, y = MEAN, color = para), size = 2.0) +
  my_theme2 + labs(x = 'Generation', y = 'Beta', tag = "(b)") + guides(color = "none") + 
  scale_color_manual(name = "", values = c("#33A02C"), 
                     labels = c(expression(beta))) +  
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 15), 
    axis.title = element_text(size = 23, face = "bold"), 
    strip.text.x = element_text(size = 17),
    strip.text.y = element_text(angle = 0),
    plot.tag = element_text(size = 30)
  ) + 
  facet_grid(.~sim_n, 
             labeller = labeller(para_rev = label_parsed)) + 
  coord_cartesian(ylim = c(0, 0.5)) ->
  g
  
ggsave(plot = g, filename = here(output_path, "S14b_Evo_RandMulti_sLR_bt.png"), width = 17.0, height = 5.0)
```


# S15 Single learning rate：behavior


## Risk aversion rate of conditions

```{r}
df_agent_randmulti_sLR_simMEAN %>% 
  
  dplyr::mutate(
    generation = generation + 1,
    task_type_rev = if_else(task_type == "risk_aversion", "risk aversion", "risk seeking")
    ) %>% 
  
  ggplot(aes(x = as.factor(generation), y = MEAN_risk_aversion, color = task_type_rev, group = task_type_rev)) + 
  geom_linerange(aes(ymin = MEAN_risk_aversion - SD_risk_aversion, ymax = MEAN_risk_aversion + SD_risk_aversion), size = 1.5, position = position_dodge(width = 0.5)) + 
  geom_point(size = 3.0, stroke = 1.5, shape = 21, fill = "white", position = position_dodge(width = 0.5)) + 
  my_theme2 + 
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 15), 
    axis.title = element_text(size = 23, face = "bold"), 
    strip.text.x = element_text(size = 17),
    legend.title = element_text(size = 16), #change legend title font size
    legend.text = element_text(size = 16),
    legend.background = element_rect(fill = "transparent"), 
    legend.key = element_rect(fill = "white"), 
    legend.position = c(1, 1), 
    legend.justification = c(1, 1)
  ) + 
  scale_color_manual(values=c("deepskyblue", "tan3")) + 
  coord_cartesian(ylim = c(0, 1)) + 
  labs(x = "Generation",
       y = "Rate of risk aversion",
       color = "Task",
       tag = "(a)") + 
  guides(fill = 'none') + 
  facet_wrap(~sim_n, ncol = 5) -> g

#print(g)
ggsave(plot = g, filename = here(output_path, "S15a_FirstLastGene_RiskAversion_RandMulti_sLR.png"), width = 18.0, height = 6.0)
```


## Learning dynamics

```{r}
df_trial_randmulti_sLR_simMEAN %>% 
  
  dplyr::mutate(
    generation = generation + 1,
    task_type_rev = if_else(task_type == "risk_aversion", "risk aversion", "risk seeking")
    ) %>% 
  
  ggplot(aes(x = trial, y = MEAN_risk_aversion)) + 
  geom_line(aes(x = trial, y = MEAN_risk_aversion, color = task_type_rev), size = 1.2) + 
  geom_ribbon(aes(x = trial, ymin = MEAN_risk_aversion - SD_risk_aversion, ymax = MEAN_risk_aversion + SD_risk_aversion, fill = task_type_rev), alpha = 0.6) + 
  my_theme2 + 
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 15), 
    axis.title = element_text(size = 23, face = "bold"), 
    strip.text.x = element_text(size = 17),
    legend.title = element_text(size = 16), #change legend title font size
    legend.text = element_text(size = 16),
    legend.background = element_rect(fill = "transparent"), 
    legend.key = element_rect(fill = "white"), 
    legend.position = c(1, 1), 
    legend.justification = c(1, 1)
  ) + 
  scale_color_manual(values=c("deepskyblue", "tan3")) + 
  scale_fill_manual(values=c("lightblue3", "goldenrod1")) + 
  coord_cartesian(ylim = c(0, 1)) + 
  labs(x = "Trial",
       y = "Rate of risk aversion",
       color = "Task",
       fill = "Task",
       tag = "(b)") + 
  facet_grid(generation~sim_n, labeller = labeller(generation = label_both)) -> g

ggsave(plot = g, filename = here(output_path, "S15b_Trial_RiskAversion_RandMulti_sLR.png"), width = 18.0, height = 8.0)
```


# S16 Single learning rate：The tasks where the expected values are the same


## Histogram of risk aversion rate 


```{r, fig.width = 15.0, fig.height = 20.0}
# agents of the first generation

df_choice_res_sLR_500T_latter100 %>% 
  
  dplyr::filter(generation == 0) %>% 
  
  ggplot(aes(x = risk_aversion)) + 
  geom_histogram() + 
  my_theme2 + 
  theme(axis.text.x = element_text(size = 18), 
        axis.text.y = element_text(size = 18), 
        axis.title = element_text(size = 26, face = "bold"), 
        strip.text.x = element_text(size = 17),
        plot.tag = element_text(size = 30)
        ) + 
  facet_grid(sim_n~task_struct) + 
  coord_cartesian(ylim = c(0, 90000)) + 
  labs(x = "Rate of risk aversion", y = "Frequency of agent", tag = "(a)") -> g

#print(g)
ggsave(plot = g, filename = here(output_path, "S16a_sLR_RiskPref_RandMulti_First_500T_lat.png"), width = 17.0, height = 24.0, dpi = 400)
```

  

```{r, fig.width = 15.0, fig.height = 20.0}
# agents of the last generation

df_choice_res_sLR_500T_latter100 %>% 
  
  dplyr::filter(generation == 2999) %>% 
  
  ggplot(aes(x = risk_aversion)) + 
  geom_histogram() + 
  my_theme2 + 
  theme(axis.text.x = element_text(size = 18), 
        axis.text.y = element_text(size = 18), 
        axis.title = element_text(size = 26, face = "bold"), 
        strip.text.x = element_text(size = 17),
        plot.tag = element_text(size = 30)
        ) + 
  coord_cartesian(ylim = c(0, 90000)) + 
  facet_grid(sim_n~task_struct) + 
  labs(x = "Rate of risk aversion", y = "Frequency of agent", tag = "(c)") -> g

#print(g)
ggsave(plot = g, filename = here(output_path, "S16c_sLR_RiskPref_RandMulti_Last_500T_lat.png"), width = 17.0, height = 24.0, dpi = 400)
```


## Histogram of difference in gain-loss


```{r, fig.width = 18.0, fig.height = 6.0}
# agents of the first generation

df_choice_gainloss_sLR_500T_latter100_first %>% 
  
  ggplot(aes(x = risk_aver_gain_loss)) + geom_histogram() + 
  geom_vline(xintercept = 0, color = "black") + 
  my_theme2 + 
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 18), 
    axis.title.y = element_text(size = 21, face = "bold"), 
    axis.title.x = element_text(size = 18, face = "bold"), 
    strip.text.y = element_text(size = 18),
    plot.tag = element_text(size = 30)
    ) +
  coord_cartesian(ylim = c(0, 90000)) + 
  labs(x = "Gain-loss differece in risk aversion", y = "Frequency of agent", tag = "(b)") + 
  facet_grid(sim_n~.) -> g

#print(g)
ggsave(plot = g, filename = here(output_path, "S16b_sLR_RiskPrefDif_RandMulti_First_500T_lat.png"), width = 5.5, height = 18.0, dpi = 400)
```



```{r, fig.width = 18.0, fig.height = 6.0}
# agents of the last generation

df_choice_gainloss_sLR_500T_latter100_last %>% 
  
  ggplot(aes(x = risk_aver_gain_loss)) + geom_histogram() + 
  geom_vline(xintercept = 0, color = "black") + 
  my_theme2 + 
  theme(
    axis.text.x = element_text(size = 18), 
    axis.text.y = element_text(size = 18), 
    axis.title.y = element_text(size = 21, face = "bold"), 
    axis.title.x = element_text(size = 18, face = "bold"), 
    strip.text.y = element_text(size = 18),
    plot.tag = element_text(size = 30)
    ) +
  coord_cartesian(ylim = c(0, 90000)) + 
  labs(x = "Gain-loss differece in risk aversion", y = "Frequency of agent", tag = "(d)") + 
  facet_grid(sim_n~.) -> g

#print(g)
ggsave(plot = g, filename = here(output_path, "S16d_sLR_RiskPrefDif_RandMulti_Last_500T_lat.png"), width = 5.5, height = 18.0, dpi = 400)
```


## (S3Table) Table of gain - loss > 0


```{r}
df_choice_gainloss_sLR_500T_latter100_first %>% 
  dplyr::mutate(generation = "first") %>% 
  dplyr::bind_rows(df_choice_gainloss_sLR_500T_latter100_last %>% dplyr::mutate(generation = "last")) %>% 
  
  dplyr::mutate(
    gain_loss_plus = if_else(risk_aver_gain_loss > 0, "gain > loss", "loss > gain")
  ) %>% 
  dplyr::group_by(sim_n, generation, gain_loss_plus) %>% 
  dplyr::summarise(
    n = n(),
    rate = n/100000
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(gain_loss_plus == "gain > loss") %>% 
  dplyr::select(sim_n, generation, rate) %>% 
  tidyr::pivot_wider(id_cols = sim_n, names_from = "generation", values_from = "rate") ->
  df_gt

df_gt %>% 
  gt() %>% 
  cols_label(sim_n = "condition",
             first = "rate gain > loss in first generation",
             last = "rate gain > loss in last generation") %>% 
  tab_options(
      table.width = pct(30), 
      table_body.hlines.width = 0,
      column_labels.border.top.width = 2, 
      column_labels.border.top.color = "black", 
      column_labels.border.bottom.width = 1, 
      column_labels.border.bottom.color = "black",
      table.border.top.width = 2,
      table_body.border.top.color = "black", 
      table.border.bottom.width = 2,
      table_body.border.bottom.color = "black" 
    ) %>% 
    cols_align(align = "center") %>%
    tab_style(
      style = list(cell_text(align="center")), 
      locations = cells_row_groups()
    ) ->
  gt_tab

gtsave(gt_tab, filename = here(output_path, "S16_Table_riskdif.png"), vwidth = 2000, vheight = 4500)
# -> displayed as S3 Table in Supporting Information
```


# S17 Niv index single-task simulations
  
  
- Niv index (alpha_n - alpha_p)/(alpha_n + alpha_p) version of Fig 1b (main text)


```{r, fig.height=20, fig.width=15}
g <- 
  df_first_last_single_riskaverse_D20 %>% 
  dplyr::mutate(task_exp = factor(task_exp) %>% forcats::fct_reorder(., m1)) %>% 
  
  ggplot(aes(x = relative_an_ap, fill = as.factor(generation))) + 
  geom_histogram(position = "identity", alpha = 0.8) + 
  facet_grid(task_exp~task_sd) + 
  my_theme2 + 
  theme(
    strip.text.x = element_text(size = 15),
    strip.text.y = element_text(size = 22),
    axis.title = element_text(size = 27),
    plot.title = element_text(size = 30)
  ) + 
  labs(x = expression((alpha[n] - alpha[p])/(alpha[n] + alpha[p])), fill = "generation",
       title = "Risk-aversion task (D = -20)")

#print(g)
ggsave(plot = g, filename = here(output_path, "S17_single_dif_an_ap_riskaverse.png"), height = 24, width = 20, dpi = 200)
```


```{r, fig.height=20, fig.width=15}
g <- 
  ggplot(df_first_last_single_riskseek_D20, aes(x = relative_an_ap, fill = as.factor(generation))) + 
  geom_histogram(position = "identity", alpha = 0.8) + 
  facet_grid(task_exp~task_sd) + 
  my_theme2 + 
  theme(
    strip.text.x = element_text(size = 15),
    strip.text.y = element_text(size = 22),
    axis.title = element_text(size = 27),
    plot.title = element_text(size = 30)
  ) + 
  labs(x = expression((alpha[n] - alpha[p])/(alpha[n] + alpha[p])), fill = "generation",
       title = "Risk-seeking task (D = +20)")

#print(g)
ggsave(plot = g, filename = here(output_path, "S17_single_dif_an_ap_riskseek.png"), height = 24, width = 20, dpi = 200)
```


# S18 Niv index multiple-task simulations


- Niv index (alpha_n - alpha_p)/(alpha_n + alpha_p) version of Fig 2a (main text) (Only the first and last generation were extracted)


```{r}
g <-
  df_agent_randmulti_an_ap %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = "),
    generation = generation + 1
  ) %>% 
  
  ggplot(aes(x = relative_an_ap, fill = as.factor(generation))) + 
  geom_histogram(position = "identity", alpha = 0.8) + 
  facet_grid(.~sim_n) + 
  my_theme2 + 
  theme(
    axis.text.x = element_text(size = 20),
    axis.text.y = element_text(size = 20),
    axis.title = element_text(size = 26, face = "bold"),
    strip.text.x = element_text(size = 17.5),
    legend.title = element_text(size = 17.5), # change legend title font size
    legend.text = element_text(size = 17),
    plot.tag = element_text(size = 30)
  ) + 
  labs(x = expression((alpha[n] - alpha[p])/(alpha[n] + alpha[p])), fill = "generation")


ggsave(plot = g, filename = here(output_path, "S18_multiple_dif_an_ap.png"), width = 19, height = 7.5, dpi = 200)
```


# S19 Niv index and the choice

```{r}
df_withingene_filtered <-
  df_withingene %>% 
  dplyr::select(sim, m2, sd2, m1, sd1, replication, agent, choice_rate1, ap, an, bt) %>% 
  dplyr::mutate(
    relative_an_ap = (an - ap)/(an + ap),
    rate_risk_aversion = 1 - choice_rate1,
    D = m1 - m2,
    task = if_else(D > 0, "risk seeking", "risk aversion"),
    sim_sort = factor(paste0('N(', m1, ',', sd1, ') vs N(', m2, ',', sd2, ')')) %>% forcats::fct_reorder(., m1)
    ) %>% 
  dplyr::filter(bt == 0.25 & sd1 == 20) # filter by the same tasks in fig 3 of the main text


# -- Risk-aversion tasks

# labels of correlation coefficient
df_cor_est <-
  df_withingene_filtered %>% 
  dplyr::filter(task == "risk aversion") %>% 
  dplyr::group_by(sim_sort) %>% 
  tidyr::nest() %>% 
  dplyr::mutate(
    cor_tibble = purrr::map(data, `[`, c("relative_an_ap", "rate_risk_aversion")) 
  ) %>% 
  dplyr::mutate(
    cor_est = purrr::map2(cor_tibble %>% purrr::map("relative_an_ap"), cor_tibble %>% purrr::map("rate_risk_aversion"), ~cor.test(.x, .y)) %>% purrr::map_dbl("estimate")
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(sim_sort, cor_est) %>% 
  dplyr::mutate(
    cor_est = round(cor_est, digits = 3),
    label = paste0("r = ", format(cor_est, 4))
  )

# make figure
g <- 
  df_withingene_filtered %>% 
  dplyr::filter(task == "risk aversion") %>% 
  
  ggplot(aes(x = relative_an_ap, y = rate_risk_aversion)) +
  geom_point(size = 0.2, alpha = 0.1) + geom_smooth(method = "lm", se = FALSE, linetype = "longdash") + 
  geom_text(data = df_cor_est, aes(label = label),
            x = -0.1, y = 0.05, size = 7.0, hjust = 0, color = "darkorange1", fontface = "bold") + 
  my_theme2 + 
  theme(
    axis.text.x = element_text(size = 14), 
    axis.text.y = element_text(size = 15), 
    axis.title = element_text(size = 22, face = "bold"), 
    strip.text.x = element_text(size = 15),
    legend.text = element_text(size = 15), 
    legend.title = element_text(size = 14)
  ) + 
  facet_grid(.~sim_sort) + 
  labs(x = expression((alpha[n] - alpha[p])/(alpha[n] + alpha[p])), y = "Rate of Risk Aversion", 
       subtitle = "Risk-aversion task")

ggsave(plot = g, filename = here(output_path, "S19_dif_an_ap_beha_riskaverse_coef.png"), width = 18.0, height = 5.0, dpi = 200)


# -- Risk-seeking tasks

# labels of correlation coefficient
df_cor_est <-
  df_withingene_filtered %>% 
  dplyr::filter(task == "risk seeking") %>% 
  dplyr::group_by(sim_sort) %>% 
  tidyr::nest() %>% 
  dplyr::mutate(
    cor_tibble = purrr::map(data, `[`, c("relative_an_ap", "rate_risk_aversion")) 
  ) %>% 
  dplyr::mutate(
    cor_est = purrr::map2(cor_tibble %>% purrr::map("relative_an_ap"), cor_tibble %>% purrr::map("rate_risk_aversion"), ~cor.test(.x, .y)) %>% purrr::map_dbl("estimate")
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(sim_sort, cor_est) %>% 
  dplyr::mutate(
    cor_est = round(cor_est, digits = 3),
    label = paste0("r = ", format(cor_est, 4))
  )

# make figure
g <- 
  df_withingene_filtered %>% 
  dplyr::filter(task == "risk seeking") %>% 
  
  ggplot(aes(x = relative_an_ap, y = rate_risk_aversion)) +
  geom_point(size = 0.2, alpha = 0.1) + geom_smooth(method = "lm", se = FALSE, linetype = "longdash") + 
  geom_text(data = df_cor_est, aes(label = label),
            x = -0.1, y = -0.05, size = 6.5, hjust = 0, color = "darkorange1", fontface = "bold") + 
  my_theme2 + 
  theme(
    axis.text.x = element_text(size = 14), 
    axis.text.y = element_text(size = 15), 
    axis.title = element_text(size = 22, face = "bold"), 
    strip.text.x = element_text(size = 15),
    legend.text = element_text(size = 15), 
    legend.title = element_text(size = 14)
  ) + 
  facet_grid(.~sim_sort) + 
  coord_cartesian(ylim = c(-0.1, 1)) + 
  labs(x = expression((alpha[n] - alpha[p])/(alpha[n] + alpha[p])), y = "Rate of Risk Aversion", 
       subtitle = "Risk-seeking task")

ggsave(plot = g, filename = here(output_path, "S19_dif_an_ap_beha_riskseek_coef.png"), width = 17.0, height = 4.5, dpi = 200)
```



# S20 Effect size of the evolved alphas in single-task simulation

## Histogram of Cohen's d in single-task simulation

```{r}
# Calculate Cohen's d for each task

df_riskaverse_D20_CohenD <-
  df_first_last_single_riskaverse_D20 %>% 
  dplyr::filter(generation == 5000) %>% 
  dplyr::group_by(sd1, task_exp) %>% 
  dplyr::summarise(
    mean_ap = mean(ap),
    mean_an = mean(an),
    sd_ap = sqrt(variance(ap)),
    sd_an = sqrt(variance(an))
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    Cohen_d = EffectSize(mean_ap, sd_ap, mean_an, sd_an),
    abs_Cohen_d = abs(Cohen_d),
    D = -20
  )

df_riskseek_D20_CohenD <-
  df_first_last_single_riskseek_D20 %>% 
  dplyr::filter(generation == 5000) %>% 
  dplyr::group_by(sd1, task_exp) %>% 
  dplyr::summarise(
    mean_ap = mean(ap),
    mean_an = mean(an),
    sd_ap = sqrt(variance(ap)),
    sd_an = sqrt(variance(an))
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    Cohen_d = EffectSize(mean_ap, sd_ap, mean_an, sd_an),
    abs_Cohen_d = abs(Cohen_d),
    D = 20
  )

df_riskaverse_D10_CohenD <-
  df_first_last_single_riskaverse_D10 %>% 
  dplyr::filter(generation == 5000) %>% 
  dplyr::group_by(sd1, task_exp) %>% 
  dplyr::summarise(
    mean_ap = mean(ap),
    mean_an = mean(an),
    sd_ap = sqrt(variance(ap)),
    sd_an = sqrt(variance(an))
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    Cohen_d = EffectSize(mean_ap, sd_ap, mean_an, sd_an),
    abs_Cohen_d = abs(Cohen_d),
    D = -10
  )

df_riskseek_D10_CohenD <-
  df_first_last_single_riskseek_D10 %>% 
  dplyr::filter(generation == 5000) %>% 
  dplyr::group_by(sd1, task_exp) %>% 
  dplyr::summarise(
    mean_ap = mean(ap),
    mean_an = mean(an),
    sd_ap = sqrt(variance(ap)),
    sd_an = sqrt(variance(an))
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    Cohen_d = EffectSize(mean_ap, sd_ap, mean_an, sd_an),
    abs_Cohen_d = abs(Cohen_d),
    D = 10
  )

# make histograms of Cohen's d

g1 <-
  ggplot(df_riskaverse_D20_CohenD, aes(x = Cohen_d)) + geom_histogram() + 
  my_theme2 + 
  theme(
    strip.text.x = element_text(size = 14),
    axis.text.x = element_text(size = 15), 
    axis.text.y = element_text(size = 15),
    plot.title = element_text(size = 20)
  ) + 
  labs(x = "Cohen's d",
       title = "Risk-aversion task (D = -20)") + 
  coord_cartesian(xlim = c(-10, 10))


g2 <-
  ggplot(df_riskseek_D20_CohenD, aes(x = Cohen_d)) + geom_histogram() + 
  my_theme2 + 
  theme(
    strip.text.x = element_text(size = 14),
    axis.text.x = element_text(size = 15), 
    axis.text.y = element_text(size = 15),
    plot.title = element_text(size = 20)
  ) + 
  labs(x = "Cohen's d",
       title = "Risk-seeking task (D = +20)") + 
  coord_cartesian(xlim = c(-10, 10))


g3 <-
  ggplot(df_riskaverse_D10_CohenD, aes(x = Cohen_d)) + geom_histogram() + 
  my_theme2 + 
  theme(
    strip.text.x = element_text(size = 14),
    axis.text.x = element_text(size = 15), 
    axis.text.y = element_text(size = 15),
    plot.title = element_text(size = 20)
  ) + 
  labs(x = "Cohen's d",
       title = "Risk-aversion task (D = -10)") + 
  coord_cartesian(xlim = c(-10, 10))


g4 <-
  ggplot(df_riskseek_D10_CohenD, aes(x = Cohen_d)) + geom_histogram() + 
  my_theme2 + 
  theme(
    strip.text.x = element_text(size = 14),
    axis.text.x = element_text(size = 15), 
    axis.text.y = element_text(size = 15),
    plot.title = element_text(size = 20)
  ) + 
  labs(x = "Cohen's d",
       title = "Risk-seeking task (D = +10)") + 
  coord_cartesian(xlim = c(-10, 10))


g <- g1 + g2 + g3 + g4 + plot_layout(ncol = 2)

ggsave(plot = g, filename = here(output_path, "S20_single_Histogram_CohenD.png"), width = 11, height = 8)
```

## Table of statistics summary of Cohen's d

```{r}
# make a table for statistics of Cohen'd in single-task simulations 

df_CohenD_combined <-
  df_riskaverse_D20_CohenD %>% 
  dplyr::bind_rows(df_riskseek_D20_CohenD, df_riskaverse_D10_CohenD, df_riskseek_D10_CohenD)

gt_single_Range_CohenD <-
  df_CohenD_combined %>% 
  dplyr::mutate(
    task_type = if_else(D < 0, "Risk-aversion task", "Risk-seeking task")
  ) %>% 
  dplyr::group_by(task_type, D) %>% 
  dplyr::summarise(
    min_value = min(Cohen_d),
    max_value = max(Cohen_d),
    mean_value = mean(Cohen_d),
    median_value = median(Cohen_d),
    sd_value = sqrt(variance(Cohen_d))
  ) %>% 
  dplyr::ungroup() %>% 
  
  gt() %>% 
    cols_label(
      task_type = md("Task"),
      min_value = md("Min"), max_value = md("Max"), mean_value = md("Mean"), median_value = md("Median"), sd_value = md("SD")
      ) %>% 
    fmt_number(
      columns = c("min_value", "max_value", "mean_value", "median_value", "sd_value"),
      decimals = 3
    ) %>% 
    tab_options(
      table.width = pct(50),
      table_body.hlines.width = 0, 
      # spannerの下線を適切にするための設定
      column_labels.border.top.width = 2, 
      column_labels.border.top.color = "black", 
      column_labels.border.bottom.width = 1, 
      column_labels.border.bottom.color = "black",
      table.border.top.width = 2,
      table_body.border.top.color = "black", 
      table.border.bottom.width = 2,
      table_body.border.bottom.color = "black" 
      ) %>% 
    cols_align(
      align = "center", columns = c("min_value", "max_value", "mean_value", "median_value", "sd_value")
      ) %>% 
    tab_style(
      style = cell_text(align = "left"),
      locations = cells_title("title")
    ) %>%
    tab_options(
      heading.title.font.size = px(20),
      table.border.top.width = 0, 
      column_labels.border.top.width = 3, 
      column_labels.border.top.color = "black"
    )

gtsave(gt_single_Range_CohenD, filename = here(output_path, "S20_Table_single_statistics_CohenD.png"))
```


## Table of detail of Cohen's d for each task

```{r}
# make a table displaying Cohen's d for each task

# Risk-aversion tasks D = -20

target_simexp <- c("-50 vs -30", "-40 vs -20", "-30 vs -10", "-20 vs 0", "-10 vs 10", "0 vs 20", "10 vs 30")

df_riskaverse_D20_CohenD <-
  df_first_last_single_riskaverse_D20 %>% 
  dplyr::filter(generation == 5000) %>% 
  dplyr::group_by(sd1, task_exp) %>% 
  dplyr::summarise(
    mean_ap = mean(ap),
    mean_an = mean(an),
    sd_ap = sqrt(variance(ap)),
    sd_an = sqrt(variance(an))
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    Cohen_d = EffectSize(mean_ap, sd_ap, mean_an, sd_an)
  ) %>% 
  dplyr::mutate(
    task_exp = factor(task_exp, levels = target_simexp),
    abs_Cohen_d = abs(Cohen_d),
    effect = case_when(
      abs_Cohen_d <= 0.2 ~ "none",
      (abs_Cohen_d > 0.2) & (abs_Cohen_d <= 0.5) ~ "small",
      (abs_Cohen_d > 0.5) & (abs_Cohen_d < 0.8) ~ "medium",
      abs_Cohen_d >= 0.8 ~ "large"
    )
  ) %>% 
  dplyr::arrange(sd1, task_exp) %>% 
  dplyr::select(sd1, task_exp, Cohen_d, effect)


gt_riskaverse_D20_CohenD <-
  df_riskaverse_D20_CohenD %>% 
  gt() %>% 
  cols_label(
    sd1 = md("SD of Risky Op"), task_exp = md("Exp Value (risky vs safe)"), 
    Cohen_d = md("Cohen's d"), effect = md("Effect")
    ) %>% 
  fmt_number(
    columns = c("Cohen_d"),
    decimals = 3
  ) %>% 
  tab_options(table.width = pct(55), # 表全体の幅
        table_body.hlines.width = 0, # tableの中の水平線は引かない
        # spannerの下線を適切にするための設定
        column_labels.border.top.width = 2, 
        column_labels.border.top.color = "black", 
        column_labels.border.bottom.width = 1, 
        column_labels.border.bottom.color = "black",
        table.border.top.width = 2,
        table_body.border.top.color = "black", #最上線は黒
        table.border.bottom.width = 2,
        table_body.border.bottom.color = "black" #最下線は黒
        )  %>% 
  cols_align(align = "center", columns = c("Cohen_d")
    ) %>% 
  tab_header(title = md("Risk-aversion task (D = -20)")) %>% 
  tab_style(
  style = cell_text(align = "left"),
  locations = cells_title("title")) %>%
  tab_options(
    heading.title.font.size = px(20),
    table.border.top.width = 0, #タイトルの上の線はなし
    column_labels.border.top.width = 3, # タイトル下の線はあり 調整のため3
    column_labels.border.top.color = "black"
    )

gtsave(gt_riskaverse_D20_CohenD, filename = here(output_path, "S20_Table_riskaverse_D20_CohenD.png"))
```


```{r}
# make a table displaying Cohen's d for each task

# Risk-seeking tasks D = +20

target_simexp <- c("-10 vs -30", "0 vs -20", "10 vs -10", "20 vs 0", "30 vs 10", "40 vs 20", "50 vs 30")

df_riskseek_D20_CohenD <-
  df_first_last_single_riskseek_D20 %>% 
  dplyr::filter(generation == 5000) %>% 
  dplyr::group_by(sd1, task_exp) %>% 
  dplyr::summarise(
    mean_ap = mean(ap),
    mean_an = mean(an),
    sd_ap = sqrt(variance(ap)),
    sd_an = sqrt(variance(an))
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    Cohen_d = EffectSize(mean_ap, sd_ap, mean_an, sd_an)
  ) %>% 
  dplyr::mutate(
    task_exp = factor(task_exp, levels = target_simexp)
  ) %>% 
  dplyr::arrange(sd1, task_exp) %>% 
  dplyr::mutate(
    task_exp = factor(task_exp, levels = target_simexp),
    abs_Cohen_d = abs(Cohen_d),
    effect = case_when(
      abs_Cohen_d <= 0.2 ~ "none",
      (abs_Cohen_d > 0.2) & (abs_Cohen_d <= 0.5) ~ "small",
      (abs_Cohen_d > 0.5) & (abs_Cohen_d < 0.8) ~ "medium",
      abs_Cohen_d >= 0.8 ~ "large"
    )
  ) %>% 
  dplyr::arrange(sd1, task_exp) %>% 
  dplyr::select(sd1, task_exp, Cohen_d, effect)

gt_riskseek_D20_CohenD <-
  df_riskseek_D20_CohenD %>% 
  gt() %>% 
  cols_label(
    sd1 = md("SD of Risky Op"), task_exp = md("Exp Value (risky vs safe)"), 
    Cohen_d = md("Cohen's d"), effect = md("Effect")
    ) %>% 
  fmt_number(
    columns = c("Cohen_d"),
    decimals = 3
  ) %>% 
  tab_options(table.width = pct(55), 
        table_body.hlines.width = 0, 
        # spannerの下線を適切にするための設定
        column_labels.border.top.width = 2, 
        column_labels.border.top.color = "black", 
        column_labels.border.bottom.width = 1, 
        column_labels.border.bottom.color = "black",
        table.border.top.width = 2,
        table_body.border.top.color = "black", 
        table.border.bottom.width = 2,
        table_body.border.bottom.color = "black" 
        )  %>% 
  cols_align(align = "center", columns = c("Cohen_d")
    ) %>% 
  tab_header(title = md("Risk-seeking task (D = +20)")) %>% 
  tab_style(
  style = cell_text(align = "left"),
  locations = cells_title("title")) %>%
  tab_options(
    heading.title.font.size = px(20),
    table.border.top.width = 0, 
    column_labels.border.top.width = 3, 
    column_labels.border.top.color = "black"
    )

gtsave(gt_riskseek_D20_CohenD, filename = here(output_path, "S18_Table_riskseek_D20_CohenD.png"))
```


```{r}
# Risk-aversion D = -10

target_simexp <- c("-40 vs -30", "-30 vs -20", "-20 vs -10", "-10 vs 0", "0 vs 10", "10 vs 20", "20 vs 30")

df_riskaverse_D10_CohenD <-
  df_first_last_single_riskaverse_D10 %>% 
  dplyr::filter(generation == 5000) %>% 
  dplyr::group_by(sd1, task_exp) %>% 
  dplyr::summarise(
    mean_ap = mean(ap),
    mean_an = mean(an),
    sd_ap = sqrt(variance(ap)),
    sd_an = sqrt(variance(an))
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    Cohen_d = EffectSize(mean_ap, sd_ap, mean_an, sd_an)
  ) %>% 
  dplyr::mutate(
    task_exp = factor(task_exp, levels = target_simexp),
    abs_Cohen_d = abs(Cohen_d),
    effect = case_when(
      abs_Cohen_d <= 0.2 ~ "none",
      (abs_Cohen_d > 0.2) & (abs_Cohen_d <= 0.5) ~ "small",
      (abs_Cohen_d > 0.5) & (abs_Cohen_d < 0.8) ~ "medium",
      abs_Cohen_d >= 0.8 ~ "large"
    )
  ) %>% 
  dplyr::arrange(sd1, task_exp) %>% 
  dplyr::select(sd1, task_exp, Cohen_d, effect)

gt_riskaverse_D10_CohenD <-
  df_riskaverse_D10_CohenD %>% 
  gt() %>% 
  cols_label(
    sd1 = md("SD of Risky Op"), task_exp = md("Exp Value (risky vs safe)"), 
    Cohen_d = md("Cohen's d"), effect = md("Effect")
    ) %>% 
  fmt_number(
    columns = c("Cohen_d"),
    decimals = 3
  ) %>% 
  tab_options(table.width = pct(55), 
        table_body.hlines.width = 0, 
        # spannerの下線を適切にするための設定
        column_labels.border.top.width = 2, 
        column_labels.border.top.color = "black", 
        column_labels.border.bottom.width = 1, 
        column_labels.border.bottom.color = "black",
        table.border.top.width = 2,
        table_body.border.top.color = "black", 
        table.border.bottom.width = 2,
        table_body.border.bottom.color = "black" 
        )  %>% 
  cols_align(align = "center", columns = c("Cohen_d")
    ) %>% 
  tab_header(title = md("Risk-aversion task (D = -10)")) %>% 
  tab_style(
  style = cell_text(align = "left"),
  locations = cells_title("title")) %>%
  tab_options(
    heading.title.font.size = px(20),
    table.border.top.width = 0, 
    column_labels.border.top.width = 3, 
    column_labels.border.top.color = "black"
    )

gtsave(gt_riskaverse_D10_CohenD, filename = here(output_path, "S18_Table_riskaverse_D10_CohenD.png"))
```


```{r}
# Risk-seeking tasks D = +10
target_simexp <- c("-20 vs -30", "-10 vs -20", "0 vs -10", "10 vs 0", "20 vs 10", "30 vs 20", "40 vs 30")

df_riskseek_D10_CohenD <-
  df_first_last_single_riskseek_D10 %>% 
  dplyr::filter(generation == 5000) %>% 
  dplyr::group_by(sd1, task_exp) %>% 
  dplyr::summarise(
    mean_ap = mean(ap),
    mean_an = mean(an),
    sd_ap = sqrt(variance(ap)),
    sd_an = sqrt(variance(an))
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    Cohen_d = EffectSize(mean_ap, sd_ap, mean_an, sd_an)
  ) %>% 
  dplyr::mutate(
    task_exp = factor(task_exp, levels = target_simexp),
    abs_Cohen_d = abs(Cohen_d),
    effect = case_when(
      abs_Cohen_d <= 0.2 ~ "none",
      (abs_Cohen_d > 0.2) & (abs_Cohen_d <= 0.5) ~ "small",
      (abs_Cohen_d > 0.5) & (abs_Cohen_d < 0.8) ~ "medium",
      abs_Cohen_d >= 0.8 ~ "large"
    )
  ) %>% 
  dplyr::arrange(sd1, task_exp) %>% 
  dplyr::select(sd1, task_exp, Cohen_d, effect)

gt_riskseek_D10_CohenD <-
  df_riskseek_D10_CohenD %>% 
  gt() %>% 
  cols_label(
    sd1 = md("SD of Risky Op"), task_exp = md("Exp Value (risky vs safe)"), 
    Cohen_d = md("Cohen's d"), effect = md("Effect")
    ) %>% 
  fmt_number(
    columns = c("Cohen_d"),
    decimals = 3
  ) %>% 
  tab_options(
    table.width = pct(55), 
    table_body.hlines.width = 0, 
    # spannerの下線を適切にするための設定
    column_labels.border.top.width = 2, 
    column_labels.border.top.color = "black", 
    column_labels.border.bottom.width = 1, 
    column_labels.border.bottom.color = "black",
    table.border.top.width = 2,
    table_body.border.top.color = "black", 
    table.border.bottom.width = 2,
    table_body.border.bottom.color = "black" 
    )  %>% 
  cols_align(align = "center", columns = c("Cohen_d")
    ) %>% 
  tab_header(title = md("Risk-seeking task (D = +10)")) %>% 
  tab_style(
  style = cell_text(align = "left"),
  locations = cells_title("title")) %>%
  tab_options(
    heading.title.font.size = px(20),
    table.border.top.width = 0, 
    column_labels.border.top.width = 3, 
    column_labels.border.top.color = "black"
    )

gtsave(gt_riskseek_D10_CohenD, filename = here(output_path, "S18_Table_riskseek_D10_CohenD.png"))
```


# S21 Histogram of Cohen's d in multipe-task simulation

```{r}
# Calculate Cohen's d for each simulation in the multiple-task simulations

df_multiple_CohenD <-
  df_agent_randmulti_an_ap %>% 
  dplyr::filter(generation == 2999) %>% 
  dplyr::group_by(sim, sim_i, mean_area_rate) %>% 
  dplyr::summarise(
    mean_ap = mean(ap),
    mean_an = mean(an),
    sd_ap = sqrt(variance(ap)),
    sd_an = sqrt(variance(an))
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    Cohen_d = EffectSize(mean_ap, sd_ap, mean_an, sd_an)
  ) %>% 
  dplyr::mutate(
    abs_Cohen_d = abs(Cohen_d),
    effect = case_when(
      abs_Cohen_d <= 0.2 ~ "none",
      (abs_Cohen_d > 0.2) & (abs_Cohen_d <= 0.5) ~ "small",
      (abs_Cohen_d > 0.5) & (abs_Cohen_d < 0.8) ~ "medium",
      abs_Cohen_d >= 0.8 ~ "large"
    )
  ) %>% 
  dplyr::select(sim, sim_i, Cohen_d, abs_Cohen_d, effect, mean_area_rate) 
```


```{r}
# make histogram of Cohen's d of multiple-task simulations
g <- 
  df_multiple_CohenD %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) %>% 
  
  ggplot(aes(x = Cohen_d)) + geom_histogram() + 
  my_theme2 + 
  theme(
    strip.text.x = element_text(size = 18),
    axis.text.x = element_text(size = 15), 
    axis.text.y = element_text(size = 15),
    plot.title = element_text(size = 20)
  ) + 
  labs(x = "Cohen's d") + 
  facet_wrap(~sim_n, ncol = 5)

ggsave(plot = g, filename = here(output_path, "S21_multiple_Histogram_CohenD.png"), width = 18.0, height = 6.0, dpi = 400)
```

## Table of statistics summary of Cohen's d

```{r}
# make a table for statistics of Cohen'd in multiple-task simulations

gt_multiple_CohenD <-
  df_multiple_CohenD %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) %>% 
  
  dplyr::group_by(sim_n) %>% 
  dplyr::summarise(
    min_value = min(Cohen_d),
    max_value = max(Cohen_d),
    mean_value = mean(Cohen_d),
    median_value = median(Cohen_d),
    sd_value = sqrt(variance(Cohen_d))
  ) %>% 
  
  gt() %>% 
  cols_label(
    sim_n = md("Simulation Condition"), min_value = md("Min"), max_value = md("Max"), mean_value = md("Mean"), median_value = md("Median"), sd_value = md("SD")
    ) %>% 
  fmt_number(
    columns = c("min_value", "max_value", "mean_value", "median_value", "sd_value"),
    decimals = 3
  ) %>% 
  cols_align(align = "center", columns = c("min_value", "max_value", "mean_value", "median_value", "sd_value") ) %>% 
  tab_options(
    table.width = pct(60), # 表全体の幅をやや拡げる
    table_body.hlines.width = 0, # tableの中の水平線は引かない
    # spannerの下線を適切にするための設定
    column_labels.border.top.width = 2, 
    column_labels.border.top.color = "black", 
    column_labels.border.bottom.width = 1, 
    column_labels.border.bottom.color = "black",
    table.border.top.width = 2,
    table_body.border.top.color = "black", #最上線は黒
    table.border.bottom.width = 2,
    table_body.border.bottom.color = "black" #最下線は黒
  )  %>% 
  tab_header(title = md("Multiple-Task Simulation")) %>% 
  tab_style(
    style = cell_text(align = "left"),
    locations = cells_title("title")
  ) %>%
  tab_options(
    heading.title.font.size = px(20),
    table.border.top.width = 0, #タイトルの上の線はなし
    column_labels.border.top.width = 3, # タイトル下の線はあり 調整のため3
    column_labels.border.top.color = "black"
    )

gtsave(gt_multiple_CohenD, filename = here(output_path, "S21_Table_multiple_statistics_CohenD.png"))
```


## Table of effect size summary

```{r}
# make a table for summary of Cohen'd size (large, medium, small) in multiple-task simulations

df_multiple_CohenD_summary <-
  df_multiple_CohenD %>% 
  dplyr::mutate(
    sim_n = sim %>% str_replace(pattern = "cond_", replacement = "risk seeking/aversion = ")
  ) %>% 
  dplyr::group_by(sim_n, effect) %>% 
  dplyr::summarise(
    N = n()
  ) %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(id_cols = sim_n, names_from = effect, values_from = N, values_fill = 0) %>% 
  dplyr::select(sim_n, large, medium, small, none) 

gt_multiple_CohenD_summary <-
  df_multiple_CohenD_summary %>% 
  gt() %>% 
  cols_label(
    sim_n = md("Simulation Condition")
    ) %>% 
  tab_spanner(label = "Effect", columns = c("large", "medium", "small", "none")) %>%
  tab_options(
    table.width = pct(50), 
    table_body.hlines.width = 0,
    # spannerの下線を適切にするための設定
    column_labels.border.top.width = 2, 
    column_labels.border.top.color = "black", 
    column_labels.border.bottom.width = 1, 
    column_labels.border.bottom.color = "black",
    table.border.top.width = 2,
    table_body.border.top.color = "black",
    table.border.bottom.width = 2,
    table_body.border.bottom.color = "black"
        )  %>% 
  cols_align(align = "center", columns = c("large", "medium", "small", "none")
    ) %>% 
  tab_header(title = md("Multiple-Task Simulation")) %>% 
  tab_style(
  style = cell_text(align = "left"),
  locations = cells_title("title")) %>%
  tab_options(
    heading.title.font.size = px(20),
    table.border.top.width = 0, #タイトルの上の線はなし
    column_labels.border.top.width = 3, # タイトル下の線はあり 調整のため3
    column_labels.border.top.color = "black"
    )

gtsave(gt_multiple_CohenD_summary, filename = here(output_path, "S21_Table_multiple_CohenD_summary.png"))
```


# S22 Ratio of SD of the alphas

## Histogram of Ratio of (SD alpha_p)/(SD alpha_n)

```{r}
df_riskaverse_D20_sd_ratio <-
  df_first_last_single_riskaverse_D20 %>% 
  dplyr::filter(generation == 5000) %>% 
  dplyr::group_by(sd1, task_exp) %>% 
  dplyr::summarise(
    mean_ap = mean(ap),
    mean_an = mean(an),
    sd_ap = sqrt(variance(ap)),
    sd_an = sqrt(variance(an))
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    sd_ratio = sd_ap/sd_an
  ) %>% 
  dplyr::select(sd1, task_exp, sd_ratio)


df_riskseek_D20_sd_ratio <-
  df_first_last_single_riskseek_D20 %>% 
  dplyr::filter(generation == 5000) %>% 
  dplyr::group_by(sd1, task_exp) %>% 
  dplyr::summarise(
    mean_ap = mean(ap),
    mean_an = mean(an),
    sd_ap = sqrt(variance(ap)),
    sd_an = sqrt(variance(an))
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    sd_ratio = sd_ap/sd_an
  ) %>% 
  dplyr::select(sd1, task_exp, sd_ratio)


df_riskaverse_D10_sd_ratio <-
  df_first_last_single_riskaverse_D10 %>% 
  dplyr::filter(generation == 5000) %>% 
  dplyr::group_by(sd1, task_exp) %>% 
  dplyr::summarise(
    mean_ap = mean(ap),
    mean_an = mean(an),
    sd_ap = sqrt(variance(ap)),
    sd_an = sqrt(variance(an))
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    sd_ratio = sd_ap/sd_an
  ) %>% 
  dplyr::select(sd1, task_exp, sd_ratio)


df_riskseek_D10_sd_ratio <-
  df_first_last_single_riskseek_D10 %>% 
  dplyr::filter(generation == 5000) %>% 
  dplyr::group_by(sd1, task_exp) %>% 
  dplyr::summarise(
    mean_ap = mean(ap),
    mean_an = mean(an),
    sd_ap = sqrt(variance(ap)),
    sd_an = sqrt(variance(an))
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    sd_ratio = sd_ap/sd_an
  ) %>% 
  dplyr::select(sd1, task_exp, sd_ratio)


g1 <-
  ggplot(df_riskaverse_D20_sd_ratio, aes(x = sd_ratio)) + geom_histogram() + 
    geom_vline(xintercept = 1, color = "tomato", size = 1.7) + 
  my_theme2 + 
  theme(
    strip.text.x = element_text(size = 14),
    axis.text.x = element_text(size = 15), 
    axis.text.y = element_text(size = 15),
    plot.title = element_text(size = 20)
  ) + 
  labs(x = "SD Ratio (alpha_p / alpha_n)",
       title = "Risk-aversion task (D = -20)") + 
  coord_cartesian(xlim = c(0, 5))


g2 <-
  ggplot(df_riskseek_D20_sd_ratio, aes(x = sd_ratio)) + geom_histogram() + 
    geom_vline(xintercept = 1, color = "tomato", size = 1.7) + 
  my_theme2 + 
  theme(
    strip.text.x = element_text(size = 14),
    axis.text.x = element_text(size = 15), 
    axis.text.y = element_text(size = 15),
    plot.title = element_text(size = 20)
  ) + 
  labs(x = "SD Ratio (alpha_p / alpha_n)",
       title = "Risk-seeking task (D = +20)") + 
  coord_cartesian(xlim = c(0, 5))


g3 <-
  ggplot(df_riskaverse_D10_sd_ratio, aes(x = sd_ratio)) + geom_histogram() + 
    geom_vline(xintercept = 1, color = "tomato", size = 1.7) + 
  my_theme2 + 
  theme(
    strip.text.x = element_text(size = 14),
    axis.text.x = element_text(size = 15), 
    axis.text.y = element_text(size = 15),
    plot.title = element_text(size = 20)
  ) + 
  labs(x = "SD Ratio (alpha_p / alpha_n)",
       title = "Risk-aversion task (D = -10)") + 
  coord_cartesian(xlim = c(0, 5))


g4 <-
  ggplot(df_riskseek_D10_sd_ratio, aes(x = sd_ratio)) + geom_histogram() + 
    geom_vline(xintercept = 1, color = "tomato", size = 1.7) + 
  my_theme2 + 
  theme(
    strip.text.x = element_text(size = 14),
    axis.text.x = element_text(size = 15), 
    axis.text.y = element_text(size = 15),
    plot.title = element_text(size = 20)
  ) + 
  labs(x = "SD Ratio (alpha_p / alpha_n)",
       title = "Risk-seeking task (D = +10)") + 
  coord_cartesian(xlim = c(0, 5))


g <- g1 + g2 + g3 + g4 + plot_layout(ncol = 2)

ggsave(plot = g, filename = here(output_path, "S22_single_Histogram_SDratio.png"), width = 11, height = 8, dpi = 400)
```

## Table of statistics summary of SD Ratio

```{r}
gt_SD_ratio_summary <-
  df_riskaverse_D20_sd_ratio %>% 
  dplyr::mutate(
    task_type = "Risk-aversion task",
    D = -20
  ) %>% 
  dplyr::bind_rows(
    df_riskseek_D20_sd_ratio %>% dplyr::mutate(task_type = "Risk-seeking task", D = 20), 
    df_riskaverse_D10_sd_ratio %>% dplyr::mutate(task_type = "Risk-aversion task", D = -10), 
    df_riskseek_D10_sd_ratio %>% dplyr::mutate(task_type = "Risk-seeking task", D = 10)
  ) %>% 
  dplyr::group_by(task_type, D) %>% 
  dplyr::summarise(
    min_value = min(sd_ratio),
    max_value = max(sd_ratio),
    mean_value = mean(sd_ratio),
    median_value = median(sd_ratio),
    sd_value = sqrt(variance(sd_ratio))
  ) %>% 
  dplyr::ungroup() %>% 

  gt() %>% 
    cols_label(
      task_type = md("Task"),
      min_value = md("Min"), max_value = md("Max"), mean_value = md("Mean"), median_value = md("Median"), sd_value = md("SD")
      ) %>% 
    fmt_number(
      columns = c("min_value", "max_value", "mean_value", "median_value", "sd_value"),
      decimals = 3
    ) %>% 
    tab_options(
      table.width = pct(50), # 表全体の幅をやや拡げる
      table_body.hlines.width = 0, # tableの中の水平線は引かない
      # spannerの下線を適切にするための設定
      column_labels.border.top.width = 2, 
      column_labels.border.top.color = "black", 
      column_labels.border.bottom.width = 1, 
      column_labels.border.bottom.color = "black",
      table.border.top.width = 2,
      table_body.border.top.color = "black", #最上線は黒
      table.border.bottom.width = 2,
      table_body.border.bottom.color = "black" #最下線は黒
      )  %>% 
    cols_align(
      align = "center", columns = c("min_value", "max_value", "mean_value", "median_value", "sd_value")
      ) %>% 
    tab_style(
      style = cell_text(align = "left"),
      locations = cells_title("title")
    ) %>%
    tab_options(
      heading.title.font.size = px(20),
      table.border.top.width = 0, #タイトルの上の線はなし
      column_labels.border.top.width = 3, # タイトル下の線はあり 調整のため3
      column_labels.border.top.color = "black"
      )

gtsave(gt_SD_ratio_summary, filename = here(output_path, "S22_Table statistics_SDratio.png"))
```


# Table: logistic regression for the risk aversion/seeking

  
logistic multi-regression analysis for the data of Fig 3.
  
- dependent variable: time of risk aversion (how many times of 500 trials an agent chose the safe option)

- independent variable: alpha_p and alpha_n


```{r}
# make df for regression analysis
nested_df_withingene <-
  df_withingene %>%
  dplyr::mutate(
    rate_risk_aversion = 1 - choice_rate1,
    time_risk_aversion = rate_risk_aversion * 500
  ) %>% 
  dplyr::select(sim, m2, sd2, m1, sd1, replication, agent, rate_risk_aversion, time_risk_aversion, ap, an, bt) %>% 
  dplyr::group_by(sim, m2, sd2, m1, sd1, bt) %>% 
  tidyr::nest() %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    D = m1 - m2,
    task = if_else(D > 0, "risk seeking", "risk aversion"),
    sim_sort = factor(paste0('N(', m1, ',', sd1, ') vs N(', m2, ',', sd2, ')')) %>% forcats::fct_reorder(., m1)
  )


# filter by the data of Fig 3
nested_df_withingene_025_sd20 <-
  nested_df_withingene %>% 
  dplyr::filter(bt == 0.25 & sd1 == 20)

# conduct regression analysis for each task and save it as res_model
res_model <-
  nested_df_withingene_025_sd20 %>% 
  dplyr::mutate(
    model_logistic_regression = map(data, ~glm(cbind(time_risk_aversion, 500 - time_risk_aversion) ~ ap + an, data = ., family = binomial)) # logistic regression analysis by glm() 
  ) %>% 
  dplyr::mutate( # extract estimated parameters (intercept and coefficients)
    coef_intercept = purrr::map(model_logistic_regression, "coefficients") %>% purrr::map_dbl(1),
    coef_ap = purrr::map(model_logistic_regression, "coefficients") %>% purrr::map_dbl(2),
    coef_an = purrr::map(model_logistic_regression, "coefficients") %>% purrr::map_dbl(3)
  ) %>% 
  dplyr::arrange(task)
```


```{r}
# make a table for estimated parameters 

# risk-aversion task
gt_res_model_riskaversion <-
  res_model %>% 
  dplyr::select(task, sim_sort, coef_intercept, coef_an, coef_ap) %>% 
  dplyr::filter(task == "risk aversion") %>% 
  dplyr::select(-task) %>% 
  dplyr::arrange(sim_sort) %>% 
  
  gt() %>% 
  cols_label(
    sim_sort = md("Task"), coef_intercept = md("Intercept"), 
    coef_an = md("alpha n"), coef_ap = md("alpha p")
    ) %>% 
  fmt_number(
    columns = c("coef_intercept", "coef_an", "coef_ap"),
    decimals = 3
  ) %>% 
  tab_options(table.width = pct(50), # 表全体の幅をやや拡げる
        table_body.hlines.width = 0, # tableの中の水平線は引かない
        # spannerの下線を適切にするための設定
        column_labels.border.top.width = 2, 
        column_labels.border.top.color = "black", 
        column_labels.border.bottom.width = 1, 
        column_labels.border.bottom.color = "black",
        table.border.top.width = 2,
        table_body.border.top.color = "black", #最上線は黒
        table.border.bottom.width = 2,
        table_body.border.bottom.color = "black" #最下線は黒
        )  %>% 
  cols_align(
    align = "center", columns = c("coef_intercept", "coef_an", "coef_ap")
  ) %>% 
  cols_align(
    align = "left", columns = c("sim_sort")
  ) %>% 
  tab_header(title = md("Risk-aversion task (D = -20, beta = 0.25)")) %>% 
  tab_style(
    style = cell_text(align = "left"),
    locations = cells_title("title")
  ) %>%
  tab_options(
    heading.title.font.size = px(20),
    table.border.top.width = 0, #タイトルの上の線はなし
    column_labels.border.top.width = 3, # タイトル下の線はあり 調整のため3
    column_labels.border.top.color = "black"
    )

gtsave(gt_res_model_riskaversion, filename = here(output_path, "Table_res_logistic_model_riskaversion.png"))


# risk-seeking task
gt_res_model_riskseeking <-
  res_model %>% 
  dplyr::select(task, sim_sort, coef_intercept, coef_an, coef_ap) %>% 
  dplyr::filter(task == "risk seeking") %>% 
  dplyr::select(-task) %>% 
  dplyr::arrange(sim_sort) %>% 
  
  gt() %>% 
  cols_label(
    sim_sort = md("Task"), coef_intercept = md("Intercept"), 
    coef_an = md("alpha n"), coef_ap = md("alpha p")
    ) %>% 
  fmt_number(
    columns = c("coef_intercept", "coef_an", "coef_ap"),
    decimals = 3
  ) %>% 
  tab_options(table.width = pct(50), # 表全体の幅をやや拡げる
        table_body.hlines.width = 0, # tableの中の水平線は引かない
        # spannerの下線を適切にするための設定
        column_labels.border.top.width = 2, 
        column_labels.border.top.color = "black", 
        column_labels.border.bottom.width = 1, 
        column_labels.border.bottom.color = "black",
        table.border.top.width = 2,
        table_body.border.top.color = "black", #最上線は黒
        table.border.bottom.width = 2,
        table_body.border.bottom.color = "black" #最下線は黒
        )  %>% 
  cols_align(
    align = "center", columns = c("coef_intercept", "coef_an", "coef_ap")
  ) %>% 
  cols_align(
    align = "left", columns = c("sim_sort")
  ) %>% 
  tab_header(title = md("Risk-seeking task (D = +20, beta = 0.25)")) %>% 
  tab_style(
    style = cell_text(align = "left"),
    locations = cells_title("title")
  ) %>%
  tab_options(
    heading.title.font.size = px(20),
    table.border.top.width = 0, #タイトルの上の線はなし
    column_labels.border.top.width = 3, # タイトル下の線はあり 調整のため3
    column_labels.border.top.color = "black"
    )

gtsave(gt_res_model_riskseeking, filename = here(output_path, "Table_res_logistic_model_riskseeking.png"))
```


# S23 Magnified heatmap (Fig 3)


- Magnify the Fig 3 by dividing the y-axis (alpha_n) by 0.1


```{r}
# extract the case where risk of risky option = 20 of risk-aversion tasks

target_sim <- as.factor(c(
 "30.5.10.20", "20.5.0.20", "10.5.-10.20", "0.5.-20.20", "-10.5.-30.20", "-20.5.-40.20", "-30.5.-50.20"
))

df_rev <- 
  df_withingene %>%
  dplyr::filter(sim %in% target_sim) %>% 
  dplyr::mutate(
    ap = round(ap, 4),
    an = round(an, 4),
    bt = round(bt, 4),
    rate_risk_aversion = 1 - choice_rate1,
    sim_fac = factor(sim, levels = target_sim) %>% as.numeric()
  ) %>% 
  dplyr::mutate(
    sim_sort = factor(paste0('N(', m1, ',', sd1, ') vs N(', m2, ',', sd2, ')')) %>% forcats::fct_reorder(., sim_fac, .desc = TRUE)
  ) %>%
  dplyr::group_by(sim_sort, ap, an, bt) %>%
  dplyr::summarise(
    mean_pvalue = mean(average_pvalue), 
    sd_pvalue = sqrt(variance(average_pvalue)),
    mean_risk_aversion = mean(rate_risk_aversion),
    sd_risk_aversion = sqrt(variance(rate_risk_aversion))
  ) %>%
  dplyr::filter(bt == 0.25) %>% 
  dplyr::mutate(an_group = cut(an, seq(from = 0, to = 1.0, by = 0.1))) %>% # divide alpha_n by 0.1
  dplyr::group_by(an_group) %>% 
  dplyr::group_split()


# for each range (e.g., 0~0.1, 0.1~0.2,...), make the figure
g_list <- NULL

for (i in 1:10) {
  
  df_filtered <- df_rev[[i]]
  
  g_title <- df_filtered$an_group %>% unique(.)
  
  g <-
    ggplot(data =  df_filtered, aes(x = ap, y = an)) + 
    geom_raster(aes(fill = mean_risk_aversion)) + 
    my_theme2 + 
    theme(
      axis.text.x = element_text(size = 14, angle = 30, hjust = 1), 
      axis.text.y = element_text(size = 16), 
      axis.title = element_text(size = 23, face = "bold"), 
      strip.text.x = element_text(size = 15),
      legend.text = element_text(size = 14), 
      legend.title = element_text(size = 15), 
      panel.grid = element_blank()
      ) + 
    scale_fill_gradient2(midpoint = 0.5, low = "#FF7F00", mid = "white", high = "#1F78B4", limits = c(0, 1)) + 
    facet_grid(.~sim_sort) + 
    labs(x = expression(alpha[p]), y = expression(alpha[n]), fill = "Risk aversion",
         subtitle = paste0("Risk-aversion task; alpha_n = ", g_title))
  
  g_list <- c(g_list, list(g))
  
}

g1_5 <- purrr::reduce(g_list[1:5], `+`) + plot_layout(ncol = 1)

g6_10 <- purrr::reduce(g_list[6:10], `+`) + plot_layout(ncol = 1)

ggsave(plot = g1_5, filename = here(output_path, paste0("S23.1_MagnifiedHeatmap_riskaversion_1-5.png")), width = 18.0, height = 24.0, dpi = 200)

ggsave(plot = g6_10, filename = here(output_path, paste0("S23.2_MagnifiedHeatmap_riskaversion_6-10.png")), width = 18.0, height = 24.0, dpi = 200)
```



# Session Info

- RStudio Version：2023.12.1.402

```{r, eval = FALSE}
RStudio.Version()$version
```

- Packages

```{r}
sessionInfo()

# output

# R version 4.1.0 (2021-05-18)
# Platform: x86_64-apple-darwin17.0 (64-bit)
# Running under: macOS 13.6.7
# 
# Matrix products: default
# LAPACK: /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRlapack.dylib
# 
# locale:
# [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
# 
# attached base packages:
# [1] stats     graphics  grDevices utils     datasets  methods   base     
# 
# other attached packages:
#  [1] webshot2_0.1.0    gt_0.4.0          patchwork_1.1.1   data.table_1.14.6 here_1.0.1        forcats_0.5.1    
#  [7] stringr_1.4.0     dplyr_1.0.8       purrr_0.3.4       readr_2.1.2       tidyr_1.2.0       tibble_3.1.6     
# [13] ggplot2_3.3.5     tidyverse_1.3.1  
# 
# loaded via a namespace (and not attached):
#  [1] httr_1.4.2        sass_0.4.1        jsonlite_1.8.0    splines_4.1.0     modelr_0.1.8      assertthat_0.2.1 
#  [7] cellranger_1.1.0  yaml_2.3.5        pillar_1.7.0      backports_1.4.1   lattice_0.20-45   glue_1.6.2       
# [13] digest_0.6.29     promises_1.2.0.1  checkmate_2.0.0   rvest_1.0.2       colorspace_2.0-3  Matrix_1.4-1     
# [19] websocket_1.4.1   htmltools_0.5.2   pkgconfig_2.0.3   broom_0.7.12      haven_2.4.3       scales_1.1.1     
# [25] webshot_0.5.2     processx_3.5.3    later_1.3.0       tzdb_0.3.0        mgcv_1.8-39       generics_0.1.2   
# [31] farver_2.1.0      ellipsis_0.3.2    withr_2.5.0       cli_3.6.2         magrittr_2.0.2    crayon_1.5.1     
# [37] readxl_1.4.0      evaluate_0.15     ps_1.6.0          fs_1.5.2          fansi_1.0.3       nlme_3.1-157     
# [43] xml2_1.3.3        tools_4.1.0       hms_1.1.1         lifecycle_1.0.4   munsell_0.5.0     reprex_2.0.1     
# [49] formattable_0.2.1 callr_3.7.0       compiler_4.1.0    chromote_0.1.1    rlang_1.1.3       grid_4.1.0       
# [55] rstudioapi_0.13   htmlwidgets_1.5.4 labeling_0.4.2    rmarkdown_2.13    gtable_0.3.0      DBI_1.1.2        
# [61] R6_2.5.1          lubridate_1.8.0   knitr_1.38        fastmap_1.1.0     utf8_1.2.2        rprojroot_2.0.2  
# [67] stringi_1.7.6     Rcpp_1.0.8.3      vctrs_0.6.5       dbplyr_2.1.1      tidyselect_1.1.2  xfun_0.30  
```

